<script>
// === Funciones equivalentes a Apps Script usando datos de Excel cargados ===

// Obtener todos los registros de Entregas
function obtenerTodosRegistrosEntregas() {
  return Array.isArray(window.planeacionProd) ? window.planeacionProd : [];
}

// Obtener todos los registros de DatosFormulario
function obtenerDatosFormularioParaDescarga() {
  return Array.isArray(window.datosBase) ? window.datosBase : [];
}

// Actualizar un registro por ID en DatosFormulario
function actualizarRegistroPorId(registro) {
  if (!Array.isArray(window.datosBase) || window.datosBase.length === 0) return 'No hay datos cargados';
  const headers = Object.keys(window.datosBase[0]);
  const idCol = headers.indexOf('id');
  if (idCol === -1) return 'No se encontr√≥ la columna id';
  let actualizado = false;
  for (let i = 0; i < window.datosBase.length; i++) {
    if (String(window.datosBase[i]['id']) === String(registro.id)) {
      for (const key of headers) {
        if (registro.hasOwnProperty(key)) {
          window.datosBase[i][key] = registro[key];
        }
      }
      actualizado = true;
      break;
    }
  }
  return actualizado ? 'Registro actualizado (solo en memoria, no en OneDrive)' : 'No se encontr√≥ el registro con ese ID';
}

// Obtener lista √∫nica de colaboradores
function obtenerColaboradores() {
  if (!Array.isArray(window.datosBase) || window.datosBase.length === 0) return [];
  const col = 'colaborador';
  const set = new Set();
  window.datosBase.forEach(row => { if (row[col]) set.add(row[col]); });
  return Array.from(set).map(nombre => ({ nombre }));
}

// Obtener lista √∫nica de coordinadores
function obtenerCoordinadores() {
  if (!Array.isArray(window.datosBase) || window.datosBase.length === 0) return [];
  const col = 'coordinador';
  const set = new Set();
  window.datosBase.forEach(row => { if (row[col]) set.add(row[col]); });
  return Array.from(set).map(nombre => ({ nombre }));
}

// Obtener lista √∫nica de clientes
function obtenerClientes() {
  if (!Array.isArray(window.datosBase) || window.datosBase.length === 0) return [];
  const col = 'cliente';
  const set = new Set();
  window.datosBase.forEach(row => { if (row[col]) set.add(row[col]); });
  return Array.from(set).map(nombre => ({ nombre }));
}

// Registrar descarga de dashboard (solo en memoria)
const descargasDashboard = [];
function registrarDescargaDashboard(usuario, fecha, tipo, trimestre, urlArchivo) {
  descargasDashboard.push({ usuario, fecha, tipo, trimestre, urlArchivo });
  return true;
}

// Guardar reporte dashboard (solo en memoria)
const reportesDashboard = [];
function guardarReporteDashboardEnDrive(params) {
  reportesDashboard.push(params);
  return { success: true, urlCarpeta: '', urlArchivo: '' };
}
</script>
<script>
// --- Funciones equivalentes a Apps Script usando datos de Excel cargados ---

// Obtener todos los registros de Entregas (simula obtenerTodosRegistrosEntregas)
function obtenerTodosRegistrosEntregas() {
  // window.datosBase debe estar cargado desde el Excel de OneDrive
  return Array.isArray(window.datosBase) ? window.datosBase : [];
}

// Obtener todos los registros de DatosFormulario (simula obtenerDatosFormularioParaDescarga)
function obtenerDatosFormularioParaDescarga() {
  // window.datosBase debe estar cargado desde el Excel de OneDrive
  return Array.isArray(window.datosBase) ? window.datosBase : [];
}

// Actualizar un registro por ID en DatosFormulario (simula actualizarRegistroPorId)
function actualizarRegistroPorId(registro) {
  if (!Array.isArray(window.datosBase) || window.datosBase.length === 0) return 'No hay datos cargados';
  const headers = Object.keys(window.datosBase[0]);
  const idCol = headers.indexOf('id');
  if (idCol === -1) return 'No se encontr√≥ la columna id';
  let actualizado = false;
  for (let i = 0; i < window.datosBase.length; i++) {
    if (String(window.datosBase[i]['id']) === String(registro.id)) {
      for (const key of headers) {
        if (registro.hasOwnProperty(key)) {
          window.datosBase[i][key] = registro[key];
        }
      }
      actualizado = true;
      break;
    }
  }
  return actualizado ? 'Registro actualizado (solo en memoria, no en OneDrive)' : 'No se encontr√≥ el registro con ese ID';
}
</script>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Librer√≠as para exportar Excel y PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  
</head>
<style>
/* === Variables base para modo claro === */
:root {
  --primary-color: #2563eb;
  --primary-color-dark: #1e40af;
  --secondary-color: #64748b;
  --success-color: #22c55e;
  --warning-color: #f59e42;
  --danger-color: #ef4444;
  --info-color: #0ea5e9;
  --background: #f4f4f4;
  --background-alt: #fff;
  --text-color: #111;
  --text-color-light: #666;
  --border-color: #e5e7eb;
  --border-radius: 10px;
  --shadow: 0 2px 16px rgba(0,0,0,0.07);
  --input-bg: #fafbfc;
  --input-border: #cbd5e1;
  --modal-bg: #fff;
  --modal-overlay: rgba(0,0,0,0.4);
}

body.dark-mode {
  --primary-color: #3b82f6;
  --primary-color-dark: #1e293b;
  --secondary-color: #94a3b8;
  --success-color: #22d3ee;
  --warning-color: #fbbf24;
  --danger-color: #f87171;
  --info-color: #38bdf8;
  --background: #181a20;
  --background-alt: #23272f;
  --text-color: #f3f4f6;
  --text-color-light: #cbd5e1;
  --border-color: #334155;
  --input-bg: #23272f;
  --input-border: #334155;
  --modal-bg: #23272f;
  --modal-overlay: rgba(20,24,31,0.85);
}

body {
  background: var(--background);
  color: var(--text-color);
  font-family: 'Segoe UI', Arial, sans-serif;
  margin: 0;
  padding: 0;
}

/* Sidebar/Menu */
.dark-mode h1,
.dark-mode h2,
.dark-mode h3,
.dark-mode h4,
.dark-mode h5,
.dark-mode h6 {
  color: var(--text-color) !important;
}
.sidebar {
  background: var(--background-alt);
  width: 350px;
  min-height: 95vh;
  border-radius: 16px;
  margin: 32px;
  box-shadow: var(--shadow);
  padding: 32px 24px 24px 24px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.sidebar .logo {
  font-family: 'Georgia', serif;
  font-size: 2rem;
  color: var(--primary-color-dark);
  margin-bottom: 32px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar .search-box {
  background: var(--input-bg);
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  display: flex;
  align-items: center;
}
.sidebar .search-box input {
  border: none;
  background: transparent;
  outline: none;
  font-size: 1rem;
  width: 100%;
  color: var(--text-color);
}
.sidebar nav {
  flex: 1;
}
.sidebar nav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.sidebar nav ul li {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  font-size: 1.1rem;
  color: var(--text-color-light);
  cursor: pointer;
  transition: background 0.2s;
}
.sidebar nav ul li:hover {
  background: #f0f4f8;
  border-radius: 6px;
}
.sidebar .settings,
.sidebar .logout {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #888;
  font-size: 1rem;
  margin: 16px 0 0 0;
  cursor: pointer;
  transition: color 0.2s;
}
.sidebar .settings:hover,
.sidebar .logout:hover {
  color: var(--primary-color-dark);
}
.sidebar .user-info {
  border-top: 1px solid var(--border-color);
  margin-top: 32px;
  padding-top: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.sidebar .user-info .avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--background);
  display: inline-block;
}
.sidebar .user-info .details {
  display: flex;
  flex-direction: column;
}
.sidebar .user-info .details .name {
  font-size: 1rem;
  color: var(--text-color);
}
.sidebar .user-info .details .email {
  font-size: 0.85rem;
  color: var(--text-color-light);
}

/* Contenedores y secciones */
.section-container {
  max-width: max-content;
  margin: 40px auto;
  background: var(--background-alt);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 32px 24px;
  display: none;
}
.active-section {
  display: block !important;
}
.main-container {
  margin-top: 24px;
}

/* Login y formularios */
.login-container {
  max-width: 400px;
  margin: 0 auto;
  background: var(--background-alt);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 32px 24px;
  background-image: url('https://drive.google.com/thumbnail?=sz=w1000%id=1RHxzusq0NOzcDiGbNC4fmf__gqwrD6R3');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  position: relative;
}
.login-logo {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 16px;
  text-align: center;
}
.login-title {
  font-size: 1.3rem;
  margin-bottom: 18px;
  color: var(--primary-color-dark);
  text-align: center;
}
.login-form .form-group {
  margin-bottom: 18px;
}
.form-group label {
  display: block;
  margin-bottom: 6px;
  color: var(--text-color-light);
  font-weight: 500;
}
.form-input {
  width: 75%;
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text-color);
  font-size: 1rem;
  outline: none;
  transition: border 0.2s;
}
.form-input:focus {
  border-color: var(--primary-color);
}
.login-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

/* Botones */
.button {
  padding: 8px 18px;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  background: var(--secondary-color);
  color: #fff;
  transition: background 0.2s, color 0.2s;
  outline: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  margin-bottom: 2px;
}
.button-primary { background: var(--primary-color); }
.button-primary:hover { background: var(--primary-color-dark); }
.button-success { background: var(--success-color); }
.button-success:hover { background: #16a34a; }
.button-warning { background: var(--warning-color); color: #fff; }
.button-warning:hover { background: #d97706; }
.button-danger { background: var(--danger-color); }
.button-danger:hover { background: #b91c1c; }
.button-info { background: var(--info-color); }
.button-info:hover { background: #0369a1; }
.button-secondary { background: var(--secondary-color); }
.button-secondary:hover { background: #334155; }

/* Tab buttons */
.dashboard-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 18px;
}
.tab-button {
  background: var(--background);
  color: var(--primary-color-dark);
  border: 1px solid var(--primary-color);
  border-radius: 6px 6px 0 0;
  padding: 8px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}
.tab-button.active, .tab-button:hover {
  background: var(--primary-color);
  color: #fff;
}

/* Form containers */
.form-container {
  background: var(--background-alt);
  border-radius: var(--border-radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  padding: 20px 18px;
  margin-bottom: 18px;
}
.grid-form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

/* Tablas din√°micas y visuales */
.dynamic-table-container {
  margin-bottom: 24px;
}
.dynamic-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--background-alt);
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.dynamic-table th, .dynamic-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
  text-align: left;
  font-size: 1rem;
  border-right: 1px solid var(--border-color);
}
.dynamic-table th:last-child, .dynamic-table td:last-child {
  border-right: none;
}

/* √ânfasis visual en columnas clave de Planeaci√≥n */
/* Columnas destacadas con transparencia y adaptadas a modo claro/oscuro */
#tablaPlaneacion th:nth-child(1),
#tablaPlaneacion td:nth-child(1) {
  background: rgba(224, 231, 255, 0.3); /* azul claro con transparencia */
  color: #1e40af;
  font-weight: bold;
}
#tablaPlaneacion th:nth-child(11),
#tablaPlaneacion td:nth-child(11) {
  background: rgba(254, 249, 195, 0.3); /* amarillo claro con transparencia */
  color: #b45309;
  font-weight: bold;
}
#tablaPlaneacion th:nth-child(16),
#tablaPlaneacion td:nth-child(16) {
  background: rgba(220, 252, 231, 0.3); /* verde claro con transparencia */
  color: #166534;
  font-weight: bold;
}
body.dark-mode #tablaPlaneacion th:nth-child(1),
body.dark-mode #tablaPlaneacion td:nth-child(1) {
  background: rgba(30, 64, 175, 0.35); /* azul oscuro con transparencia */
  color: #e0e7ff;
}
body.dark-mode #tablaPlaneacion th:nth-child(11),
body.dark-mode #tablaPlaneacion td:nth-child(11) {
  background: rgba(251, 191, 36, 0.25); /* amarillo oscuro con transparencia */
  color: #fef9c3;
}
body.dark-mode #tablaPlaneacion th:nth-child(16),
body.dark-mode #tablaPlaneacion td:nth-child(16) {
  background: rgba(16, 185, 129, 0.20); /* verde oscuro con transparencia */
  color: #dcfce7;
}
</style>

<!-- Microsoft Authentication Library (MSAL) -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// --- Modo oscuro autom√°tico ---
function setDarkModeClass() {
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }
}
setDarkModeClass();
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setDarkModeClass);

// --- Configuraci√≥n MSAL y Graph ---
const msalConfig = {
  auth: {
    clientId: 'TU_CLIENT_ID_AQUI', // <-- Reemplaza por tu Client ID de Azure App Registration
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin
  }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const graphScopes = ["Files.Read.All", "User.Read"];

let accessToken = null;

async function signIn() {
  try {
    const loginResponse = await msalInstance.loginPopup({ scopes: graphScopes });
    accessToken = (await msalInstance.acquireTokenSilent({ scopes: graphScopes, account: loginResponse.account })).accessToken;
    document.getElementById('ms-login-btn').style.display = 'none';
    document.getElementById('ms-logout-btn').style.display = 'inline-block';
    cargarDatosDesdeOneDrive();
  } catch (err) {
    alert('Error de autenticaci√≥n: ' + err.message);
  }
}

function signOut() {
  msalInstance.logoutPopup();
  accessToken = null;
  document.getElementById('ms-login-btn').style.display = 'inline-block';
  document.getElementById('ms-logout-btn').style.display = 'none';
}

// --- Funci√≥n para leer archivos Excel desde OneDrive ---
async function cargarDatosDesdeOneDrive() {
  // Nombres de los archivos en OneDrive
  // URLs directos de los archivos Excel en OneDrive
  const archivos = [
    { url: 'https://ohogorman-my.sharepoint.com/:x:/r/personal/afgonzalez_ogorman_com_mx/Documents/Escritorio/migracion/datos%20de%20la%20base%20de%20datos%20(1).xlsx?d=w92f44440216c4c77af81efc94dfea4e2&csf=1&web=1&e=25o7e3', variable: 'datosBase' },
    { url: 'https://ohogorman-my.sharepoint.com/:x:/r/personal/afgonzalez_ogorman_com_mx/Documents/Escritorio/migracion/planeacion_prod_area_tec%20(6).xlsx?d=w19b28ffd82f2472dbb3d7efdbe829ea3&csf=1&web=1&e=5R4fY0', variable: 'planeacionProd' }
  ];
  for (const archivo of archivos) {
    try {
      // Descargar el archivo Excel como blob desde el enlace compartido
      const fileResp = await fetch(archivo.url);
      if (!fileResp.ok) throw new Error('No se pudo descargar el archivo');
      const blob = await fileResp.blob();
      const arrayBuffer = await blob.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      // Tomar la primera hoja
      const sheetName = workbook.SheetNames[0];
      const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: '' });
      window[archivo.variable] = data;
    } catch (e) {
      alert('Error al cargar archivo: ' + e.message);
    }
  }
  mostrarDatosEnPagina();
}

function mostrarDatosEnPagina() {
  // Ejemplo: mostrar la cantidad de registros de cada archivo
  const base = window.datosBase ? window.datosBase.length : 0;
  const plan = window.planeacionProd ? window.planeacionProd.length : 0;
  document.getElementById('info-datos').innerText = `Registros base: ${base}, Planeaci√≥n: ${plan}`;
  // Aqu√≠ puedes adaptar para poblar tablas, gr√°ficos, etc.
}
</script>
<div style="margin: 1em 0;">
  <button id="ms-login-btn" onclick="signIn()">Iniciar sesi√≥n con Microsoft</button>
  <button id="ms-logout-btn" onclick="signOut()" style="display:none;">Cerrar sesi√≥n</button>
  <span id="info-datos" style="margin-left:1em;color:var(--primary-color-dark);"></span>
</div>
<style>
.dynamic-table th {
  background: var(--background);
  color: var(--primary-color-dark);
  font-weight: 600;
}
.dynamic-table tr:last-child td {
  border-bottom: none;
}
.table-wrapper {
  overflow-x: auto;
  border-radius: var(--border-radius);
}
/* Resumen y vista previa */
.preview-container {
  position: fixed;
  top: 60px;
  right: 40px;
  width: 350px;
  background: var(--background-alt);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 24px 18px 18px 18px;
  z-index: 10000;
  display: none;
}
.preview-container.active {
  display: block;
}
.close-preview {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--danger-color);
  cursor: pointer;
}
.resumen-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}
.resumen-item {
  flex: 1 1 120px;
  background: var(--background);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 6px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.resumen-item.full-width {
  flex-basis: 100%;
}
.resumen-label {
  font-size: 0.95em;
  color: var(--text-color-light);
}
.resumen-value {
  font-size: 1.2em;
  font-weight: bold;
  color: var(--primary-color-dark);
}
.resumen-clientes, .resumen-departamentos {
  font-size: 0.95em;
  color: var(--text-color-light);
}

/* Floating tab */
.floating-tab {
  position: fixed;
  bottom: 88px; /* Move up to avoid overlap with volver button */
  right: 40px;
  background: var(--primary-color);
  color: #fff;
  padding: 12px 22px;
  border-radius: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  z-index: 10001;
  transition: background 0.2s;
}
.floating-tab:hover {
  background: var(--primary-color-dark);
}

/* Modales */
.modal {
  display: none;
  position: fixed;
  z-index: 10010;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: auto;
  background: var(--modal-overlay);
  align-items: center;
  justify-content: center;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: var(--modal-bg);
  margin: auto;
  border-radius: var(--border-radius);
  padding: 32px 24px;
  box-shadow: var(--shadow);
  min-width: 320px;
  max-width: 95vw;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 18px;
}
.close-modal {
  color: var(--danger-color);
  font-size: 1.5rem;
  cursor: pointer;
}

/* Alertas */
.alerta {
  position: fixed;
  top: 24px;
  right: 32px;
  z-index: 20000;
  background: var(--danger-color);
  color: #fff;
  padding: 14px 22px;
  border-radius: 8px;
  font-size: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  opacity: 0.97;
  animation: fadeIn 0.3s;
}
.alerta-info { background: var(--info-color); }
.alerta-success { background: var(--success-color); }
.alerta-warning { background: var(--warning-color); }
.alerta-error { background: var(--danger-color); }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 0.97; transform: translateY(0); }
}

/* Loading overlay */
.loading {
  display: none;
  position: fixed;
  z-index: 20000;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: var(--modal-overlay);
  align-items: center;
  justify-content: center;
}
.loading-content {
  background: var(--modal-bg);
  border-radius: var(--border-radius);
  padding: 32px 24px;
  box-shadow: var(--shadow);
  text-align: center;
}
.loading-spinner {
  border: 4px solid #e5e7eb;
  border-top: 4px solid var(--primary-color);
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Scrollable table */
.scrollable-table {
  max-height: 650px;
  overflow-y: auto;
  border-radius: var(--border-radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  background: var(--background-alt);
}

/* Otros ajustes generales */
h1, h2, h3, h4, h5 {
  color: var(--primary-color-dark);
  margin-top: 0;
}
a {
  color: var(--primary-color);
  text-decoration: none;
  transition: color 0.2s;
}
a:hover {
  color: var(--primary-color-dark);
}

/* Ajustes para inputs y selects */
input, select, textarea {
  font-family: inherit;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid var(--input-border);
  background: var(--input-bg);
  color: var(--text-color);
  padding: 8px 10px;
  outline: none;
  transition: border 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--primary-color);
}

/* Ajustes para botones dentro de tablas y formularios */
table button, .form-actions button {
  margin-right: 6px;
  margin-bottom: 2px;
}

/* Ajustes para grid de b√∫squeda */
.busqueda-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.busqueda-acciones {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* Secci√≥n de entrega */
.seccion-entrega {
  background: var(--background-alt);
  border-radius: var(--border-radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  padding: 20px 18px;
}

/* Ajustes para tablas visuales */
#tabla-registros, #tabla-registros th, #tabla-registros td {
  border: 1px solid var(--border-color);
  border-collapse: collapse;
}
#tabla-registros th, #tabla-registros td {
  padding: 8px 10px;
}

/* Ajustes para indicadores */
#seccion-depto-indicator, #seccion-entrega-indicator {
  background: var(--primary-color);
  color: #fff;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.9em;
}

/* Ajustes para export-buttons, admin-buttons, debug-buttons */
.export-buttons, .admin-buttons, .debug-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

/* Ajustes para .table-controls */
.table-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

/* Ajustes para .form-actions */
.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* Ajustes para .semanas-checkboxes */
.semanas-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

/* Ajustes para .stat-card en dashboard-stats */
.dashboard-stats {
  display: flex;
  gap: 18px;
  margin-bottom: 24px;
}
.stat-card {
  flex: 1 1 120px;
  background: var(--primary-color);
  color: #fff;
  border-radius: 12px;
  padding: 18px 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.stat-number {
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 6px;
}
.stat-label {
  font-size: 1.1em;
  color: #e0e7ef;
}
.stat-detail {
  font-size: 0.9em;
  color: #cbd5e1;
}

/* Responsive */
@media (max-width: 900px) {
  .section-container {
    max-width: 98vw;
    padding: 18px 6vw;
  }
  .sidebar {
    width: 98vw;
    margin: 12px 0;
    min-height: unset;
    padding: 18px 6vw;
  }
  .preview-container, .floating-tab {
    right: 10px;
    width: 95vw;
    min-width: 220px;
    max-width: 98vw;
  }
}
      :root {
        --table-bg: #fff;
        --table-text: #222;
        --table-header-bg: #f0f0f0;
        --table-header-text: #111;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --table-bg: #181818;
          --table-text: #f5f5f5;
          --table-header-bg: #232323;
          --table-header-text: #fff;
        }
      }
      table, .data-table, .tabla-dinamica, .tabla-dashboard, .tabla-analisis {
        background: var(--table-bg) !important;
        color: var(--table-text) !important;
      }
      table th, .data-table th, .tabla-dinamica th, .tabla-dashboard th, .tabla-analisis th {
        background: var(--table-header-bg) !important;
        color: var(--table-header-text) !important;
      }
      table td, .data-table td, .tabla-dinamica td, .tabla-dashboard td, .tabla-analisis td {
        color: var(--table-text) !important;
      }
    </style>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: inherit;
      color: inherit;
    }
    .main-content, #main-content {
      max-width: 1800px;
      min-width: 320px;
      margin: 0 auto;
      padding: 32px 32px 24px 32px;
      box-sizing: border-box;
    }
    @media (min-width: 1600px) {
      .main-content, #main-content {
        max-width: 98vw;
        padding-left: 5vw;
        padding-right: 5vw;
      }
    }
    .responsive-table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
    }
    .responsive-table th, .responsive-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .button, button, input[type="submit"], input[type="button"] {
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      background: transparent;
      border: 2px solid var(--primary-color, #2563eb);
      color: var(--primary-color, #2563eb);
      transition: background 0.18s, color 0.18s, box-shadow 0.2s;
      box-shadow: none;
    }
    .button.button-danger, button.button-danger {
      border-color: var(--danger-color, #ef4444);
      color: var(--danger-color, #ef4444);
    }
    .button.button-success, button.button-success {
      border-color: var(--success-color, #22c55e);
      color: var(--success-color, #22c55e);
    }
    .button.button-info, button.button-info {
      border-color: var(--info-color, #0ea5e9);
      color: var(--info-color, #0ea5e9);
    }
    .button.button-warning, button.button-warning {
      border-color: var(--warning-color, #f59e42);
      color: var(--warning-color, #f59e42);
    }
    .button.button-secondary, button.button-secondary {
      border-color: var(--secondary-color, #64748b);
      color: var(--secondary-color, #64748b);
    }
    .button:active, button:active {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .button:hover, button:hover, input[type="submit"]:hover, input[type="button"]:hover {
      background: rgba(37,99,235,0.08); /* pastel azul por defecto */
      color: var(--primary-color, #1D3157);
    }
    .button.button-danger:hover, button.button-danger:hover {
      background: rgba(239,68,68,0.10); /* pastel rojo */
      color: var(--danger-color, #a63b3b);
    }
    .button.button-success:hover, button.button-success:hover {
      background: rgba(34,197,94,0.10); /* pastel verde */
      color: var(--success-color, #4c9f6b);
    }
    .button.button-info:hover, button.button-info:hover {
      background: rgba(14,165,233,0.10); /* pastel celeste */
      color: var(--info-color, #0ea5e9);
    }
    .button.button-warning:hover, button.button-warning:hover {
      background: rgba(245,158,66,0.10); /* pastel naranja */
      color: var(--warning-color, #f59e42);
    }
    .button.button-secondary:hover, button.button-secondary:hover {
      background: rgba(100,116,139,0.10); /* pastel gris */
      color: var(--secondary-color, #64748b);
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 4px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .form-row, .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
    }
    .form-col, .col {
      flex: 1 1 200px;
      min-width: 180px;
    }
    @media (max-width: 1200px) {
      .main-content, #main-content {
        padding: 12px;
      }
    }
    @media (max-width: 800px) {
      .main-content, #main-content {
        padding: 8px;
      }
      .form-row, .row {
        gap: 8px;
      }
    }
    @media (max-width: 600px) {
      .main-content, #main-content {
        padding: 2vw;
      }
      .form-row, .row {
        flex-direction: column;
        gap: 4px;
      }
      .form-col, .col {
        min-width: 0;
      }
      .responsive-table th, .responsive-table td {
        font-size: 0.98em;
        padding: 6px 2px;
      }
      .button, button, input[type="submit"], input[type="button"] {
        width: 100%;
        margin-bottom: 8px;
      }
    }
    /* Scroll horizontal para tablas en m√≥vil */
    .responsive-table {
      overflow-x: auto;
      display: block;
    }
    /* Mejorar visualizaci√≥n de modales y paneles */
    .modal, .panel, .ayuda-decimales, .debug-semanas {
      max-width: 98vw;
      overflow-x: auto;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <!-- Secci√≥n de Login (visible inicialmente) -->
  <div id="login-section" class="section-container active-section">
    <div class="login-container">
      <div class="login-logo">Sistema de Gesti√≥n</div>
      <h2 class="login-title">Iniciar Sesi√≥n</h2>
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="login-usuario">Usuario</label>
          <input type="text" id="login-usuario" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="login-password">Contrase√±a</label>
          <div style="position: relative;">
            <input type="password" id="login-password" class="form-input" required>
            <button type="button" onclick="togglePasswordVisibility('login-password')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-color);" title="Mostrar/Ocultar contrase√±a">Mostrar</button>
          </div>
        </div>
        <div class="login-actions">
          <button type="submit" class="button button-primary">Ingresar</button>
          <button type="button" class="button button-warning" onclick="mostrarRecuperarClave()">¬øOlvidaste tu contrase√±a?</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Secci√≥n de Recuperaci√≥n de Clave -->
  <div id="recuperar-section" class="section-container">
    <div class="login-container">
      <h2 class="login-title">Recuperar Contrase√±a</h2>
      <form id="recuperarForm" class="login-form">
        <div class="form-group">
          <label for="recuperar-email">Correo electr√≥nico</label>
          <input type="email" id="recuperar-email" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="recuperar-clave-maestra">Clave maestra (si eres administrador)</label>
          <input type="password" id="recuperar-clave-maestra" class="form-input">
        </div>
        <div class="login-actions">
          <button type="button" class="button button-primary" onclick="recuperarClave()">Enviar solicitud</button>
          <button type="button" class="button button-danger" onclick="mostrarLogin()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Secci√≥n Principal -->
  <div id="main-section" class="section-container">
    <!-- Panel de navegaci√≥n y usuario -->

    <div class="main-container">
      <div class="section-nav-panel" id="sectionNavPanel" style="display:flex;flex-direction:column;gap:14px;align-items:stretch;max-width:320px;position:fixed;top:32px;left:32px;z-index:2000;background:var(--modal-bg,#fff);border-radius:12px;padding:24px 18px 18px 18px;box-shadow:0 2px 16px 0 rgba(0,0,0,0.12);border:1.5px solid var(--border-color,#e5e7eb);transition:box-shadow 0.2s,opacity 0.2s;">
        <div id="user-info" style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:10px;font-size:1em;"></div>
        <button class="button button-primary" id="btnDashboard" onclick="accesoDashboardProtegido()" style="display: none;">Dashboard</button>
        <button class="button button-primary" id="btnPlaneacion" onclick="showSection('Planeacion')">Planeaci√≥n</button>
        <button class="button button-danger" id="btnModoMaestro" onclick="toggleModoMaestro()">Modo Edici√≥n Maestra</button>
        <button class="button button-primary" onclick="mostrarModalCambioClave()">Cambiar Clave</button>
        <button class="button button-danger" onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
      <button id="toggleNavPanel" class="button button-secondary" style="position:fixed;top:16px;left:16px;z-index:2100;padding:10px 16px;border-radius:50px;box-shadow:0 2px 8px 0 rgba(0,0,0,0.10);background:var(--primary-color,#2563eb);color:#fff;font-size:1.1em;" onclick="toggleNavPanel()">‚ò∞</button>
<script>
// Men√∫ flotante: mostrar/ocultar panel de navegaci√≥n vertical
function toggleNavPanel() {
  const panel = document.getElementById('sectionNavPanel');
  const btn = document.getElementById('toggleNavPanel');
  if (!panel || !btn) return;
  if (panel.style.opacity === '0' || panel.style.display === 'none') {
    panel.style.opacity = '1';
    panel.style.pointerEvents = 'auto';
    panel.style.display = 'flex';
    btn.textContent = '‚úñ';
    btn.title = 'Ocultar men√∫';
  } else {
    panel.style.opacity = '0';
    panel.style.pointerEvents = 'none';
    setTimeout(()=>{panel.style.display = 'none';},200);
    btn.textContent = '‚ò∞';
    btn.title = 'Mostrar men√∫';
  }
}
// Inicializar oculto en m√≥vil o si se desea
window.addEventListener('DOMContentLoaded',()=>{
  const panel = document.getElementById('sectionNavPanel');
  if(panel){panel.style.opacity='1';panel.style.pointerEvents='auto';}
  // Asegurar que los selects se llenen al cargar la p√°gina
  cargarDatosIniciales();
});
</script>
    
    <script>
    function solicitarCredencialesDashboard(callback) {
      // Crear modal simple para usuario y contrase√±a
      const modal = document.createElement('div');
      modal.id = 'modal-dashboard-login';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.4)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '9999';
      modal.innerHTML = `
        <div style="background:#fff;padding:30px 25px 20px 25px;border-radius:10px;max-width:350px;width:100%;box-shadow:0 2px 16px #0002;">
          <h3 style="margin-top:0;margin-bottom:18px;font-size:1.2em;">Acceso administrativo requerido</h3>
          <div style="margin-bottom:12px;">
            <input id="dashboard-user" type="text" placeholder="Usuario" style="width:100%;padding:8px;margin-bottom:8px;" autocomplete="username">
            <input id="dashboard-pass" type="password" placeholder="Contrase√±a" style="width:100%;padding:8px;" autocomplete="current-password">
          </div>
          <div style="text-align:right;">
            <button id="btnDashboardLoginCancel" style="margin-right:10px;">Cancelar</button>
            <button id="btnDashboardLoginOk" class="button button-success">Acceder</button>
          </div>
          <div id="dashboard-login-error" style="color:#e74c3c;font-size:0.95em;margin-top:10px;display:none;"></div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('dashboard-user').focus();
      document.getElementById('btnDashboardLoginCancel').onclick = function() {
        document.body.removeChild(modal);
        if (typeof callback === 'function') callback(false);
      };
      document.getElementById('btnDashboardLoginOk').onclick = function() {
        const user = document.getElementById('dashboard-user').value.trim();
        const pass = document.getElementById('dashboard-pass').value;
        // Aqu√≠ puedes poner la validaci√≥n real de usuario/contrase√±a
        // Por ejemplo, comparar con variables globales o una lista
        // Para ejemplo, solo permitimos si es admin o coordinador
        if ((user === usuarioActual && (esAdmin || esCoordinador)) || (user === 'admin' && pass === 'admin123')) {
          document.body.removeChild(modal);
          if (typeof callback === 'function') callback(true);
        } else {
          const err = document.getElementById('dashboard-login-error');
          err.textContent = 'Usuario o contrase√±a incorrectos, o no tienes permisos.';
          err.style.display = 'block';
        }
      };
      // Permitir enter para enviar
      modal.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') document.getElementById('btnDashboardLoginOk').click();
        });
      });
    }

    function accesoDashboardProtegido() {
      // Si ya es admin o coordinador, permitir
      if (esAdmin || esCoordinador) {
        showSection('Dashboard');
        return;
      }
      // Si no, pedir credenciales
      solicitarCredencialesDashboard(function(acceso) {
        if (acceso) {
          showSection('Dashboard');
        } else {
          mostrarAlerta('Lamentamos no poder mostrar esta secci√≥n para ti, es solo para administrativos', 'error');
        }
      });
    }
    </script>
        <button class="button button-primary" id="btnPlaneacion" onclick="showSection('Planeacion'); cargarDatosIniciales();" style="display: none;">Planeaci√≥n y Entrega</button>
      </div>
      <div>
        <!-- Secci√≥n Dashboard (Solo para Administradores y Coordinadores) -->
        <div id="Dashboard-section" class="section-container" style="display: none;">
          <div style="display:flex;align-items:center;gap:18px;margin-bottom:10px;flex-wrap:wrap;">
            <h1 style="margin:0;">Dashboard de Administraci√≥n</h1>
            <button type="button" class="button button-success" onclick="cargarDashboardAutomatico()">üîÑ Recargar Dashboard</button>
          </div>
          
          <!-- Indicador de Permisos por Departamento (Oculto por defecto) -->
          <div class="form-container" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h3>Informaci√≥n de Acceso</h3>
              <button type="button" class="button" onclick="toggleInfoAcceso()" id="btnToggleInfoAcceso" style="background: #6c757d; color: white;">Mostrar Informaci√≥n</button>
            </div>
            <div id="permisos-info" style="
              display: none;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 15px;
              padding: 15px;
              background: rgba(255, 255, 255, 0.05);
              border-radius: var(--border-radius);
            ">
              <!-- Se llenar√° din√°micamente -->
            </div>
          </div>
          
          <!-- Estad√≠sticas Generales Mejoradas -->
          <div class="dashboard-stats">
            <div class="stat-card">
              <div class="stat-number" id="stat-total-registros" style="color: white;">0</div>
              <div class="stat-label">Registros Totales</div>
              <div class="stat-detail" id="stat-total-detalle" style="font-size: 0.8em; color: #bbb;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-pendientes" style="color: #f39c12;">0</div>
              <div class="stat-label">Pendientes</div>
              <div class="stat-detail" id="stat-pendientes-detalle" style="font-size: 0.8em; color: #bbb;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-entregados" style="color: #27ae60;">0</div>
              <div class="stat-label">Entregados</div>
              <div class="stat-detail" id="stat-entregados-detalle" style="font-size: 0.8em; color: #bbb;">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-costo-total" style="color: #3498db;">$0</div>
              <div class="stat-label">Costo Total</div>
              <div class="stat-detail" id="stat-costo-detalle" style="font-size: 0.8em; color: #bbb;">-</div>
            </div>
          </div>
          
          <!-- Informaci√≥n de Configuraci√≥n de Semanas -->
          <div class="form-container" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Configuraci√≥n de An√°lisis</h3>
              <button type="button" class="button" onclick="toggleConfiguracion()" id="btnToggleConfig" style="background: #6c757d; color: white;">Mostrar Configuraci√≥n</button>
            </div>
            <div id="configuracion-info" style="
              display: none;
              padding: 15px;
              background: rgba(255, 255, 255, 0.05);
              border-radius: var(--border-radius);
              border: 1px solid rgba(255, 255, 255, 0.1);
            ">
              <div class="grid-form">
                <div class="form-group">
                  <label><strong>L√≥gica de Semanas:</strong></label>
                  <ul style="margin: 5px 0; padding-left: 20px; color: var(--text-color);">
                    <li><strong>Registros Entregados:</strong> Se usa la semana de la fecha de entrega real (Columna T)</li>
                    <li><strong>Registros Pendientes:</strong> Se usa la semana planeada (Columna Q)</li>
                    <li><strong>Fallback:</strong> Si no hay datos v√°lidos, se usa la fecha de registro</li>
                  </ul>
                </div>
                <div class="form-group">
                  <label><strong>Fuente de Datos:</strong></label>
                  <div style="color: var(--text-color); font-size: 0.9em;">
                    <p>Hoja: <strong>DatosFormulario</strong></p>
                    <p>Columna Q: <strong>Semana Planeada/Datos Entregados</strong> (n√∫mero 1-53)</p>
                    <p>Columna T: <strong>Fecha de Entrega Real</strong> (formato d/m/a)</p>
                    <div style="margin-top: 8px; padding: 8px; background: rgba(39, 174, 96, 0.1); border-radius: 4px; border-left: 3px solid #27ae60;">
                      <p style="margin: 2px 0; font-size: 0.85em;"><strong>‚úÖ L√≥gica mejorada:</strong></p>
                      <p style="margin: 2px 0; font-size: 0.85em;">‚Ä¢ Entregados: usa T (fecha real) si existe</p>
                      <p style="margin: 2px 0; font-size: 0.85em;">‚Ä¢ Pendientes: usa Q (semana planeada)</p>
                      <p style="margin: 2px 0; font-size: 0.85em;">‚Ä¢ Si T > Q: se detecta entrega tard√≠a</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Busqueda y Filtros del Dashboard -->
          <div class="form-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">B√∫squeda y Filtros</h3>
              <button type="button" class="button" onclick="toggleFiltros()" id="btnToggleFiltros" style="background: #6c757d; color: white;">Ocultar Filtros</button>
            </div>
            <div id="filtros-container"  class="grid-form">
              <div class="form-group">
                <label for="semana">Semana:</label>
                <input type="week" class="form-input" id="semana">
              </div>
              <div class="form-group">
                <label for="colaborador-busqueda">Colaborador:</label>
                <select class="form-input" id="colaborador-busqueda">
                  <option value="">Todos...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="coordinador-busqueda">Coordinador:</label>
                <select class="form-input" id="coordinador-busqueda">
                  <option value="">Todos...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="cliente-busqueda">Cliente:</label>
                <select class="form-input" id="cliente-busqueda">
                  <option value="">Todos...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="estatus-busqueda">Estatus:</label>
                <select class="form-input" id="estatus-busqueda">
                  <option value="Entregado">Entregado</option>
                  <option value="">Todos...</option>
                  <option value="Pendiente">Pendiente</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>
              <!-- Hoja fija como DatosFormulario - no se muestra al usuario -->
              <input type="hidden" id="hoja-busqueda" value="DatosFormulario">
            </div>
            <div class="grid-form">
              <!-- Botones principales -->
              <button type="button" class="button button-primary" onclick="buscarReg()">üîç Buscar</button>
              <button type="button" class="button button-warning" onclick="limpiarBusqueda()">üßπ Limpiar</button>

              
              <!-- Grupo de exportaci√≥n -->
              <div class="export-buttons" style="display: flex; gap: 8px; grid-column: span 2;">
                <button type="button" class="button button-info" onclick="descargarTablaTemporalExcel()">üìä Descargar Excel</button>
                <button type="button" class="button button-info" onclick="descargarTablaTemporalPDF()">üìÑ Descargar PDF</button>
    <script>
    // Descargar la tabla temporal de resultados de b√∫squeda (id='tablaDatos') en Excel
    function descargarTablaTemporalExcel() {
      const fechaStr = new Date().toISOString().slice(0,10);
      const tableElem = document.querySelector('table.data-table');
      if (!tableElem) {
        alert('No se encontr√≥ la tabla de resultados.');
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tableElem, {raw:true});
      XLSX.utils.book_append_sheet(wb, ws, 'BusquedaFiltrada');
      XLSX.writeFile(wb, `BusquedaFiltrada_${fechaStr}.xlsx`);
    }

    // Descargar la tabla temporal de resultados de b√∫squeda en PDF
    function descargarTablaTemporalPDF() {
      const fechaStr = new Date().toISOString().slice(0,10);
      const tableElem = document.querySelector('table.data-table');
      if (!tableElem) {
        alert('No se encontr√≥ la tabla de resultados.');
        return;
      }
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'pt', 'a4');
      let y = 40;
      pdf.setFontSize(16);
      pdf.text('Resultados de B√∫squeda - ' + fechaStr, 40, y);
      y += 20;
      pdf.setFontSize(10);
      const rows = Array.from(tableElem.rows).map(row => Array.from(row.cells).map(cell => cell.innerText));
      let colWidths = [];
      if (rows[0]) colWidths = rows[0].map(() => 100);
      rows.forEach((row, i) => {
        let x = 40;
        row.forEach((cell, j) => {
          pdf.text(String(cell), x, y);
          x += colWidths[j] || 100;
        });
        y += 16;
        if (y > 520 && i < rows.length-1) { pdf.addPage(); y = 40; }
      });
      pdf.save(`BusquedaFiltrada_${fechaStr}.pdf`);
    }
    </script>
              </div>
              
              <!-- Botones de diagn√≥stico y administraci√≥n (solo para admin) -->
              <div class="admin-buttons" style="display: flex; gap: 8px; grid-column: span 2;">
                <button type="button" class="button button-danger" onclick="borrarTabla()" title="Limpiar tabla de resultados">ÔøΩÔ∏è Limpiar Tabla</button>
                <button type="button" class="button button-secondary" onclick="cancelarOperacion()" title="Cancelar operaci√≥n en curso">‚ö° Cancelar</button>
              </div>
              
              <!-- Botones de debug (ocultos por defecto, solo para AFGT) -->
              <div class="debug-buttons" style="display: none; gap: 8px; grid-column: span 3;">
                <button type="button" class="button button-warning" id="btnValidarColumnas" onclick="validarProcesamientoColumnas(); mostrarAlerta('Validaci√≥n completada. Revise la consola para detalles.', 'info');">üîç Validar Q/T</button>
                <button type="button" class="button button-warning" id="btnProbarDescarga" onclick="probarFuncionesDescarga()">üß™ Probar Descarga</button>
                <button type="button" class="button" onclick="testExportBackend()" style="background: #6c757d; color: white;" id="btnTestBackend" title="Probar conexi√≥n con backend de exportaci√≥n">üîß Test Backend</button>
                <button type="button" class="button button-info" onclick="diagnosticoCompleto()" title="Ejecutar diagn√≥stico completo del sistema">üîç Diagn√≥stico</button>
                <button type="button" class="button button-secondary" onclick="repararSistema()" title="Reparar problemas comunes del sistema">üîß Reparar</button>
              </div>
            </div>
          </div>

          <!-- Modal para opciones de exportaci√≥n -->
          <div id="exportModal" class="modal" style="display:none;">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Opciones de Exportaci√≥n</h2>
                <span class="close-modal" onclick="cerrarModal()" style="cursor:pointer;font-size:28px;">&times;</span>
              </div>
              <div class="export-options">
                <div class="export-option-group">
                  <div class="export-option-title">Exportar a Excel</div>
                  <div class="export-option-buttons">
                    <button class="button button-success" onclick="exportarExcel('tabla')">Tabla de datos</button>
                    <button class="button button-success" onclick="exportarExcel('graficos')">Datos de gr√°ficos</button>
                    <button class="button button-success" onclick="exportarExcel('completo')">Reporte completo</button>
                  </div>
                </div>
                <div class="export-option-group">
                  <div class="export-option-title">Exportar a PDF</div>
                  <div class="export-option-buttons">
                    <button class="button button-primary" onclick="exportarPDF('tabla')">Tabla de datos</button>
                    <button class="button button-primary" onclick="exportarPDF('graficos')">Gr√°ficos</button>
                    <button class="button button-primary" onclick="exportarPDF('dashboard')">Dashboard completo</button>
                    <button class="button button-primary" onclick="exportarPDF('colaborador')">Resumen por colaborador</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Tablas Din√°micas -->
          <div class="form-container">
            <h3>üìä An√°lisis y Reportes</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
              <button class="button button-success" onclick="descargarAnalisisReportesExcel()">üì• Descargar Excel (todas las tablas)</button>
              <button class="button button-primary" onclick="descargarAnalisisReportesPDF()">üìÑ Descargar PDF (todas las tablas)</button>
              <button class="button button-info" onclick="descargarDatosFormularioExcel()">üìã Descargar hoja DatosFormulario (Excel)</button>
            </div>
    <script>
    // ...existing code...

    // Descargar hoja completa DatosFormulario como Excel
    function descargarDatosFormularioExcel() {
      mostrarLoading && mostrarLoading(true);
      // Llamar a ambas funciones backend en paralelo
      let datosFormulario = null;
      let datosEntregas = null;
      let errores = [];

      // Helper para continuar cuando ambas respuestas est√©n listas
      function intentarExportar() {
        console.log('Datos para exportar:', { datosFormulario, datosEntregas, errores });
        if (Array.isArray(datosFormulario) && datosFormulario.length > 0 && Array.isArray(datosEntregas) && datosEntregas.length > 0) {
          // Crear libro Excel con ambas hojas
          const wb = XLSX.utils.book_new();
          const ws1 = XLSX.utils.aoa_to_sheet(datosFormulario);
          XLSX.utils.book_append_sheet(wb, ws1, 'DatosFormulario');
          const ws2 = XLSX.utils.aoa_to_sheet(datosEntregas);
          XLSX.utils.book_append_sheet(wb, ws2, 'Entregas');
          const fechaStr = new Date().toISOString().slice(0,10);
          XLSX.writeFile(wb, `DatosFormulario_Entregas_${fechaStr}.xlsx`);
          mostrarLoading && mostrarLoading(false);
        } else if (errores.length > 0) {
          alert('Error al descargar: ' + errores.join(' | '));
          mostrarLoading && mostrarLoading(false);
        } else {
          let msg = 'No se encontraron datos para exportar.';
          if (!Array.isArray(datosFormulario) || datosFormulario.length === 0) msg += '\n- DatosFormulario vac√≠o';
          if (!Array.isArray(datosEntregas) || datosEntregas.length === 0) msg += '\n- Entregas vac√≠o';
          alert(msg);
          mostrarLoading && mostrarLoading(false);
        }
      }

      // Obtener DatosFormulario
      google.script.run
        .withSuccessHandler(function(datos) {
          if (!Array.isArray(datos) || datos.length === 0) {
            errores.push('No se encontraron datos en DatosFormulario');
          } else {
            datosFormulario = datos;
          }
          intentarExportar();
        })
        .withFailureHandler(function(err) {
          errores.push('Error DatosFormulario: ' + err.message);
          intentarExportar();
        })
        .obtenerDatosFormularioParaDescarga();

      // Obtener Entregas
      google.script.run
        .withSuccessHandler(function(datos) {
          if (!Array.isArray(datos) || datos.length === 0) {
            errores.push('No se encontraron datos en Entregas');
          } else {
            datosEntregas = datos;
          }
          intentarExportar();
        })
        .withFailureHandler(function(err) {
          errores.push('Error Entregas: ' + err.message);
          intentarExportar();
        })
        .obtenerTodosRegistrosEntregas();
    }
    </script>
    <script>
    // --- Descarga de todas las tablas din√°micas de An√°lisis y Reportes ---
    function descargarAnalisisReportesExcel() {
      const fecha = new Date();
      const fechaStr = fecha.toISOString().slice(0,10);
      const tablas = [
        { id: 'tabla-departamento-cliente', nombre: 'Asunto por semana' },
        { id: 'tabla-tipo-solicitud', nombre: 'Por Departamento (Semanal)' },
        { id: 'tabla-pendientes-asunto', nombre: 'Pendientes por Asunto' },
        { id: 'tabla-rendimiento-colaborador', nombre: 'Rendimiento por Colaborador' },
        { id: 'tabla-estado-proyectos', nombre: 'Estado de Proyectos por Cliente' }
      ];
      const wb = XLSX.utils.book_new();
      tablas.forEach(tabla => {
        const tableElem = document.querySelector(`#${tabla.id} table`);
        if (tableElem) {
          const ws = XLSX.utils.table_to_sheet(tableElem, {raw:true});
          XLSX.utils.book_append_sheet(wb, ws, tabla.nombre.substring(0,30));
        }
      });
      const nombreArchivo = `Analisis_Reportes_${fechaStr}.xlsx`;
      XLSX.writeFile(wb, nombreArchivo);
    }

    function descargarAnalisisReportesPDF() {
      const fecha = new Date();
      const fechaStr = fecha.toISOString().slice(0,10);
      const tablas = [
        { id: 'tabla-departamento-cliente', nombre: 'Asunto por semana' },
        { id: 'tabla-tipo-solicitud', nombre: 'Por Departamento (Semanal)' },
        { id: 'tabla-pendientes-asunto', nombre: 'Pendientes por Asunto' },
        { id: 'tabla-rendimiento-colaborador', nombre: 'Rendimiento por Colaborador' },
        { id: 'tabla-estado-proyectos', nombre: 'Estado de Proyectos por Cliente' }
      ];
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'pt', 'a4');
      let y = 40;
      tablas.forEach((tabla, idx) => {
        const tableElem = document.querySelector(`#${tabla.id} table`);
        if (tableElem) {
          pdf.setFontSize(16);
          pdf.text(tabla.nombre + ' - ' + fechaStr, 40, y);
          y += 20;
          pdf.setFontSize(10);
          const rows = Array.from(tableElem.rows).map(row => Array.from(row.cells).map(cell => cell.innerText));
          // Ajustar ancho de columnas
          let colWidths = [];
          if (rows[0]) colWidths = rows[0].map(() => 100);
          // Dibujar tabla
          let startY = y;
          rows.forEach((row, i) => {
            let x = 40;
            row.forEach((cell, j) => {
              pdf.text(String(cell), x, y);
              x += colWidths[j] || 100;
            });
            y += 16;
            if (y > 520 && i < rows.length-1) { pdf.addPage(); y = 40; }
          });
          y += 30;
          if (y > 520 && idx < tablas.length-1) { pdf.addPage(); y = 40; }
        }
      });
      pdf.save(`Analisis_Reportes_${fechaStr}.pdf`);
    }
    </script>
            
            <div class="dashboard-tabs" id="analisisBtns">
              <button class="tab-button active" onclick="mostrarTablaAnalisis('departamento-cliente', 0)">Asunto por semana</button>
              <button class="tab-button" onclick="mostrarTablaAnalisis('tipo-solicitud', 1)">Por Departamento (Semanal)</button>
              <button class="tab-button" onclick="mostrarTablaAnalisis('pendientes-asunto', 2)">Pendientes por Asunto</button>
              <button class="tab-button" onclick="mostrarTablaAnalisis('rendimiento-colaborador', 3)">Rendimiento por Colaborador</button>
              <button class="tab-button" onclick="mostrarTablaAnalisis('estado-proyectos', 4)">Estado por Cliente</button>
            </div>

            <!-- Tabla 1: Por Departamento y Asuntos -->
            <div id="tabla-departamento-cliente" class="dynamic-table-container active">
              <!-- Bot√≥n flotante, ahora se gestiona globalmente -->
              <h4>üìã An√°lisis por Asunto (Costos por Semana)</h4>
              
              <!-- Controles para seleccionar semanas -->
              <div class="form-container" style="margin-bottom: 20px;">
                <div class="grid-form">
                  <div class="form-group">
                    <label>üìÖ Selector de Semanas para An√°lisis:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                      <button class="button button-sm button-primary" onclick="seleccionarSemanaActualYAnterior()">üìÖ Actual + Anterior</button>
                      <button class="button button-sm button-warning" onclick="seleccionarUltimas4Semanas()">üìä √öltimas 4</button>
                    </div>
                    <div id="semanas-selector" class="semanas-checkboxes" style="max-height: 180px; overflow: auto; padding: 10px; background: rgba(59,130,246,0.07); border-radius: 10px; border: 1px solid #cbd5e1;;width: 1000px;">
                      <div style="text-align: center; padding: 10px; color: #999;">
                        <p style="margin-bottom: 10px; font-size: 14px;">üîÑ Cargando selector de semanas...</p>
                        <div style="display: flex; flex-direction: row; gap: 12px; flex-wrap: nowrap; overflow-x: auto; overflow-y: auto; padding-bottom: 8px;">
                          <button class="button button-sm button-info" onclick="cargarDashboardAutomatico()" title="Recargar datos completos">üîÑ Recargar</button>
                          <button class="button button-sm button-warning" onclick="forzarRegeneracionSelector()" title="Generar selector b√°sico">‚ö° Forzar</button>
                          <button class="button button-sm button-danger" onclick="debugBotonesDuplicados()" title="Debug botones duplicados">üîç Debug</button>
                        </div>
                      </div>
                    </div>
    

    
                  </div>
                  <div class="form-group">
                    <label>‚ö° Acciones:</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                      <button class="button button-primary" onclick="actualizarTablaDepartamentoAsuntos()">üîÑ Actualizar Tabla</button>
                     
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="table-wrapper">
                <table class="dynamic-table">
                  <thead>
                    <tr id="header-departamento-asuntos">
                      <th>Asunto</th>
                      <!-- Las columnas de semanas se generar√°n din√°micamente -->
                      <th>Total General</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-departamento-cliente">
                    <!-- Datos din√°micos -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tabla 2: Por Departamento con costos por semana -->
            <div id="tabla-tipo-solicitud" class="dynamic-table-container">
              <!-- Bot√≥n flotante, ahora se gestiona globalmente -->
              <h4>üè¢ An√°lisis por Departamento (Costos por Semana)</h4>
              <div class="table-wrapper">
                <table class="dynamic-table">
                  <thead>
                    <tr>
                      <th>Departamento</th>
                      <th>Semana Anterior ($)</th>
                      <th>Semana Actual ($)</th>
                      <th>Total ($)</th>
                      <th>Tendencia</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-tipo-solicitud">
                    <!-- Datos din√°micos -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tabla 3: Pendientes por Asunto -->
            <div id="tabla-pendientes-asunto" class="dynamic-table-container">
              <!-- Bot√≥n flotante, ahora se gestiona globalmente -->
              <h4>‚è≥ Pendientes por Asunto (Semana Actual y Anterior)</h4>
              <div class="table-wrapper">
                <table class="dynamic-table">
                  <thead>
                    <tr>
                      <th>Cliente</th>
                      <th>Asunto</th>
                      <th>Semana Anterior ($)</th>
                      <th>Semana Actual ($)</th>
                      <th>Total Pendientes ($)</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-pendientes-asunto">
                    <!-- Datos din√°micos -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tabla 4: Rendimiento por Colaborador -->
            <div id="tabla-rendimiento-colaborador" class="dynamic-table-container">
              <!-- Bot√≥n flotante, ahora se gestiona globalmente -->
              <h4>üë• Rendimiento por Colaborador</h4>
              <div class="table-wrapper">
                <table class="dynamic-table">
                  <thead>
                    <tr>
                      <th>Colaborador</th>
                      <th>Departamento</th>
                      <th>Cantidad Productos</th>
                      <th>Costo Total ($)</th>
                      <th>Promedio por Producto ($)</th>
                      <th>Eficiencia</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-rendimiento-colaborador">
                    <!-- Datos din√°micos -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Tabla 5: Estado de Proyectos por Cliente -->
            <div id="tabla-estado-proyectos" class="dynamic-table-container">
              <!-- Bot√≥n flotante, ahora se gestiona globalmente -->
<style>
.btn-volver-analisis-float {
  position: fixed;
  right: 32px;
  bottom: 24px; /* Lower than floating-tab */
  z-index: 10002; /* Above floating-tab */
  background: var(--secondary-color);
  color: #fff;
  border: none;
  border-radius: 50px;
  padding: 14px 28px;
  font-size: 1.1rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.13);
  cursor: pointer;
  transition: background 0.2s, transform 0.2s;
  display: none;
}
.btn-volver-analisis-float:hover {
  background: var(--primary-color);
  transform: scale(1.07);
}
</style>
<button id="btnVolverAnalisisFloat" class="btn-volver-analisis-float" onclick="volverAnalisisBtns()">‚¨ÜÔ∏è Volver a An√°lisis</button>
<script>
// Tabs exclusivas para an√°lisis y reportes
function mostrarTablaAnalisis(id, idx) {
  // Oculta todas las tablas
  document.querySelectorAll('.dynamic-table-container').forEach(el => el.classList.remove('active'));
  // Quita el estado activo de los botones
  document.querySelectorAll('#analisisBtns .tab-button').forEach(btn => btn.classList.remove('active'));
  // Muestra la tabla seleccionada
  document.getElementById('tabla-' + id).classList.add('active');
  // Marca el bot√≥n como activo
  document.querySelectorAll('#analisisBtns .tab-button')[idx].classList.add('active');
  // Hace scroll suave a la tabla
  setTimeout(()=>{
    document.getElementById('tabla-' + id).scrollIntoView({behavior:'smooth',block:'start'});
  },100);
  // Muestra el bot√≥n flotante
  document.getElementById('btnVolverAnalisisFloat').style.display = 'block';
}
function volverAnalisisBtns() {
  // Oculta todas las tablas
  document.querySelectorAll('.dynamic-table-container').forEach(el => el.classList.remove('active'));
  // Quita el estado activo de los botones
  document.querySelectorAll('#analisisBtns .tab-button').forEach(btn => btn.classList.remove('active'));
  // Oculta el bot√≥n flotante
  document.getElementById('btnVolverAnalisisFloat').style.display = 'none';
  // Muestra solo la zona de botones
  setTimeout(()=>{
    document.getElementById('analisisBtns').scrollIntoView({behavior:'smooth',block:'start'});
  },100);
}
// Si el usuario hace scroll y hay una tabla activa, el bot√≥n sigue visible
window.addEventListener('scroll', function() {
  const algunaActiva = Array.from(document.querySelectorAll('.dynamic-table-container')).some(el => el.classList.contains('active'));
  document.getElementById('btnVolverAnalisisFloat').style.display = algunaActiva ? 'block' : 'none';
});
</script>
              <h4>ÔøΩ Estado de Proyectos por Cliente</h4>
              <div class="table-wrapper">
                <table class="dynamic-table">
                  <thead>
                    <tr>
                      <th>Cliente</th>
                      <th>Estatus</th>
                      <th>Cantidad</th>
                      <th>Costo Total ($)</th>
                      <th>Porcentaje (%)</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-estado-proyectos">
                    <!-- Datos din√°micos -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Tabla de Registros (Solo Visual - Sin Botones de Acci√≥n) -->
          <div class="form-container">
            <div class="table-controls">
              <h3>üìã Registros Encontrados (Solo Visualizaci√≥n)</h3>
            </div>
            <div class="table-wrapper">
              <table id="tabla-registros">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Colaborador</th>
                    <th>Departamento</th>
                    <th>Cliente</th>
                    <th>Asunto</th>
                    <th>L√≠der</th>
                    <th>Categor√≠a</th>
                    <th>Descripci√≥n</th>
                    <th>Observaciones</th>
                    <th>Cantidad</th>
                    <th>Tipo</th>
                    <th>Nivel</th>
                    <th>Costo Base</th>
                    <th>Costo/Nivel</th>
                    <th>Costo Total</th>
                    <th>Estatus</th>
                    <th>Semana</th>
                  </tr>
                </thead>
                <tbody id="tablaDatosDashboard">
                  <!-- Los datos se cargar√°n din√°micamente sin botones de acci√≥n -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Secci√≥n Planeaci√≥n -->
        <div id="Planeacion-section" class="section-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üìÖ Planeaci√≥n y Entrega</h1>
            <div id="seccion-depto-indicator" style="
              background: var(--primary-color);
              color: white;
              padding: 8px 16px;
              border-radius: 20px;
              font-weight: bold;
              font-size: 0.9em;
            ">
              üè¢ <span id="seccion-depto-nombre">N/A</span>
            </div>
          </div>
          <div class="form-container">
            <form id="mainForm" style="background:rgba(255,255,255,0.04);border-radius:18px;padding:32px 24px 24px 24px;box-shadow:0 2px 16px 0 rgba(0,0,0,0.06);margin-bottom:32px;">
              <div class="grid-form" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px 32px;align-items:end;">
                <div class="form-group">
                  <label for="fecha">üìÖ Fecha:</label>
                  <input type="date" class="form-input" id="fecha" style="min-width:0;" onchange="mostrarSemanaSeleccionada()">
                  <div id="semana-seleccionada" style="margin-top:6px;font-size:13px;color:var(--primary-color);display:none;"></div>
                </div>
                <input type="hidden" name="id" id="registro-id" value="">
                <div class="form-group">
                  <label for="colaborador">üë§üë• Colaborador:</label>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <select class="form-input" id="colaborador" required style="flex:1;min-width:0;">
                      <option value="">Seleccionar...</option>
                    </select>
                    <span style="font-size:12px;">Otro usuario</span>
                    <label class="switch" title="Activar para seleccionar otro colaborador" style="margin-bottom:0;">
                      <input type="checkbox" id="switch-colaborador" onchange="toggleColaboradorSelect()">
                      <span class="slider"></span>
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="cantidad">Cantidad:</label>
                  <input type="number" class="form-input" id="cantidad" required min="0.1" step="0.1" style="min-width:0;">
                </div>
                <button type="button" class="button button-primary" onclick="agregarColaboradorGeomatica()" id="btnAgregarColaborador" style="display: none;">‚ûï Agregar Colaborador</button>
                <ul id="lista-colaboradores"></ul>
                <div class="form-group">
                  <label for="departamento">Departamento:</label>
                  <div style="display:flex;gap:8px;align-items:center;position:relative;">
                    <select class="form-input" id="departamento" style="flex:1;min-width:0;" disabled>
                      <option value="">Seleccionar departamento...</option>
                      <option value="Geom√°tica">Geom√°tica</option>
                      <option value="Ambiental">Ambiental</option>
                      <option value="Social">Social</option>
                    </select>
                    <button type="button" id="btnHabilitarDepto" class="button button-small" style="white-space:nowrap;">üîí Habilitar Departamento</button>
                    <div id="departamento-badge" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--primary-color);color:white;padding:2px 6px;border-radius:10px;font-size:11px;font-weight:bold;display:none;">ACTIVO</div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="cliente">Cliente:</label>
                  <select class="form-input" id="cliente" required>
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="asunto">Asunto:</label>
                  <select class="form-input" id="asunto" required>
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="num-cliente">Num-Cliente:</label>
                  <input type="text" class="form-input" id="num-cliente">
                </div>
                <div class="form-group">
                  <label for="num-asunto">Num-Asunto:</label>
                  <input type="text" class="form-input" id="num-asunto">
                </div>
                <div class="form-group">
                  <label for="lider">L√≠der:</label>
                  <input type="text" class="form-input" id="lider" readonly>
                </div>
                <div class="form-group">
                  <label for="categoria">Categor√≠a:</label>
                  <select class="form-input" id="categoria" required>
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="descripcion">Descripci√≥n:</label>
                  <select class="form-input" id="descripcion" required>
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                <div class="form-group" style="grid-column:1/-1;">
                  <label for="observaciones">Observaciones:</label>
                  <textarea class="form-input" id="observaciones" rows="2"></textarea>
                </div>
                <div class="form-group">
                  <label for="tipo_solicitud">Tipo Solicitud:</label>
                  <select class="form-input" id="tipo_solicitud" required>
                    <option value="">Seleccionar...</option>
                    <option value="Planeada">Planeada (x1)</option>
                    <option value="Urgente">Urgente (x1.5)</option>
                    <option value="Bomberazo">Bomberazo (x2.3)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="nivel">Nivel:</label>
                  <select class="form-input" id="nivel" required>
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="costo">üí≤ Costo:</label>
                  <input type="text" class="form-input costo-cell" id="costo" readonly>
                </div>
                <div class="form-group">
                  <label for="costoxnivel">üí≤ Costo por Nivel:</label>
                  <input type="text" class="form-input costo-cell" id="costoxnivel" readonly>
                </div>
                <div class="form-group">
                  <label for="costoTotal">üí≤ Costo Total:</label>
                  <input type="text" class="form-input costo-cell" id="costoTotal" readonly>
                </div>
                <div class="form-group">
                  <label for="estatus">Estatus:</label>
                  <select class="form-input" id="estatus" required>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Entregado">Entregado</option>
                  </select>
                </div>
              </div>
              <div class="form-actions" style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:16px;margin-top:18px;justify-content:flex-end;">
                <button type="button" class="button button-primary" onclick="manejarRegistros.agregar()" id="btnAgregarRegistro">‚ûï Agregar a Tabla</button>
                <button type="button" class="button button-primary" id="btnActualizarRegistro">‚úèÔ∏è Actualizar Registro</button>
                <button type="button" class="button button-danger" id="btnCancelarEdicion" onclick="cancelarEdicion()">‚ùå Cancelar</button>
                <button type="button" class="button button-info" onclick="mostrarAyudaDecimales()" title="Ayuda sobre registros decimales">‚ùì Ayuda Decimales</button>
              </div>
            </form>
          </div>
          
          <!-- Filtros de B√∫squeda y Consulta -->
          <div class="seccion-entrega" style="margin-top: 20px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2> Consulta y Filtros</h2>
              <div id="seccion-entrega-indicator" style="
                background: var(--success-color);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 0.9em;
              ">
                üè¢ <span id="seccion-entrega-nombre">N/A</span>
              </div>
            </div>
            
            <button id="toggleBusqueda" class="button button-primary">üîç Mostrar/Ocultar B√∫squeda</button>
            
            <div id="contenedorBusqueda" style="display: none;">
              <div class="busqueda-grid">
                <div class="form-group">
                  <label for="semana-entrega">üìÖ Semana:</label>
                  <input type="week" class="form-input" id="semana-entrega">
                </div>
                
                <div class="form-group">
                  <label for="colaborador-entrega">üë§üë• Colaborador:</label>
                  <select class="form-input" id="colaborador-entrega">
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="coordinador-entrega"> Coordinador:</label>
                  <select class="form-input" id="coordinador-entrega">
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="cliente-entrega">üè¢ Cliente:</label>
                  <select class="form-input" id="cliente-entrega">
                    <option value="">Seleccionar...</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="estatus-entrega"> Estatus:</label>
                  <select class="form-input" id="estatus-entrega">
                    <option value="">Todos</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Cancelado">Cancelado</option>
                  </select>
                </div>

                <!-- Campo de b√∫squeda para seleccionar hoja -->
                <div class="form-group">
                  <label for="hoja-busqueda">üìÑ Hoja de Datos:</label>
                  <select class="form-input" id="hoja-busqueda">
                    <option value="DatosFormulario">Planeaci√≥n</option>
                    <option value="Entregas">Entregas</option>
                  </select>
                </div>
              </div>
              
              <div class="busqueda-acciones">
                <button class="button button-primary" onclick="buscarReg()">üîç Buscar</button>
                <button class="button button-primary" onclick="limpiarBusqueda()">üîÑ Limpiar</button>
                <button class="button button-danger" onclick="borrarTabla()">üóëÔ∏è Borrar tabla</button>
                <!-- Bot√≥n CSV eliminado -->
                <button class="button button-success" onclick="exportarExcel()">üìä Exportar Excel</button>
                <button class="button button-success" onclick="exportarPDF()">üìÑ Exportar PDF</button>
                <button class="button button-primary" onclick="mostrarVistaPrevia()">üëÅÔ∏è Vista Previa</button>
              </div>
            </div>
            
            <!-- Botones para guardar registro(s) en el Sheet -->
          </div>
          
          <!-- Tabla de registros para la secci√≥n de Planeaci√≥n -->
          <div class="form-container" style="margin-top: 20px;">
            <h3>üìã Registros de Planeaci√≥n</h3>
            
            <!-- Botones para guardar registro(s) en el Sheet -->
            <div class="form-actions" style="margin-bottom: 20px;">
              <button id="btnGuardarNuevosPlaneacion" type="button" class="button button-primary" style="display:none;">üíæ Guardar Nuevos (<span id="contadorNuevosPlaneacion">0</span>)</button>
              <button id="btnGuardarEditadosPlaneacion" type="button" class="button button-success" style="display:none;">üíæ Guardar Editados (<span id="contadorEditadosPlaneacion">0</span>)</button>
              <button id="btnGuardarTemporalesPermanente" type="button" class="button button-warning" title="Guarda todos los registros temporales de la tabla de manera permanente" style="display:none;">üîí Guardar Tabla Permanente (<span id="contadorTemporalesPlaneacion">0</span>)</button>
              <button type="button" class="button button-info" onclick="manejarRegistros.mostrarRegistrosContinuables()" title="Mostrar registros decimales que pueden continuar" id="btnVerContinuablesPlaneacion" style="display:none;">üìã Ver Continuables</button>
<script>
// --- Inicializaci√≥n de botones de guardado y b√∫squeda en Planeaci√≥n ---
window.addEventListener('DOMContentLoaded', function() {
  // Botones de guardado de planeaci√≥n
  const btnGuardarNuevosPlaneacion = document.getElementById('btnGuardarNuevosPlaneacion');
  const btnGuardarEditadosPlaneacion = document.getElementById('btnGuardarEditadosPlaneacion');
  const btnGuardarTemporalesPermanente = document.getElementById('btnGuardarTemporalesPermanente');
  if (btnGuardarNuevosPlaneacion) {
    btnGuardarNuevosPlaneacion.addEventListener('click', () => manejarRegistros.guardarNuevos());
  }
  if (btnGuardarEditadosPlaneacion) {
    btnGuardarEditadosPlaneacion.addEventListener('click', () => manejarRegistros.guardarEditados());
  }
  if (btnGuardarTemporalesPermanente) {
    btnGuardarTemporalesPermanente.addEventListener('click', () => manejarRegistros.guardarTemporalesPermanente());
  }

  // Bot√≥n Actualizar Registro
  const btnActualizarRegistro = document.getElementById('btnActualizarRegistro');
  if (btnActualizarRegistro) {
    btnActualizarRegistro.addEventListener('click', () => manejarRegistros.actualizar());
  }
  // Bot√≥n mostrar/ocultar b√∫squeda
  const toggleBusquedaBtn = document.getElementById('toggleBusqueda');
  const contenedorBusqueda = document.getElementById('contenedorBusqueda');
  if (toggleBusquedaBtn && contenedorBusqueda) {
    contenedorBusqueda.style.display = 'none';
    toggleBusquedaBtn.textContent = 'üîç Mostrar B√∫squeda';
    toggleBusquedaBtn.addEventListener('click', function() {
      const estaOculto = contenedorBusqueda.style.display === 'none';
      contenedorBusqueda.style.display = estaOculto ? 'block' : 'none';
      toggleBusquedaBtn.textContent = estaOculto ? 'üîç Ocultar B√∫squeda' : 'üîç Mostrar B√∫squeda';
    });
  }
});
</script>
            </div>
            
            <div class="scrollable-table">
              <table class="data-table" id="tablaPlaneacion">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Colaborador</th>
                    <th>Departamento</th>
                    <th>Cliente</th>
                    <th>Asunto</th>
                    <th>L√≠der</th>
                    <th>Categor√≠a</th>
                    <th>Descripci√≥n</th>
                    <th>Observaciones</th>
                    <th>Cantidad</th>
                    <th>Tipo Solicitud</th>
                    <th>Nivel</th>
                    <th>Costo</th>
                    <th>Costo por Nivel</th>
                    <th>Costo Total</th>
                    <th>Estatus</th>
                    <th>Semana</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyPlaneacion">
                  <tr>
                    <td colspan="19" style="text-align: center; color: #999; padding: 20px;">
                      No hay registros para mostrar. Agregue registros usando el formulario.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal para la clave maestra -->
  <div id="modalClaveMaestra" class="modal">
    <div class="modal-content">
      <h3>üîí Autenticaci√≥n Requerida</h3>
      <p>Ingrese la clave maestra para acceder:</p>
      <input type="password" id="inputClaveMaestra" class="form-input" placeholder="Clave maestra">
      <div class="modal-actions">
        <button class="button button-primary" onclick="verificarClaveMaestra()">‚úÖ Verificar</button>
        <button class="button button-danger" onclick="cancelarModoMaestra()">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para cambiar clave -->
  <div id="modalCambioClave" class="modal">
    <div class="modal-content">
      <h3>üîë Cambiar Clave Maestra</h3>
      <div class="form-group">
        <label for="claveActual">Clave actual:</label>
        <input type="password" id="claveActual" class="form-input" placeholder="Clave actual">
      </div>
      <div class="form-group">
        <label for="nuevaClave">Nueva clave:</label>
        <input type="password" id="nuevaClave" class="form-input" placeholder="Nueva clave">
      </div>
      <div class="form-group">
        <label for="confirmarClave">Confirmar nueva clave:</label>
        <input type="password" id="confirmarClave" class="form-input" placeholder="Confirmar clave">
      </div>
      <div class="modal-actions">
        <button class="button button-primary" onclick="cambiarClaveMaestra()">üíæ Guardar Cambios</button>
        <button class="button button-danger" onclick="ocultarModal('modalCambioClave')">‚ùå Cancelar</button>
      </div>
    </div>
  </div>




  <!-- Pesta√±a flotante para vista previa -->
  <div class="floating-tab" id="floatingTab" onclick="mostrarVistaPrevia()">
    üëÅÔ∏è Vista Previa
  </div>

  <!-- Contenedor de vista previa -->
  <div class="preview-container" id="previewContainer">
    <button class="close-preview" onclick="ocultarVistaPrevia()">√ó</button>
    <h2>Resumen de Registros</h2>
    
    <div class="resumen-container">
      <div class="resumen-item">
        <span class="resumen-label">Total registros:</span>
        <span class="resumen-value" id="resumen-total">0</span>
      </div>
      
      <div class="resumen-item">
        <span class="resumen-label">Pendientes:</span>
        <span class="resumen-value" id="resumen-pendientes">0</span>
      </div>
      
      <div class="resumen-item">
        <span class="resumen-label">Entregados:</span>
        <span class="resumen-value" id="resumen-entregados">0</span>
      </div>
      
      <div class="resumen-item">
        <span class="resumen-label">Cancelados:</span>
        <span class="resumen-value" id="resumen-cancelados">0</span>
      </div>
      
      <div class="resumen-item">
        <span class="resumen-label">Total costo:</span>
        <span class="resumen-value" id="resumen-costo-total">$0.00</span>
      </div>
      
      <div class="resumen-item full-width">
        <span class="resumen-label">Clientes:</span>
        <div class="resumen-clientes" id="resumen-clientes"></div>
      </div>
      
      <div class="resumen-item full-width">
        <span class="resumen-label">Departamentos:</span>
        <div class="resumen-departamentos" id="resumen-departamentos"></div>
      </div>
    </div>
    
    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="button button-success" onclick="exportarExcel()">üìä Excel</button>
      <button class="button button-info" onclick="exportarPDF()">üìÑ PDF</button>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loading-message" style="color: white; margin: 10px 0; font-size: 14px;">Cargando datos...</p>
      <button class="button button-danger" onclick="cancelarOperacion()" style="margin-top: 10px; padding: 5px 15px; font-size: 12px;">‚ùå Cancelar</button>
    </div>
  </div>

  <!-- Loader de pantalla completa -->
  <div id="loader-overlay" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(20,24,31,0.98);display:flex;align-items:center;justify-content:center;transition:opacity 0.4s;">
    <div style="text-align:center;">
      <div style="margin-bottom:18px;">
        <span style="font-size:2.5em;">‚è≥</span>
      </div>
      <div style="color:#fff;font-size:1.2em;letter-spacing:1px;">Cargando sistema...</div>
    </div>
  </div>
  <div id="main-content" style="opacity:0;transition:opacity 0.4s;">
  <script>

  // === Alternancia de tema claro/oscuro SOLO desde el panel flotante ===
  function setTheme(mode) {
    if (mode === 'dark') {
      document.body.classList.add('dark-mode');
      localStorage.setItem('theme', 'dark');
      var icon = document.getElementById('themeIcon');
      var text = document.getElementById('themeText');
      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Claro';
    } else {
      document.body.classList.remove('dark-mode');
      localStorage.setItem('theme', 'light');
      var icon = document.getElementById('themeIcon');
      var text = document.getElementById('themeText');
      if (icon) icon.className = 'fas fa-moon';
      if (text) text.textContent = 'Oscuro';
    }
    // Forzar actualizaci√≥n de todos los elementos con color heredado
    document.body.style.background = getComputedStyle(document.body).getPropertyValue('--background');
    document.body.style.color = getComputedStyle(document.body).getPropertyValue('--text-color');
    // Actualizar tablas y otros elementos si es necesario
    if (typeof aplicarContrasteTablasDashboard === 'function') aplicarContrasteTablasDashboard();
  }
  function toggleTheme() {
    const current = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(current === 'dark' ? 'light' : 'dark');
  }
  document.addEventListener('DOMContentLoaded', function() {
    const saved = localStorage.getItem('theme');
    if (saved) {
      setTheme(saved);
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      setTheme('dark');
    } else {
      setTheme('light');
    }
    function assignThemeBtnHandler() {
      var btn = document.getElementById('btnToggleTheme');
      if (btn) btn.onclick = toggleTheme;
    }
    assignThemeBtnHandler();
    // Si el bot√≥n se inserta din√°micamente, observar cambios en el DOM
    const observer = new MutationObserver(assignThemeBtnHandler);
    observer.observe(document.body, { childList: true, subtree: true });
  });
    // ===== VARIABLES GLOBALES (SINTAXIS VERIFICADA) =====
    
    // Variables para datos
    let registrosTemporales = [];
    let registrosDashboard = [];
    let registroEditando = null;
    let colaboradoresGeomatica = [];
    
    // Variables de estado
    let modoMaestroActivo = false;
    let usuarioActual = '';
    let departamentoActual = '';
    let esAdmin = false;
    let esCoordinador = false;
    
    // Objeto de permisos
    let permisosUsuario = {
      departamentos: [],
      admin: false
    };
    
    // ===== VERIFICACI√ìN INMEDIATA =====
    console.log('‚úÖ Variables globales definidas correctamente');
    
    // ===== FUNCIONES CR√çTICAS TEMPRANAS =====
    function cancelarOperacion() {
      try {
        mostrarLoading(false);
        mostrarAlerta('Operaci√≥n cancelada por el usuario', 'info');
      } catch (e) {
        console.log('Operaci√≥n cancelada');
      }
    }

    // Inicializaci√≥n OPTIMIZADA
    function inicializarAplicacion() {
      console.log('üöÄ Iniciando aplicaci√≥n...');
      
      try {
        // Cargar tema r√°pidamente
        cargarTema();
        
        // Ocultar SOLO las secciones principales, no hacer b√∫squedas innecesarias
        const mainSection = document.getElementById('main-section');
        const recuperarSection = document.getElementById('recuperar-section');
        
        if (mainSection) {
          mainSection.style.display = 'none';
          mainSection.classList.remove('active-section');
        }
        if (recuperarSection) {
          recuperarSection.style.display = 'none';
          recuperarSection.classList.remove('active-section');
        }
        
        // Mostrar solo la secci√≥n de login (ya deber√≠a estar visible por CSS)
        const loginSection = document.getElementById('login-section');
        if (loginSection) {
          loginSection.style.display = 'block';
          loginSection.classList.add('active-section');
        }
        
        // Ocultar elementos que no se necesitan en login
        const floatingTab = document.getElementById('floatingTab');
        if (floatingTab) floatingTab.style.display = 'none';
        
        // Configurar SOLO el formulario de login - SIN cargar datos a√∫n
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
          loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            realizarLogin();
          });
        }
        
        // Solo configurar eventos b√°sicos del login
        configurarEventListenersBasicos();
        
        console.log('‚úÖ Aplicaci√≥n inicializada - Lista para login');
      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        mostrarAlerta('Error al inicializar la aplicaci√≥n: ' + error.message, 'error');
      }
    }
    
    // Funci√≥n separada OPTIMIZADA para configurar elementos despu√©s del login
    function inicializarAplicacionCompleta() {
      console.log('üîß Configurando aplicaci√≥n completa...');
      
      try {
        // Configurar eventos b√°sicos
        configurarEventListeners();
        
        // SOLO cargar datos si NO es admin o si es necesario
        // Para admin, cargar bajo demanda
        if (!esAdmin) {
          console.log('üë§ Cargando datos para usuario departamental...');
          cargarDatosIniciales();
        } else {
          console.log(' Admin detectado - datos se cargar√°n bajo demanda');
        }
        
        // Configurar botones de guardado
        manejarRegistros.actualizarBotonesGuardado();
        
        // Establecer fecha por defecto (hora local de Ciudad de M√©xico)
        const fechaElement = document.getElementById('fecha');
        if (fechaElement) {
          const today = getFechaLocalMexico();
          fechaElement.value = today;
          console.log('üìÖ Fecha establecida:', today);
        }
        
        // Configurar eventos para c√°lculo autom√°tico de costos (solo si no es admin)
        if (!esAdmin) {
          ['cantidad', 'tipo_solicitud', 'costoxnivel', 'nivel'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
              element.addEventListener('change', actualizarCostos);
              element.addEventListener('input', actualizarCostos);
            }
          });
        }

        // Ocultar botones de edici√≥n inicialmente
        const btnActualizar = document.getElementById('btnActualizarRegistro');
        const btnCancelar = document.getElementById('btnCancelarEdicion');
        if (btnActualizar) btnActualizar.style.display = 'none';
        if (btnCancelar) btnCancelar.style.display = 'none';
        
        // Configurar colaborador por defecto SOLO si no es admin y hay datos
        if (!esAdmin) {
          setTimeout(configurarColaboradorPorDefecto, 500);
        }
        
        console.log('‚úÖ Aplicaci√≥n completa configurada');
      } catch (error) {
        console.error('‚ùå Error en configuraci√≥n completa:', error);
        mostrarAlerta('Error al configurar aplicaci√≥n: ' + error.message, 'error');
      }
    }
    
    // Funci√≥n para configurar el colaborador y departamento por defecto en planeaci√≥n
    function configurarColaboradorPorDefecto() {
      const colaboradorSelect = document.getElementById('colaborador');
      const departamentoSelect = document.getElementById('departamento');
      const switchElement = document.getElementById('switch-colaborador');
      
      if (colaboradorSelect && usuarioActual) {
        // Configurar switch en estado deshabilitado (usuario actual por defecto)
        if (switchElement) {
          switchElement.checked = false;
          colaboradorSelect.disabled = true;
          colaboradorSelect.style.opacity = '0.7';
        }
        
        const userOption = Array.from(colaboradorSelect.options).find(option => option.value === usuarioActual);
        if (userOption) {
          colaboradorSelect.value = usuarioActual;
          console.log(`‚úÖ Usuario ${usuarioActual} configurado por defecto en formulario de planeaci√≥n`);
          
          // Configurar departamento autom√°ticamente
          if (departamentoSelect && departamentoActual) {
            departamentoSelect.value = departamentoActual;
            console.log(`‚úÖ Departamento ${departamentoActual} configurado por defecto`);
            
            // Mostrar indicador de que el departamento est√° configurado autom√°ticamente
            const departamentoBadge = document.getElementById('departamento-badge');
            if (departamentoBadge) {
              departamentoBadge.style.display = 'block';
              departamentoBadge.textContent = 'AUTO';
              departamentoBadge.title = `Departamento configurado autom√°ticamente: ${departamentoActual}`;
            }
          }
          
          // Disparar evento change para actualizar campos dependientes
          const changeEvent = new Event('change', { bubbles: true });
          colaboradorSelect.dispatchEvent(changeEvent);
          
          // Tambi√©n disparar change en departamento si se configur√≥
          if (departamentoSelect && departamentoActual) {
            const departamentoChangeEvent = new Event('change', { bubbles: true });
            departamentoSelect.dispatchEvent(departamentoChangeEvent);
          }
        } else {
          console.warn(`‚ö†Ô∏è No se encontr√≥ opci√≥n para usuario ${usuarioActual} en el selector de colaboradores`);
        }
      } else {
        console.warn('‚ö†Ô∏è No se pudo configurar colaborador por defecto:', {
          colaboradorSelect: !!colaboradorSelect,
          usuarioActual: usuarioActual
        });
      }
    }
    
    // Funci√≥n de debug para verificar configuraci√≥n de colaborador
    function debugColaboradorDefecto() {
      console.log('=== DEBUG COLABORADOR POR DEFECTO ===');
      console.log('Usuario actual:', usuarioActual);
      
      const colaboradorSelect = document.getElementById('colaborador');
      console.log('Select colaborador encontrado:', !!colaboradorSelect);
      
      if (colaboradorSelect) {
        console.log('Valor actual del select:', colaboradorSelect.value);
        console.log('Opciones disponibles:', Array.from(colaboradorSelect.options).map(opt => opt.value));
        
        const userOption = Array.from(colaboradorSelect.options).find(option => option.value === usuarioActual);
        console.log('Opci√≥n del usuario encontrada:', !!userOption);
        
        if (userOption) {
          console.log('Datos de la opci√≥n:', {
            value: userOption.value,
            text: userOption.textContent,
            departamento: userOption.dataset.depto,
            coordinador: userOption.dataset.coordinador
          });
        }
      }
      
      const planeacionSection = document.getElementById('Planeacion-section');
      console.log('Secci√≥n de planeaci√≥n visible:', planeacionSection?.style.display !== 'none');
      console.log('==================================');
    }

    // Funci√≥n para toggle del select de colaborador
    function toggleColaboradorSelect() {
      const switchElement = document.getElementById('switch-colaborador');
      const colaboradorSelect = document.getElementById('colaborador');
      const btnAgregarColaborador = document.getElementById('btnAgregarColaborador');
      
      if (switchElement.checked) {
        // Habilitar selecci√≥n de otros colaboradores
        colaboradorSelect.disabled = false;
        colaboradorSelect.style.opacity = '1';
        btnAgregarColaborador.style.display = 'inline-block';
        console.log('Modo selecci√≥n de otros colaboradores activado');
      } else {
        // Volver al usuario actual por defecto
        colaboradorSelect.disabled = true;
        colaboradorSelect.style.opacity = '0.7';
        btnAgregarColaborador.style.display = 'none';
        
        if (usuarioActual) {
          const userOption = Array.from(colaboradorSelect.options).find(option => option.value === usuarioActual);
          if (userOption) {
            colaboradorSelect.value = usuarioActual;
            
            // Disparar evento change para actualizar campos dependientes
            const changeEvent = new Event('change', { bubbles: true });
            colaboradorSelect.dispatchEvent(changeEvent);
            
            console.log(`Usuario ${usuarioActual} reseleccionado autom√°ticamente`);
          }
        }
      }
    }
    
    // Configuraci√≥n b√°sica OPTIMIZADA de eventos para el login
    function configurarEventListenersBasicos() {
      console.log('‚öôÔ∏è Configurando eventos b√°sicos para login...');
      
      try {
        // Solo configurar eventos b√°sicos del login - NO Google Scripts a√∫n
        
        // Enter key en campos de login
        const loginUsuario = document.getElementById('login-usuario');
        const loginPassword = document.getElementById('login-password');
        
        if (loginUsuario) {
          loginUsuario.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              if (loginPassword) loginPassword.focus();
            }
          });
        }
        
        if (loginPassword) {
          loginPassword.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              realizarLogin();
            }
          });
        }
        
        // Bot√≥n de toggle de tema
        const themeToggle = document.querySelector('.theme-panel-toggle');
        if (themeToggle && !themeToggle.hasAttribute('data-event-configured')) {
          themeToggle.setAttribute('data-event-configured', 'true');
          console.log('‚öôÔ∏è Toggle de tema configurado');
        }
        
        console.log('‚úÖ Eventos b√°sicos configurados');
      } catch (error) {
        console.error('‚ùå Error configurando eventos b√°sicos:', error);
      }
    }

    // Gesti√≥n de modales y alertas
    function mostrarAlerta(mensaje, tipo = 'info') {
      const alerta = document.createElement('div');
      alerta.className = `alerta alerta-${tipo}`;
      
      // Si el mensaje contiene HTML (como botones), usar innerHTML
      if (mensaje.includes('<')) {
        alerta.innerHTML = mensaje;
      } else {
        alerta.textContent = mensaje;
      }
      
      document.body.appendChild(alerta);
      
      setTimeout(() => {
        if (alerta.parentNode) {
          alerta.parentNode.removeChild(alerta);
        }
      }, 8000); // M√°s tiempo para leer mensajes con botones
    }

    let timeoutLoading = null;

    function mostrarLoading(mostrar, operacion = 'general') {
      const loading = document.getElementById('loading');
      const loadingMessage = document.getElementById('loading-message');
      
      loading.style.display = mostrar ? 'flex' : 'none';
      
      // Actualizar mensaje seg√∫n la operaci√≥n
      if (mostrar && loadingMessage) {
        const mensajes = {
          'general': 'Cargando datos...',
          'exportar': 'Exportando archivo Excel... Esta operaci√≥n puede tardar unos minutos.',
          'dashboard': 'Cargando dashboard... Procesando datos.',
          'buscar': 'Buscando registros...',
          'guardar': 'Guardando registro...'
        };
        loadingMessage.textContent = mensajes[operacion] || mensajes['general'];
      }
      
      // Si se est√° mostrando el loading, configurar un timeout de seguridad
      if (mostrar) {
        // Limpiar timeout anterior si existe
        if (timeoutLoading) {
          clearTimeout(timeoutLoading);
        }
        
        // Configurar timeout seg√∫n el tipo de operaci√≥n
        let timeoutDuration = 30000; // 30 segundos por defecto
        if (operacion === 'exportar') {
          timeoutDuration = 90000; // 90 segundos para exportaciones (aumentado)
        } else if (operacion === 'dashboard') {
          timeoutDuration = 45000; // 45 segundos para dashboard
        }
        
        // Configurar nuevo timeout
        timeoutLoading = setTimeout(() => {
          console.warn(`Operaci√≥n '${operacion}' tardando m√°s de ${timeoutDuration/1000} segundos, ocultando loading autom√°ticamente`);
          mostrarLoading(false);
          mostrarAlerta(`La operaci√≥n est√° tardando m√°s de lo esperado (${timeoutDuration/1000}s). Intente nuevamente.`, 'warning');
        }, timeoutDuration);
      } else {
        // Si se oculta el loading, limpiar el timeout
        if (timeoutLoading) {
          clearTimeout(timeoutLoading);
          timeoutLoading = null;
        }
      }
    }

    function descargarArchivoAlternativo(url, filename, formato) {
      console.log('M√©todo alternativo de descarga iniciado');
      console.log('URL:', url, 'Filename:', filename, 'Formato:', formato);
      
      if (!url || url.trim() === '') {
        mostrarAlerta('URL de descarga no v√°lida', 'error');
        return;
      }
      
      try {
        // M√©todo 1: Descarga directa
        const link = document.createElement('a');
        link.href = url;
        link.download = filename || `export_${Date.now()}.${formato}`;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // Limpiar despu√©s de un delay
        setTimeout(() => {
          if (document.body.contains(link)) {
            document.body.removeChild(link);
          }
        }, 1000);
        
        // M√©todo 2: Abrir en nueva ventana como respaldo
        setTimeout(() => {
          try {
            console.log('Abriendo en nueva ventana como respaldo...');
            window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
          } catch (windowError) {
            console.error('Error al abrir nueva ventana:', windowError);
          }
        }, 2000);
        
        mostrarAlerta(`Descarga iniciada para archivo ${formato.toUpperCase()}. <br>
          <button onclick="window.open('${url}', '_blank')" class="button button-secondary" style="margin-top: 10px;">
            üîó Abrir en nueva ventana
          </button>`, 'success');
        
      } catch (error) {
        console.error('Error en descarga alternativa:', error);
        // √öltimo recurso: mostrar URL para copia manual
        mostrarAlerta(`Error en la descarga. <br>
          URL directa: <input type="text" value="${url}" style="width: 100%; margin: 10px 0;" readonly onclick="this.select()"> <br>
          <button onclick="window.open('${url}', '_blank')" class="button button-info">üîó Abrir URL</button>
          <button onclick="navigator.clipboard.writeText('${url}').then(() => mostrarAlerta('URL copiada al portapapeles', 'info'))" class="button button-secondary">üìã Copiar URL</button>`, 'warning');
      }
    }

    function mostrarModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function ocultarModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Funciones de b√∫squeda y gesti√≥n de registros
    function buscarReg() {
      // Detectar qu√© secci√≥n est√° activa para usar los elementos correctos
      const dashboardSection = document.getElementById('Dashboard-section');
      const planeacionSection = document.getElementById('Planeacion-section');
      const isDashboardActive = dashboardSection && dashboardSection.style.display !== 'none';
      const isPlaneacionActive = planeacionSection && planeacionSection.style.display !== 'none';
      
      let semana, colaborador, coordinador, cliente, estatus;
      
      if (isPlaneacionActive) {
        // Usar elementos de la secci√≥n de planeaci√≥n/entrega
        semana = document.getElementById('semana-entrega').value;
        colaborador = document.getElementById('colaborador-entrega').value;
        coordinador = document.getElementById('coordinador-entrega').value;
        cliente = document.getElementById('cliente-entrega').value;
        estatus = document.getElementById('estatus-entrega').value;
      } else {
        // Usar elementos de la secci√≥n de dashboard/planeaci√≥n
        semana = document.getElementById('semana').value;
        colaborador = document.getElementById('colaborador-busqueda').value;
        coordinador = document.getElementById('coordinador-busqueda').value;
        cliente = document.getElementById('cliente-busqueda').value;
        estatus = document.getElementById('estatus-busqueda').value;
      }
      
      const hoja = document.getElementById('hoja-busqueda').value;
      
      // Aplicar filtros de departamento seg√∫n permisos y secci√≥n activa
      let filtrosCompletos = {
        semana: semana,
        colaborador: colaborador,
        coordinador: coordinador,
        cliente: cliente,
        estatus: estatus,
        hoja: hoja
      };
      
      // Todos los usuarios pueden usar todos los filtros
      // Los administrativos solo pueden visualizar, no editar
      
      console.log('Filtros aplicados:', filtrosCompletos);
      mostrarLoading(true, 'buscar');
      
      google.script.run
        .withSuccessHandler(data => {
          console.log(`B√∫squeda completada: ${data.length} registros encontrados`);
          
          registrosTemporales = data.map(registro => ({
            ...registro,
            editado: false
          }));
          
          // Determinar qu√© secci√≥n est√° activa para actualizar la tabla correcta
          const dashboardSection = document.getElementById('Dashboard-section');
          const planeacionSection = document.getElementById('Planeacion-section');
          
          if (dashboardSection && dashboardSection.style.display !== 'none') {
            // Estamos en dashboard
            actualizarTablaDashboard(registrosTemporales);
            generarTablasDinamicas(registrosTemporales);
          } else if (planeacionSection && planeacionSection.style.display !== 'none') {
            // Estamos en planeaci√≥n/entrega
            manejarRegistros.actualizarTabla();
            manejarRegistros.actualizarBotonesGuardado();
          } else {
            // Fallback: actualizar tabla normal
            manejarRegistros.actualizarTabla();
            manejarRegistros.actualizarBotonesGuardado();
          }
          
          actualizarVistaPrevia();
          mostrarLoading(false);
          
          const mensaje = data.length > 0 ? 
            `${data.length} registros encontrados` : 
            'No se encontraron registros con los filtros aplicados';
          mostrarAlerta(mensaje, data.length > 0 ? 'success' : 'info');
        })
        .withFailureHandler(error => {
          console.error('Error en b√∫squeda:', error);
          mostrarLoading(false);
          mostrarAlerta('Error al buscar registros: ' + error.message, 'error');
        })
        .buscarReg(JSON.stringify(filtrosCompletos));
    }

    function limpiarBusqueda() {
      // Limpiar todos los campos de b√∫squeda - secci√≥n dashboard/planeaci√≥n
      document.getElementById('semana').value = '';
      document.getElementById('colaborador-busqueda').value = '';
      document.getElementById('coordinador-busqueda').value = '';
      document.getElementById('cliente-busqueda').value = '';
      document.getElementById('estatus-busqueda').value = '';
      document.getElementById('hoja-busqueda').value = 'DatosFormulario';
      
      // Limpiar tambi√©n los campos de la secci√≥n de entrega si existen
      const semanaEntrega = document.getElementById('semana-entrega');
      const colaboradorEntrega = document.getElementById('colaborador-entrega');
      const coordinadorEntrega = document.getElementById('coordinador-entrega');
      const clienteEntrega = document.getElementById('cliente-entrega');
      const estatusEntrega = document.getElementById('estatus-entrega');
      
      if (semanaEntrega) semanaEntrega.value = '';
      if (colaboradorEntrega) colaboradorEntrega.value = '';
      if (coordinadorEntrega) coordinadorEntrega.value = '';
      if (clienteEntrega) clienteEntrega.value = '';
      if (estatusEntrega) estatusEntrega.value = '';
      
      // Limpiar tambi√©n los datos de la tabla
      registrosTemporales = [];
      
      // Determinar qu√© tabla actualizar seg√∫n la secci√≥n activa
      const dashboardSection = document.getElementById('Dashboard-section');
      const planeacionSection = document.getElementById('Planeacion-section');
      
      if (dashboardSection && dashboardSection.style.display !== 'none') {
        // Limpiar dashboard
        actualizarTablaDashboard([]);
        const tablasDinamicas = ['tbody-departamento-cliente', 'tbody-tipo-solicitud', 'tbody-pendientes-asunto', 'tbody-rendimiento-colaborador', 'tbody-estado-proyectos'];
        tablasDinamicas.forEach(id => {
          const tbody = document.getElementById(id);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #999; padding: 20px;">No hay datos para mostrar</td></tr>';
          }
        });
      } else if (planeacionSection && planeacionSection.style.display !== 'none') {
        // Limpiar tabla de planeaci√≥n/entrega
        manejarRegistros.actualizarTabla();
        manejarRegistros.actualizarBotonesGuardado();
      }
      
      // Limpiar vista previa
      actualizarVistaPrevia();
      
      mostrarAlerta('B√∫squeda limpiada - todos los campos y datos han sido reiniciados', 'info');
    }

    function borrarTabla() {
      if (confirm('¬øEst√°s seguro de que deseas borrar todos los registros de la tabla?')) {
        registrosTemporales = [];
        
        // Si estamos en dashboard, actualizar tabla del dashboard
        const dashboardSection = document.getElementById('Dashboard-section');
        if (dashboardSection && dashboardSection.style.display !== 'none') {
          actualizarTablaDashboard(registrosTemporales);
        } else {
          // Si estamos en planeaci√≥n, actualizar tabla normal
          manejarRegistros.actualizarTabla();
          manejarRegistros.actualizarBotonesGuardado();
        }
        
        actualizarVistaPrevia();
        mostrarAlerta('Tabla borrada', 'success');
      }
    }
    function debugMostrarSecciones() {
      console.log('=== DEBUG SECCIONES ===');
      
      // Verificar estado actual
      const mainSection = document.getElementById('main-section');
      const loginSection = document.getElementById('login-section');
      
      console.log('Estado actual:', {
        mainSectionVisible: mainSection ? mainSection.style.display : 'NO ENCONTRADO',
        loginSectionVisible: loginSection ? loginSection.style.display : 'NO ENCONTRADO',
        usuarioActual,
        departamentoActual,
        esAdmin,
        esCoordinador
      });
      
      // Forzar mostrar main-section
      if (mainSection) {
        mainSection.style.display = 'block';
        mainSection.classList.add('active-section');
        console.log('main-section forzado a visible');
      }
      
      // Ocultar login-section
      if (loginSection) {
        loginSection.style.display = 'none';
        loginSection.classList.remove('active-section');
        console.log('login-section ocultado');
      }
      
      // Mostrar botones de navegaci√≥n
      const btnDashboard = document.getElementById('btnDashboard');
      const btnPlaneacion = document.getElementById('btnPlaneacion');
      const btnEntrega = document.getElementById('btnEntrega');
      
      if (btnDashboard) {
        btnDashboard.style.display = 'inline-block';
        console.log('btnDashboard mostrado');
      }
      if (btnPlaneacion) {
        btnPlaneacion.style.display = 'inline-block';
        console.log('btnPlaneacion mostrado');
      }
      if (btnEntrega) {
        btnEntrega.style.display = 'inline-block';
        console.log('btnEntrega mostrado');
      }
      
      // Forzar mostrar una secci√≥n por defecto
      if (esAdmin) {
        showSection('Dashboard');
        console.log('Forzando Dashboard para admin');
      } else {
        showSection('Planeacion');
        console.log('Forzando Planeaci√≥n para usuario');
      }
      
      mostrarAlerta('Debug ejecutado - revisa la consola para detalles', 'info');
    }
    
    // Funci√≥n espec√≠fica para vista previa del dashboard
    function actualizarVistaPreviaDashboard() {
      if (registrosDashboard.length === 0) {
        // Limpiar vista previa si no hay datos
        document.getElementById('resumen-total').textContent = '0';
        document.getElementById('resumen-pendientes').textContent = '0';
        document.getElementById('resumen-entregados').textContent = '0';
        document.getElementById('resumen-cancelados').textContent = '0';
        document.getElementById('resumen-costo-total').textContent = '$0.00';
        document.getElementById('resumen-clientes').innerHTML = 'No hay datos';
        document.getElementById('resumen-departamentos').innerHTML = 'No hay datos';
        return;
      }
      
      // Usar registrosDashboard en lugar de registrosTemporales
      const datos = registrosDashboard;
      
      // Obtener semanas actual y anterior (usando hora local de Ciudad de M√©xico)
      const semanaActual = getWeekNumber(getFechaActualMexico());
      const semanaAnterior = semanaActual - 1;
      
      // Funci√≥n para obtener la semana de un registro
      function obtenerSemanaRegistro(registro) {
        // Prioridad: 1. Fecha de entrega, 2. Semana calculada, 3. Fecha de registro
        if (registro.fechaEntrega && registro.fechaEntrega.trim() !== '') {
          try {
            const fechaEntrega = new Date(registro.fechaEntrega);
            if (!isNaN(fechaEntrega.getTime())) {
              return getWeekNumber(fechaEntrega);
            }
          } catch (e) {}
        }
        
        if (registro.semana && !isNaN(parseInt(registro.semana))) {
          return parseInt(registro.semana);
        }
        
        if (registro.fecha && registro.fecha.trim() !== '') {
          try {
            const fechaRegistro = new Date(registro.fecha);
            if (!isNaN(fechaRegistro.getTime())) {
              return getWeekNumber(fechaRegistro);
            }
          } catch (e) {}
        }
        
        return semanaActual; // fallback
      }
      
      // Filtrar registros por semanas
      const registrosSemanaActualYAnterior = datos.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual || semanaReg === semanaAnterior;
      });
      
      const registrosSemanaActual = datos.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual;
      });
      
      // Calcular estad√≠sticas seg√∫n especificaciones:
      // 1. Total de registros de semana actual y pasada
      const totalRegistros = registrosSemanaActualYAnterior.length;
      
      // 2. Registros pendientes de la semana actual
      const pendientesActual = registrosSemanaActual.filter(r => r.estatus === 'Pendiente').length;
      
      // 3. Entregados de semana anterior y actual
      const entregadosActualYAnterior = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Entregado').length;
      
      // 4. Costo total de entregados de la semana actual
      const costoEntregadosActual = registrosSemanaActual
        .filter(r => r.estatus === 'Entregado')
        .reduce((sum, r) => sum + (parseFloat(r.costoTotal) || 0), 0);
      
      // Cancelados para mostrar informaci√≥n completa
      const cancelados = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Cancelado').length;
      
      // Actualizar estad√≠sticas b√°sicas
      document.getElementById('resumen-total').textContent = totalRegistros;
      document.getElementById('resumen-pendientes').textContent = pendientesActual;
      document.getElementById('resumen-entregados').textContent = entregadosActualYAnterior;
      document.getElementById('resumen-cancelados').textContent = cancelados;
      document.getElementById('resumen-costo-total').textContent = `$${costoEntregadosActual.toFixed(2)}`;
      
      // Generar resumen de clientes (solo datos de semanas relevantes)
      const clientesMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const cliente = registro.cliente || 'Sin cliente';
        if (!clientesMap[cliente]) {
          clientesMap[cliente] = { count: 0, costo: 0 };
        }
        clientesMap[cliente].count++;
        clientesMap[cliente].costo += parseFloat(registro.costoTotal) || 0;
      });
      
      const clientesHTML = Object.entries(clientesMap)
        .sort((a, b) => b[1].costo - a[1].costo)
        .slice(0, 5) // Mostrar solo los 5 principales
        .map(([cliente, data]) => 
          `<div class="resumen-badge">${cliente}: ${data.count} registros ($${data.costo.toFixed(2)})</div>`
        ).join('');
      
      document.getElementById('resumen-clientes').innerHTML = clientesHTML || 'No hay clientes';
      
      // Generar resumen de departamentos (solo datos de semanas relevantes)
      const departamentosMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const depto = registro.departamento || 'Sin departamento';
        if (!departamentosMap[depto]) {
          departamentosMap[depto] = { count: 0, costo: 0 };
        }
        departamentosMap[depto].count++;
        departamentosMap[depto].costo += parseFloat(registro.costoTotal) || 0;
      });
      
      const departamentosHTML = Object.entries(departamentosMap)
        .sort((a, b) => b[1].costo - a[1].costo)
        .map(([depto, data]) => 
          `<div class="resumen-badge">${depto}: ${data.count} registros ($${data.costo.toFixed(2)})</div>`
        ).join('');
      
      document.getElementById('resumen-departamentos').innerHTML = departamentosHTML || 'No hay departamentos';
    }

    // Funci√≥n original para vista previa de planeaci√≥n
    function actualizarVistaPrevia() {
      if (registrosTemporales.length === 0) {
        // Limpiar vista previa si no hay datos
        document.getElementById('resumen-total').textContent = '0';
        document.getElementById('resumen-pendientes').textContent = '0';
        document.getElementById('resumen-entregados').textContent = '0';
        document.getElementById('resumen-cancelados').textContent = '0';
        document.getElementById('resumen-costo-total').textContent = '$0.00';
        document.getElementById('resumen-clientes').innerHTML = 'No hay datos';
        document.getElementById('resumen-departamentos').innerHTML = 'No hay datos';
        return;
      }
      
      // Obtener semanas actual y anterior (usando hora local de Ciudad de M√©xico)
      const semanaActual = getWeekNumber(getFechaActualMexico());
      const semanaAnterior = semanaActual - 1;
      
      // Funci√≥n para obtener la semana de un registro
      function obtenerSemanaRegistro(registro) {
        // Prioridad: 1. Fecha de entrega, 2. Semana calculada, 3. Fecha de registro
        if (registro.fechaEntrega && registro.fechaEntrega.trim() !== '') {
          try {
            const fechaEntrega = new Date(registro.fechaEntrega);
            if (!isNaN(fechaEntrega.getTime())) {
              return getWeekNumber(fechaEntrega);
            }
          } catch (e) {}
        }
        
        if (registro.semana && !isNaN(parseInt(registro.semana))) {
          return parseInt(registro.semana);
        }
        
        if (registro.fecha && registro.fecha.trim() !== '') {
          try {
            const fechaRegistro = new Date(registro.fecha);
            if (!isNaN(fechaRegistro.getTime())) {
              return getWeekNumber(fechaRegistro);
            }
          } catch (e) {}
        }
        
        return semanaActual; // fallback
      }
      
      // Filtrar registros por semanas
      const registrosSemanaActualYAnterior = registrosTemporales.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual || semanaReg === semanaAnterior;
      });
      
      const registrosSemanaActual = registrosTemporales.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual;
      });
      
      // Calcular estad√≠sticas seg√∫n especificaciones:
      // 1. Total de registros de semana actual y pasada
      const totalRegistros = registrosSemanaActualYAnterior.length;
      
      // 2. Registros pendientes de la semana actual
      const pendientesActual = registrosSemanaActual.filter(r => r.estatus === 'Pendiente').length;
      
      // 3. Entregados de semana anterior y actual
      const entregadosActualYAnterior = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Entregado').length;
      
      // 4. Costo total de entregados de la semana actual
      const costoEntregadosActual = registrosSemanaActual
        .filter(r => r.estatus === 'Entregado')
        .reduce((sum, r) => sum + (parseFloat(r.costoTotal) || 0), 0);
      
      // Cancelados para mostrar informaci√≥n completa
      const cancelados = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Cancelado').length;
      
      // Actualizar estad√≠sticas b√°sicas
      document.getElementById('resumen-total').textContent = totalRegistros;
      document.getElementById('resumen-pendientes').textContent = pendientesActual;
      document.getElementById('resumen-entregados').textContent = entregadosActualYAnterior;
      document.getElementById('resumen-cancelados').textContent = cancelados;
      document.getElementById('resumen-costo-total').textContent = `$${costoEntregadosActual.toFixed(2)}`;
      
      // Generar resumen de clientes (solo datos de semanas relevantes)
      const clientesMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const cliente = registro.cliente || 'Sin cliente';
        if (!clientesMap[cliente]) {
          clientesMap[cliente] = { count: 0, costo: 0 };
        }
        clientesMap[cliente].count++;
        clientesMap[cliente].costo += parseFloat(registro.costoTotal) || 0;
      });
      
      const clientesHTML = Object.entries(clientesMap)
        .sort((a, b) => b[1].costo - a[1].costo)
        .slice(0, 5) // Mostrar solo los 5 principales
        .map(([cliente, data]) => 
          `<div class="resumen-badge">${cliente}: ${data.count} registros ($${data.costo.toFixed(2)})</div>`
        ).join('');
      
      document.getElementById('resumen-clientes').innerHTML = clientesHTML || 'No hay clientes';
      
      // Generar resumen de departamentos (solo datos de semanas relevantes)
      const departamentosMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const depto = registro.departamento || 'Sin departamento';
        if (!departamentosMap[depto]) {
          departamentosMap[depto] = { count: 0, costo: 0 };
        }
        departamentosMap[depto].count++;
        departamentosMap[depto].costo += parseFloat(registro.costoTotal) || 0;
      });
      
      const departamentosHTML = Object.entries(departamentosMap)
        .sort((a, b) => b[1].costo - a[1].costo)
        .map(([depto, data]) => 
          `<div class="resumen-badge">${depto}: ${data.count} registros ($${data.costo.toFixed(2)})</div>`
        ).join('');
      
      document.getElementById('resumen-departamentos').innerHTML = departamentosHTML || 'No hay departamentos';
    }

    function actualizarDatosDashboard(data) {
      const semanaActual = obtenerSemanaActual();
      const semanaAnterior = semanaActual - 1;
      
      const datosFiltrados = data.filter(registro => {
        const semanaRegistro = registro.semana;
        return semanaRegistro === semanaActual || semanaRegistro === semanaAnterior;
      });
      
      registrosTemporales = datosFiltrados.map(registro => ({
        ...registro,
        editado: false
      }));
      
      // Actualizar tabla del dashboard (sin botones de acci√≥n)
      actualizarTablaDashboard(registrosTemporales);
      actualizarVistaPrevia();
      generarTablasDinamicas(datosFiltrados);
      
      // Inicializar tabla de departamento-asuntos con selector de semanas
      inicializarTablaDepartamentoAsuntos(data);
      
      mostrarLoading(false);
      
      const mensaje = `Dashboard cargado: ${datosFiltrados.length} registros (Semanas ${semanaAnterior} y ${semanaActual})`;
      mostrarAlerta(mensaje, 'success');
    }

    // Funciones para tablas din√°micas
    function mostrarTabla(tablaId) {
      // Ocultar todas las tablas
      document.querySelectorAll('.dynamic-table-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // Quitar clase active de todos los botones
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Mostrar tabla seleccionada
      const tabla = document.getElementById(`tabla-${tablaId}`);
      if (tabla) {
        tabla.classList.add('active');
      }
      
      // Activar bot√≥n correspondiente
      event.target.classList.add('active');
    }

    function generarTablasDinamicas(datos) {
      if (!datos || datos.length === 0) {
        console.warn('No hay datos para generar tablas din√°micas');
        return;
      }
      
      console.log('Generando tablas din√°micas con', datos.length, 'registros');
      
      // La tabla de departamento-asuntos se actualiza con el selector de semanas
      // Solo generamos las otras tablas aqu√≠
      generarTablaDepartamentoSemanal(datos);
      generarTablaPendientesAsunto(datos);
      generarTablaRendimientoColaborador(datos);
      generarTablaEstadoClientes(datos);
      
      // Aplicar formato ingl√©s a todos los n√∫meros en tablas
      aplicarFormatoNumerosTablas();
      
      console.log('Tablas din√°micas generadas exitosamente');
    }
    
    // Funci√≥n para forzar regeneraci√≥n del selector de semanas
    function forzarRegeneracionSelector() {
      console.log('Forzando regeneraci√≥n del selector de semanas...');
      limpiarSelectorSemanas(); // Limpiar antes de regenerar
      
      const container = document.getElementById('semanas-selector');
      if (!container) return;
      
      const semanaActual = getWeekNumber(getFechaActualMexico());
      const semanasBasicas = [];
      
      // Generar las √∫ltimas 10 semanas
      for (let i = Math.max(1, semanaActual - 9); i <= semanaActual; i++) {
        semanasBasicas.push(i);
      }
      
      container.innerHTML = `
        <div style="margin-bottom: 12px;">
          <p style="margin: 0; color: var(--text-color); font-size: 14px; font-weight: 500;">
            üìÖ Selector forzado - Semanas ${semanasBasicas[0]} a ${semanasBasicas[semanasBasicas.length-1]}
          </p>
        </div>
        <div class="semanas-grid">
          ${semanasBasicas.map(semana => `
            <div class="semana-checkbox">
              <input type="checkbox" id="semana-${semana}" value="${semana}" ${semana >= semanaActual - 1 && semana <= semanaActual ? 'checked' : ''} onchange="actualizarTablaDepartamentoAsuntos();">
              <label for="semana-${semana}">Sem ${semana}</label>
            </div>
          `).join('')}
        </div>
      `;
      
      mostrarAlerta('Selector de semanas regenerado forzosamente', 'success');
    }
    
    // Funci√≥n para probar el sistema de semanas
    function probarFuncionSemana() {
      const fechaActual = getFechaActualMexico();
      const semanaActual = getWeekNumber(fechaActual);
      
      console.log('=== PRUEBA DE FUNCI√ìN DE SEMANAS ===');
      console.log('Fecha actual M√©xico:', fechaActual);
      console.log('Semana actual:', semanaActual);
      
      // Probar con algunos registros de ejemplo
      const registroEjemplo = {
        fechaEntrega: '2024-12-15',
        semana: '50',
        fecha: '2024-12-10',
        estatus: 'Entregado',
        asunto: 'Prueba'
      };
      
      const semanaCalculada = obtenerSemanaDeRegistro(registroEjemplo);
      console.log('Registro de ejemplo:', registroEjemplo);
      console.log('Semana calculada:', semanaCalculada);
      console.log('=== FIN PRUEBA ===');
      
      mostrarAlerta(`Semana actual: ${semanaActual}. Revise la consola para m√°s detalles.`, 'info');
    }
    
    // Funci√≥n para actualizar indicador de semanas seleccionadas
    function actualizarIndicadorSemanas() {
      const semanasSeleccionadas = Array.from(document.querySelectorAll('.semana-checkbox input:checked'))
        .map(input => parseInt(input.value))
        .sort((a, b) => a - b);
      
      const total = semanasSeleccionadas.length;
      const rango = total > 0 ? `${Math.min(...semanasSeleccionadas)}-${Math.max(...semanasSeleccionadas)}` : 'Ninguna';
      
      // Actualizar cualquier indicador visual si existe
      const indicador = document.getElementById('indicador-semanas');
      if (indicador) {
        indicador.textContent = `${total} semanas seleccionadas (${rango})`;
      }
    }

    // Funci√≥n para actualizar tabla del dashboard (solo visual, sin botones)
    function actualizarTablaDashboard(datos) {
      const tbody = document.getElementById('tablaDatosDashboard');
      if (!tbody) return;
      
      // Actualizar las estad√≠sticas del dashboard principal
      actualizarEstadisticasDashboard(datos);
      
      tbody.innerHTML = datos.map(registro => {
        return `
          <tr ${registro.estatus === 'Cancelado' ? 'class="cancelado"' : ''}>
            <td class="id-cell">${registro.id || ''}</td>
            <td>${registro.fecha}</td>
            <td>${registro.colaborador}</td>
            <td>${registro.departamento}</td>
            <td>${registro.cliente}</td>
            <td>${registro.asunto}</td>
            <td>${registro.lider}</td>
            <td>${registro.categoria}</td>
            <td>${registro.descripcion}</td>
            <td>${registro.observaciones}</td>
            <td>${registro.cantidad}</td>
            <td>${registro.tipo_solicitud}</td>
            <td>${registro.nivel}</td>
            <td class="costo-cell">${formatCurrency(registro.costo || '0')}</td>
            <td class="costo-cell">${formatCurrency(registro.costoxnivel || '0')}</td>
            <td class="costo-cell">${formatCurrency(registro.costoTotal || '0')}</td>
            <td>${registro.estatus} ${registro.editado ? '<span class="editado-badge">editado</span>' : ''}</td>
            <td>${registro.semana || (registro.fecha ? (parsearFechaDDMMYYYY(registro.fecha) ? getWeekNumber(parsearFechaDDMMYYYY(registro.fecha)) : '') : '')}</td>
          </tr>
        `;
      }).join('');
    }

    // Funci√≥n para actualizar las estad√≠sticas del dashboard principal
    function actualizarEstadisticasDashboard(datos) {
      // Obtener semanas actual y anterior (usando hora local de Ciudad de M√©xico)
      const semanaActual = getWeekNumber(getFechaActualMexico());
      const semanaAnterior = semanaActual - 1;
      
      console.log('=== ESTAD√çSTICAS DASHBOARD ===');
      console.log('Semana actual:', semanaActual, 'Semana anterior:', semanaAnterior);
      console.log('Total de datos recibidos:', datos.length);
      
      // Filtrar registros por semanas usando la funci√≥n global
      const registrosSemanaActualYAnterior = datos.filter(r => {
        const semanaReg = obtenerSemanaDeRegistro(r);
        return semanaReg === semanaActual || semanaReg === semanaAnterior;
      });
      
      const registrosSemanaActual = datos.filter(r => {
        const semanaReg = obtenerSemanaDeRegistro(r);
        return semanaReg === semanaActual;
      });
      
      const registrosSemanaAnterior = datos.filter(r => {
        const semanaReg = obtenerSemanaDeRegistro(r);
        return semanaReg === semanaAnterior;
      });
      
      console.log('Registros semana actual y anterior:', registrosSemanaActualYAnterior.length);
      console.log('Registros solo semana actual:', registrosSemanaActual.length);
      console.log('Registros solo semana anterior:', registrosSemanaAnterior.length);
      
      // Calcular estad√≠sticas seg√∫n especificaciones:
      // 1. Total de registros de semana actual y pasada
      const totalRegistros = registrosSemanaActualYAnterior.length;
      
      // 2. Registros pendientes de la semana actual
      const pendientesActual = registrosSemanaActual.filter(r => r.estatus === 'Pendiente').length;
      const pendientesAnterior = registrosSemanaAnterior.filter(r => r.estatus === 'Pendiente').length;
      
      // 3. Entregados de semana anterior y actual
      const entregadosActual = registrosSemanaActual.filter(r => r.estatus === 'Entregado').length;
      const entregadosAnterior = registrosSemanaAnterior.filter(r => r.estatus === 'Entregado').length;
      const entregadosTotal = entregadosActual + entregadosAnterior;
      
      // 4. Costo total de entregados de la semana actual
      const entregadosSemanaActual = registrosSemanaActual.filter(r => r.estatus === 'Entregado');
      const entregadosSemanaAnterior = registrosSemanaAnterior.filter(r => r.estatus === 'Entregado');
      
      console.log('Registros entregados semana actual:', entregadosSemanaActual.length);
      console.log('Registros entregados semana anterior:', entregadosSemanaAnterior.length);
      
      const costoEntregadosActual = entregadosSemanaActual.reduce((sum, r) => {
        const costo = parseFloat(r.costoTotal) || 0;
        return sum + costo;
      }, 0);
      
      const costoEntregadosAnterior = entregadosSemanaAnterior.reduce((sum, r) => {
        const costo = parseFloat(r.costoTotal) || 0;
        return sum + costo;
      }, 0);
      
      const costoEntregadosTotal = costoEntregadosActual + costoEntregadosAnterior;
      
      // Calcular porcentajes
      const porcentajeEntregados = totalRegistros > 0 ? (entregadosTotal / totalRegistros * 100).toFixed(1) : 0;
      const porcentajePendientes = totalRegistros > 0 ? ((pendientesActual + pendientesAnterior) / totalRegistros * 100).toFixed(1) : 0;
      
      console.log('Costo total calculado:', costoEntregadosTotal);
      console.log('=== FIN ESTAD√çSTICAS ===');
      
      // Actualizar las estad√≠sticas en el dashboard
      const statTotalElement = document.getElementById('stat-total-registros');
      const statPendientesElement = document.getElementById('stat-pendientes');
      const statEntregadosElement = document.getElementById('stat-entregados');
      const statCostoElement = document.getElementById('stat-costo-total');
      
      // Actualizar detalles
      const statTotalDetalle = document.getElementById('stat-total-detalle');
      const statPendientesDetalle = document.getElementById('stat-pendientes-detalle');
      const statEntregadosDetalle = document.getElementById('stat-entregados-detalle');
      const statCostoDetalle = document.getElementById('stat-costo-detalle');
      
      if (statTotalElement) statTotalElement.textContent = totalRegistros;
      if (statPendientesElement) statPendientesElement.textContent = pendientesActual + pendientesAnterior;
      if (statEntregadosElement) statEntregadosElement.textContent = entregadosTotal;
      if (statCostoElement) statCostoElement.textContent = formatCurrency(costoEntregadosTotal);
      
      // Actualizar detalles
      if (statTotalDetalle) statTotalDetalle.textContent = `Sem ${semanaAnterior}: ${registrosSemanaAnterior.length} | Sem ${semanaActual}: ${registrosSemanaActual.length}`;
      if (statPendientesDetalle) statPendientesDetalle.textContent = `${porcentajePendientes}% del total | Sem ${semanaActual}: ${pendientesActual}`;
      if (statEntregadosDetalle) statEntregadosDetalle.textContent = `${porcentajeEntregados}% del total | Sem ${semanaActual}: ${entregadosActual}`;
      if (statCostoDetalle) statCostoDetalle.textContent = `Sem ${semanaActual}: ${formatCurrency(costoEntregadosActual)} | Sem ${semanaAnterior}: ${formatCurrency(costoEntregadosAnterior)}`;
    }

    function generarTablaDepartamentoAsuntos(datos) {
      const tbody = document.getElementById('tbody-departamento-cliente');
      const headerRow = document.getElementById('header-departamento-asuntos');
      if (!tbody || !headerRow) return;
      
      // Obtener semanas seleccionadas
      const semanasSeleccionadas = Array.from(document.querySelectorAll('.semana-checkbox input:checked'))
        .map(input => parseInt(input.value));
      
      if (semanasSeleccionadas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #999; padding: 20px;">‚ö†Ô∏è Seleccione al menos una semana para mostrar datos</td></tr>';
        return;
      }
      
      // Obtener semana actual para filtrar (usando hora local de Ciudad de M√©xico)
      const semanaActual = getWeekNumber(getFechaActualMexico());
      
      // Agrupar datos por asunto y semana
      const agrupado = {};
      const semanasConDatos = new Set();
      let registrosProcesados = 0;
      let registrosDescartados = 0;
      
      datos.forEach(registro => {
        if (!registro.asunto) {
          registrosDescartados++;
          return;
        }
        
        // Usar la funci√≥n global para obtener la semana correcta
        const semanaAUsar = obtenerSemanaDeRegistro(registro);
        
        // Validar que la semana sea v√°lida
        if (semanaAUsar < 1 || semanaAUsar > 53) {
          registrosDescartados++;
          return;
        }
        
        // Solo procesar si la semana est√° seleccionada
        if (!semanasSeleccionadas.includes(semanaAUsar)) {
          return;
        }
        
        semanasConDatos.add(semanaAUsar);
        
        const asunto = registro.asunto.trim();
        if (!agrupado[asunto]) {
          agrupado[asunto] = {
            asunto: asunto,
            semanas: {},
            total: 0,
            registros: 0,
            entregados: 0,
            pendientes: 0
          };
        }
        
        if (!agrupado[asunto].semanas[semanaAUsar]) {
          agrupado[asunto].semanas[semanaAUsar] = {
            costo: 0,
            registros: 0,
            entregados: 0,
            pendientes: 0
          };
        }
        
        const costo = parseFloat(registro.costoTotal) || 0;
        agrupado[asunto].semanas[semanaAUsar].costo += costo;
        agrupado[asunto].semanas[semanaAUsar].registros++;
        agrupado[asunto].total += costo;
        agrupado[asunto].registros++;
        
        if (registro.estatus === 'Entregado') {
          agrupado[asunto].semanas[semanaAUsar].entregados++;
          agrupado[asunto].entregados++;
        } else if (registro.estatus === 'Pendiente') {
          agrupado[asunto].semanas[semanaAUsar].pendientes++;
          agrupado[asunto].pendientes++;
        }
        
        registrosProcesados++;
      });
      
      // Filtrar solo asuntos con total diferente de cero
      const asuntosConDatos = Object.values(agrupado).filter(item => item.total > 0);
      
      // Mostrar estad√≠sticas en consola
      console.log(`=== ESTAD√çSTICAS DE PROCESAMIENTO ===`);
      console.log(`Registros procesados: ${registrosProcesados}`);
      console.log(`Registros descartados: ${registrosDescartados}`);
      console.log(`Asuntos con datos: ${asuntosConDatos.length}`);
      console.log(`Semanas con datos: ${Array.from(semanasConDatos).sort().join(', ')}`);
      
      // Si no hay datos para las semanas seleccionadas
      if (asuntosConDatos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="100%" style="text-align: center; color: #999; padding: 20px;">
              üìä No hay datos para las semanas seleccionadas<br>
              <small>Semanas seleccionadas: ${semanasSeleccionadas.join(', ')}</small><br>
              <small>Registros procesados: ${registrosProcesados}, Descartados: ${registrosDescartados}</small>
            </td>
          </tr>
        `;
        return;
      }
      
      // Actualizar encabezados de la tabla
      const semanasOrdenadas = Array.from(semanasConDatos).sort((a, b) => a - b);
      headerRow.innerHTML = `
        <th style="min-width: 200px;">Asunto</th>
        ${semanasOrdenadas.map(semana => `<th class="semana-column">Sem ${semana}</th>`).join('')}
        <th style="min-width: 100px;">Total General</th>
        <th style="min-width: 80px;">Registros</th>
        <th style="min-width: 80px;">Estado</th>
      `;
      
      // Generar filas ordenadas alfab√©ticamente por asunto
      const filas = asuntosConDatos
        .sort((a, b) => a.asunto.localeCompare(b.asunto))
        .map(item => {
          const celdas = semanasOrdenadas.map(semana => {
            const datos = item.semanas[semana];
            if (!datos || datos.costo === 0) {
              return `<td class="semana-value number-cell" style="color: #666;">-</td>`;
            }
            
            const estado = datos.entregados > 0 ? '‚úÖ' : (datos.pendientes > 0 ? '‚è≥' : '‚ùì');
            return `<td class="semana-value number-cell" style="color: white; background: ${datos.costo > 0 ? 'rgba(39, 174, 96, 0.2)' : 'transparent'};" title="${datos.registros} registros, ${datos.entregados} entregados, ${datos.pendientes} pendientes">
              $${datos.costo.toFixed(2)}<br>
              <small style="color: #ccc;">${estado} ${datos.registros}</small>
            </td>`;
          }).join('');
          
          const porcentajeEntregados = item.registros > 0 ? (item.entregados / item.registros * 100).toFixed(1) : 0;
          const estadoGeneral = item.entregados === item.registros ? '‚úÖ Completo' : 
                              item.entregados > 0 ? `üîÑ ${porcentajeEntregados}%` : '‚è≥ Pendiente';
          
          return `
            <tr>
              <td style="font-weight: bold; color: #3498db;">${item.asunto}</td>
              ${celdas}
              <td class="number-cell" style="color: #27ae60; font-weight: bold; background: rgba(39, 174, 96, 0.3);">$${item.total.toFixed(2)}</td>
              <td class="number-cell" style="color: white; text-align: center;">${item.registros}</td>
              <td class="number-cell" style="color: white; text-align: center; font-size: 0.9em;">${estadoGeneral}</td>
            </tr>
          `;
        }).join('');
      
      // Agregar fila de totales por semana
      let filaTotales = '<tr style="border-top: 2px solid #3498db; background: rgba(52, 152, 219, 0.1);"><td style="font-weight: bold; color: #3498db;">TOTAL POR SEMANA</td>';
      let granTotal = 0;
      let totalRegistros = 0;
      let totalEntregados = 0;
      let totalPendientes = 0;
      
      semanasOrdenadas.forEach(semana => {
        const totalSemana = asuntosConDatos.reduce((sum, item) => sum + (item.semanas[semana]?.costo || 0), 0);
        const registrosSemana = asuntosConDatos.reduce((sum, item) => sum + (item.semanas[semana]?.registros || 0), 0);
        const entregadosSemana = asuntosConDatos.reduce((sum, item) => sum + (item.semanas[semana]?.entregados || 0), 0);
        const pendientesSemana = asuntosConDatos.reduce((sum, item) => sum + (item.semanas[semana]?.pendientes || 0), 0);
        
        granTotal += totalSemana;
        totalRegistros += registrosSemana;
        totalEntregados += entregadosSemana;
        totalPendientes += pendientesSemana;
        
        filaTotales += `<td class="number-cell" style="color: #e74c3c; font-weight: bold;" title="${registrosSemana} registros, ${entregadosSemana} entregados, ${pendientesSemana} pendientes">
          $${totalSemana.toFixed(2)}<br>
          <small style="color: #ccc;">${registrosSemana} reg</small>
        </td>`;
      });
      
      const porcentajeGeneralEntregados = totalRegistros > 0 ? (totalEntregados / totalRegistros * 100).toFixed(1) : 0;
      
      filaTotales += `
        <td class="number-cell" style="color: #e74c3c; font-weight: bold; font-size: 16px;">$${granTotal.toFixed(2)}</td>
        <td class="number-cell" style="color: #e74c3c; font-weight: bold;">${totalRegistros}</td>
        <td class="number-cell" style="color: #e74c3c; font-weight: bold; font-size: 0.9em;">${porcentajeGeneralEntregados}%</td>
      </tr>`;
      
      tbody.innerHTML = filas + filaTotales;
      
      // Mostrar mensaje de √©xito
      mostrarAlerta(`Tabla actualizada: ${asuntosConDatos.length} asuntos, ${semanasOrdenadas.length} semanas, $${granTotal.toFixed(2)} total`, 'success');
    }
    
    // Funci√≥n para obtener fecha local de Ciudad de M√©xico
    function getFechaLocalMexico() {
      const ahora = new Date();
      // Crear fecha en zona horaria de Ciudad de M√©xico (UTC-6 / UTC-5 seg√∫n horario de verano)
      const fechaMexico = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Mexico_City"}));
      
      // Formatear como YYYY-MM-DD para el input type="date"
      const a√±o = fechaMexico.getFullYear();
      const mes = String(fechaMexico.getMonth() + 1).padStart(2, '0');
      const dia = String(fechaMexico.getDate()).padStart(2, '0');
      
      return `${a√±o}-${mes}-${dia}`;
    }
    
    // Funci√≥n para obtener la fecha actual como objeto Date en zona horaria de Ciudad de M√©xico
    function getFechaActualMexico() {
      const ahora = new Date();
      return new Date(ahora.toLocaleString("en-US", {timeZone: "America/Mexico_City"}));
    }
    
    // Funci√≥n auxiliar mejorada para obtener n√∫mero de semana (ISO 8601)
    function getWeekNumber(date) {
      // Crear una copia de la fecha para evitar modificar la original
      const d = new Date(date.getTime());
      
      // Ajustar al jueves de esa semana (ISO 8601 est√°ndar)
      const dayOfWeek = d.getDay();
      const thursday = new Date(d.getTime());
      thursday.setDate(d.getDate() - dayOfWeek + 4); // Jueves de esa semana
      
      // Primer d√≠a del a√±o del jueves
      const yearStart = new Date(thursday.getFullYear(), 0, 1);
      
      // Calcular n√∫mero de semanas desde el inicio del a√±o
      const weekNumber = Math.ceil((((thursday - yearStart) / 86400000) + 1) / 7);
      
      // Asegurar que est√° en el rango v√°lido (1-52/53)
      const finalWeek = Math.max(1, Math.min(weekNumber, 53));
      
      // Debug temporal para investigar semanas inusuales
      if (finalWeek <= 10 || finalWeek >= 50) {
        console.log(`DEBUG Semana: Fecha: ${date.toISOString().split('T')[0]}, Semana: ${finalWeek}, A√±o: ${thursday.getFullYear()}`);
      }
      
      return finalWeek;
    }
    
    // Funciones para controlar la selecci√≥n de semanas
    function generarSelectorSemanas(datos) {
      console.log('=== GENERAR SELECTOR SEMANAS ===');
      console.log('Datos recibidos:', datos?.length || 0);
      
      const container = document.getElementById('semanas-selector');
      if (!container) {
        console.error('Contenedor semanas-selector no encontrado');
        return;
      }
      
      // Limpiar contenedor
      limpiarSelectorSemanas();
      
      if (!datos || datos.length === 0) {
        console.warn('No hay datos, inicializando selector b√°sico');
        setTimeout(() => inicializarSelectorBasico(), 100);
        return;
      }
      
      try {
        // Obtener semana actual
        const semanaActual = getWeekNumber(getFechaActualMexico());
        console.log('Semana actual:', semanaActual);
        
        // Procesar datos para encontrar semanas
        const semanasConDatos = new Set();
        let registrosProcesados = 0;
        
        datos.forEach((registro, index) => {
          try {
            const semanaRegistro = obtenerSemanaDeRegistro(registro);
            if (semanaRegistro >= 1 && semanaRegistro <= 53) {
              semanasConDatos.add(semanaRegistro);
              registrosProcesados++;
            }
          } catch (error) {
            console.warn(`Error procesando registro ${index}:`, error);
          }
        });
        
        const semanasArray = Array.from(semanasConDatos).sort((a, b) => a - b);
        console.log(`Encontradas ${semanasArray.length} semanas √∫nicas de ${registrosProcesados} registros:`, semanasArray);
        
        if (semanasArray.length === 0) {
          console.warn('No se encontraron semanas v√°lidas en los datos');
          setTimeout(() => inicializarSelectorBasico(), 100);
          return;
        }
        
        // Generar HTML del selector
        const semanaMin = Math.min(...semanasArray);
        const semanaMax = Math.max(...semanasArray);
        
        container.innerHTML = `
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
              <p style="margin: 0; color: var(--text-color); font-size: 14px; font-weight: 500;">
                üìÖ Semanas con datos: ${semanaMin} - ${semanaMax} (${semanasArray.length} semanas)
              </p>
              <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                <button class="button button-sm button-info" onclick="seleccionarRangoSemanas(${semanaMin}, ${semanaMax})" title="Seleccionar todas">Todas</button>
                <button class="button button-sm button-success" onclick="seleccionarTrimestre(1)" title="Q1 (1-13)">Q1</button>
                <button class="button button-sm button-success" onclick="seleccionarTrimestre(2)" title="Q2 (14-26)">Q2</button>
                <button class="button button-sm button-success" onclick="seleccionarTrimestre(3)" title="Q3 (27-39)">Q3</button>
                <button class="button button-sm button-success" onclick="seleccionarTrimestre(4)" title="Q4 (40-52)">Q4</button>
                <button class="button button-sm button-danger" onclick="deseleccionarTodasSemanas()" title="Deseleccionar">‚ùå</button>
              </div>
            </div>
          </div>
          <div class="semanas-grid" style="display: grid; grid-template-columns: repeat(8, minmax(80px, 1fr)); gap: 8px; max-height: 250px; overflow-y: auto; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
            ${semanasArray.map(semana => {
              const isSelected = semana >= semanaActual - 1 && semana <= semanaActual;
              return `
                <div class="semana-checkbox" style="display: flex; align-items: center; padding: 6px; border-radius: 4px; background: ${isSelected ? 'rgba(52,152,219,0.3)' : 'rgba(255,255,255,0.1)'}; transition: all 0.2s ease;">
                  <input type="checkbox" id="semana-${semana}" value="${semana}" ${isSelected ? 'checked' : ''} onchange="actualizarTablaDepartamentoAsuntos();" style="margin-right: 8px;">
                  <label for="semana-${semana}" style="font-size: 13px; cursor: pointer; color: var(--text-color); font-weight: ${isSelected ? 'bold' : 'normal'};">S${semana}</label>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        console.log('‚úÖ Selector de semanas generado exitosamente');
        
      } catch (error) {
        console.error('Error al generar selector de semanas:', error);
        setTimeout(() => inicializarSelectorBasico(), 100);
      }
    }
    
    function seleccionarSemanaActualYAnterior() {
      const semanaActual = obtenerSemanaActual();
      const semanaAnterior = semanaActual - 1;
      
      document.querySelectorAll('.semana-checkbox input[type="checkbox"]').forEach(checkbox => {
        const semana = parseInt(checkbox.value);
        checkbox.checked = (semana === semanaActual || semana === semanaAnterior);
      });
      
      console.log(`Seleccionadas semanas ${semanaAnterior} y ${semanaActual}`);
      actualizarTablaDepartamentoAsuntos();
    }
    
    function seleccionarUltimas4Semanas() {
      const semanaActual = obtenerSemanaActual();
      const semanasSeleccionadas = [semanaActual, semanaActual - 1, semanaActual - 2, semanaActual - 3];
      
      document.querySelectorAll('.semana-checkbox input[type="checkbox"]').forEach(checkbox => {
        const semana = parseInt(checkbox.value);
        checkbox.checked = semanasSeleccionadas.includes(semana);
      });
      
      console.log(`Seleccionadas √∫ltimas 4 semanas: ${semanasSeleccionadas.join(', ')}`);
      actualizarTablaDepartamentoAsuntos();
    }
    
    function mostrarResumenSemanas() {
      const semanasSeleccionadas = Array.from(document.querySelectorAll('.semana-checkbox input:checked'))
        .map(input => parseInt(input.value))
        .sort((a, b) => a - b);
      
      if (semanasSeleccionadas.length === 0) {
        mostrarAlerta('No hay semanas seleccionadas', 'warning');
        return;
      }
      
      const resumen = `
        <div class="resumen-semanas">
          <h3>üìä Resumen de Semanas Seleccionadas</h3>
          <div class="info-item">
            <strong>Semanas seleccionadas:</strong> ${semanasSeleccionadas.join(', ')}
          </div>
          <div class="info-item">
            <strong>Rango:</strong> Semana ${Math.min(...semanasSeleccionadas)} - Semana ${Math.max(...semanasSeleccionadas)}
          </div>
          <div class="info-item">
            <strong>Total de semanas:</strong> ${semanasSeleccionadas.length}
          </div>
          <div class="info-item">
            <strong>L√≥gica de semanas:</strong>
            <ul>
              <li>Para registros <strong>Entregados</strong>: Se usa la semana de la fecha de entrega real (Columna T)</li>
              <li>Para registros <strong>Pendientes</strong>: Se usa la semana planeada (Columna Q)</li>
              <li>Si no hay datos v√°lidos, se usa la fecha de registro como fallback</li>
            </ul>
          </div>
        </div>
      `;
      
      manejarRegistros.mostrarModalCustom('Resumen de Semanas', resumen);
    }
    
    function seleccionarRangoSemanas(inicio, fin) {
      document.querySelectorAll('.semana-checkbox input[type="checkbox"]').forEach(checkbox => {
        const semana = parseInt(checkbox.value);
        checkbox.checked = (semana >= inicio && semana <= fin);
      });
      actualizarIndicadorSemanas();
      actualizarTablaDepartamentoAsuntos();
    }
    
    function seleccionarTrimestre(trimestre) {
      const checkboxes = document.querySelectorAll('.semana-checkbox input[type="checkbox"]');
      
      // Definir rangos de trimestres
      const trimestres = {
        1: { inicio: 1, fin: 13, nombre: "Primer trimestre" },
        2: { inicio: 14, fin: 26, nombre: "Segundo trimestre" },
        3: { inicio: 27, fin: 39, nombre: "Tercer trimestre" },
        4: { inicio: 40, fin: 52, nombre: "Cuarto trimestre" }
      };
      
      if (!trimestres[trimestre]) {
        console.error('Trimestre inv√°lido:', trimestre);
        return;
      }
      
      const { inicio, fin, nombre } = trimestres[trimestre];
      
      // Deseleccionar todas
      checkboxes.forEach(cb => cb.checked = false);
      
      // Seleccionar semanas del trimestre
      let semanasSeleccionadas = 0;
      checkboxes.forEach(checkbox => {
        const semana = parseInt(checkbox.value);
        if (semana >= inicio && semana <= fin) {
          checkbox.checked = true;
          semanasSeleccionadas++;
        }
      });
      
      actualizarIndicadorSemanas();
      console.log(`${nombre}: semanas ${inicio}-${fin}, ${semanasSeleccionadas} semanas seleccionadas`);
      mostrarAlerta(`${nombre} seleccionado: ${semanasSeleccionadas} semanas (${inicio}-${fin})`, 'success');
      actualizarTablaDepartamentoAsuntos();
    }
    
    function deseleccionarTodasSemanas() {
      document.querySelectorAll('.semana-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      actualizarIndicadorSemanas();
      actualizarTablaDepartamentoAsuntos();
    }
    
    function seleccionarTodasSemanas() {
      document.querySelectorAll('.semana-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
      });
      actualizarIndicadorSemanas();
      actualizarTablaDepartamentoAsuntos();
    }
    
    function actualizarTablaDepartamentoAsuntos() {
      // Obtener las semanas seleccionadas
      const semanasSeleccionadas = Array.from(document.querySelectorAll('.semana-checkbox input:checked'))
        .map(input => parseInt(input.value));
      
      if (semanasSeleccionadas.length === 0) {
        const tbody = document.getElementById('tbody-departamento-cliente');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #999; padding: 20px;">Seleccione al menos una semana para mostrar datos</td></tr>';
        }
        return;
      }
      
      console.log('Actualizando tabla con semanas seleccionadas:', semanasSeleccionadas);
      mostrarLoading(true, 'dashboard');
      
      // Obtener todos los datos y luego filtrar por semanas seleccionadas
      const filtros = {
        semana: '',
        colaborador: '',
        coordinador: '',
        cliente: '',
        estatus: '',
        hoja: 'DatosFormulario'
      };
      
      google.script.run
        .withSuccessHandler(data => {
          mostrarLoading(false);
          if (data && data.length > 0) {
            console.log(`Datos recibidos: ${data.length} registros totales`);
            // Filtrar por semanas seleccionadas en el frontend
            const datosFiltrados = data.filter(registro => {
              const semanaRegistro = obtenerSemanaDeRegistro(registro);
              return semanasSeleccionadas.includes(semanaRegistro);
            });
            console.log(`Datos filtrados: ${datosFiltrados.length} registros para semanas ${semanasSeleccionadas.join(', ')}`);
            generarTablaDepartamentoAsuntos(data); // Pasar todos los datos para que la funci√≥n haga su propio filtrado
          } else {
            const tbody = document.getElementById('tbody-departamento-cliente');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; color: #999; padding: 20px;">No hay datos disponibles</td></tr>';
            }
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error('Error al obtener datos:', error);
          mostrarAlerta('Error al cargar datos para la tabla: ' + error.message, 'error');
        })
        .buscarReg(JSON.stringify(filtros));
    }
    
    // Funci√≥n para inicializar la tabla de departamento-asuntos al cargar el dashboard
    function inicializarTablaDepartamentoAsuntos(datos) {
      // Generar el selector de semanas con los datos disponibles
      generarSelectorSemanas(datos);
      // Llamar a la funci√≥n que obtiene todos los datos para la tabla
      setTimeout(() => {
        actualizarTablaDepartamentoAsuntos();
      }, 500);
    }

    function generarTablaDepartamentoSemanal(datos) {
      const tbody = document.getElementById('tbody-tipo-solicitud');
      if (!tbody) {
        console.error('No se encontr√≥ el elemento tbody-tipo-solicitud');
        return;
      }
      
      const hoy = new Date();
      const semanaActual = getWeekNumber(hoy);
      const semanaAnterior = semanaActual - 1;
      
      console.log('Generando tabla departamento semanal. Datos:', datos.length);
      
      // Agrupar por departamento y semana
      const agrupado = {};
      datos.forEach(registro => {
        const departamento = registro.departamento || 'Sin departamento';
        if (!agrupado[departamento]) {
          agrupado[departamento] = {
            semanaAnterior: 0,
            semanaActual: 0
          };
        }
        
        const costo = parseFloat(registro.costoTotal) || 0;
        const semanaRegistro = obtenerSemanaDeRegistro(registro);
        
        if (semanaRegistro === semanaAnterior) {
          agrupado[departamento].semanaAnterior += costo;
        } else if (semanaRegistro === semanaActual) {
          agrupado[departamento].semanaActual += costo;
        }
      });
      
      // Generar filas
      const filas = Object.entries(agrupado).map(([departamento, valores]) => {
        const total = valores.semanaAnterior + valores.semanaActual;
        const tendencia = valores.semanaActual > valores.semanaAnterior ? 
          '<span class="trend-up">‚ÜóÔ∏è +' + ((valores.semanaActual - valores.semanaAnterior) / Math.max(valores.semanaAnterior, 1) * 100).toFixed(1) + '%</span>' :
          valores.semanaActual < valores.semanaAnterior ?
          '<span class="trend-down">‚ÜòÔ∏è -' + ((valores.semanaAnterior - valores.semanaActual) / Math.max(valores.semanaAnterior, 1) * 100).toFixed(1) + '%</span>' :
          '<span class="trend-stable">‚û°Ô∏è Estable</span>';
        
        return `
          <tr>
            <td>${departamento}</td>
            <td class="number-cell" style="color: white;">$${valores.semanaAnterior.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">$${valores.semanaActual.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">$${total.toFixed(2)}</td>
            <td>${tendencia}</td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = filas;
      console.log('Tabla departamento semanal generada con', Object.keys(agrupado).length, 'departamentos');
    }

    function generarTablaPendientesAsunto(datos) {
      const tbody = document.getElementById('tbody-pendientes-asunto');
      if (!tbody) {
        console.error('No se encontr√≥ el elemento tbody-pendientes-asunto');
        return;
      }
      
      const hoy = new Date();
      const semanaActual = getWeekNumber(hoy);
      const semanaAnterior = semanaActual - 1;
      
      console.log('Generando tabla pendientes por asunto. Datos:', datos.length);
      
      // Filtrar solo pendientes y agrupar por cliente y asunto
      const pendientes = datos.filter(registro => registro.estatus === 'Pendiente');
      const agrupado = {};
      
      pendientes.forEach(registro => {
        const key = `${registro.cliente || 'Sin cliente'}|${registro.asunto || 'Sin asunto'}`;
        if (!agrupado[key]) {
          agrupado[key] = {
            cliente: registro.cliente || 'Sin cliente',
            asunto: registro.asunto || 'Sin asunto',
            semanaAnterior: 0,
            semanaActual: 0
          };
        }
        
        const costo = parseFloat(registro.costoTotal) || 0;
        const semanaRegistro = obtenerSemanaDeRegistro(registro);
        
        if (semanaRegistro === semanaAnterior) {
          agrupado[key].semanaAnterior += costo;
        } else if (semanaRegistro === semanaActual) {
          agrupado[key].semanaActual += costo;
        }
      });
      
      // Generar filas
      const filas = Object.values(agrupado).map(item => {
        const total = item.semanaAnterior + item.semanaActual;
        return `
          <tr>
            <td>${item.cliente}</td>
            <td>${item.asunto}</td>
            <td class="number-cell" style="color: white;">$${item.semanaAnterior.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">$${item.semanaActual.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">$${total.toFixed(2)}</td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = filas;
      console.log('Tabla pendientes por asunto generada con', Object.keys(agrupado).length, 'asuntos');
    }

    function generarTablaRendimientoColaborador(datos) {
      const tbody = document.getElementById('tbody-rendimiento-colaborador');
      if (!tbody) {
        console.error('No se encontr√≥ el elemento tbody-rendimiento-colaborador');
        return;
      }
      
      console.log('Generando tabla rendimiento colaborador. Datos:', datos.length);
      
      // Agrupar por colaborador
      const agrupado = {};
      datos.forEach(registro => {
        const colaborador = registro.colaborador || 'Sin colaborador';
        if (!agrupado[colaborador]) {
          agrupado[colaborador] = {
            departamento: registro.departamento || 'Sin departamento',
            cantidadProductos: 0,
            totalCosto: 0
          };
        }
        agrupado[colaborador].cantidadProductos += parseFloat(registro.cantidad) || 0;
        agrupado[colaborador].totalCosto += parseFloat(registro.costoTotal) || 0;
      });
      
      // Calcular promedios para eficiencia
      const costos = Object.values(agrupado).map(item => item.totalCosto);
      const maxCosto = Math.max(...costos);
      
      // Generar filas
      const filas = Object.entries(agrupado).map(([colaborador, valores]) => {
        const promedioPorProducto = valores.cantidadProductos > 0 ? (valores.totalCosto / valores.cantidadProductos) : 0;
        const eficienciaPorcentaje = maxCosto > 0 ? (valores.totalCosto / maxCosto * 100) : 0;
        
        let eficienciaClase = 'efficiency-low';
        if (eficienciaPorcentaje > 70) eficienciaClase = 'efficiency-high';
        else if (eficienciaPorcentaje > 40) eficienciaClase = 'efficiency-medium';
        
        return `
          <tr>
            <td>${colaborador}</td>
            <td>${valores.departamento}</td>
            <td class="number-cell" style="color: white;">${formatearCantidad(valores.cantidadProductos)}</td>
            <td class="number-cell" style="color: white;">$${valores.totalCosto.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">$${promedioPorProducto.toFixed(2)}</td>
            <td>
              <div class="efficiency-bar">
                <div class="efficiency-fill ${eficienciaClase}" style="width: ${eficienciaPorcentaje}%"></div>
              </div>
              <small style="color: white;">${eficienciaPorcentaje.toFixed(1)}%</small>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = filas;
      console.log('Tabla rendimiento colaborador generada con', Object.keys(agrupado).length, 'colaboradores');
    }

    function generarTablaEstadoClientes(datos) {
      const tbody = document.getElementById('tbody-estado-proyectos');
      if (!tbody) {
        console.error('No se encontr√≥ el elemento tbody-estado-proyectos');
        return;
      }
      
      console.log('Generando tabla estado clientes. Datos:', datos.length);
      
      // Agrupar por cliente y estatus
      const agrupado = {};
      const totalCostoGeneral = datos.reduce((sum, registro) => sum + (parseFloat(registro.costoTotal) || 0), 0);
      
      datos.forEach(registro => {
        const key = `${registro.cliente || 'Sin cliente'}|${registro.estatus || 'Sin estatus'}`;
        if (!agrupado[key]) {
          agrupado[key] = {
            cliente: registro.cliente || 'Sin cliente',
            estatus: registro.estatus || 'Sin estatus',
            cantidad: 0,
            costoTotal: 0
          };
        }
        agrupado[key].cantidad += 1;
        agrupado[key].costoTotal += parseFloat(registro.costoTotal) || 0;
      });
      
      // Generar filas
      const filas = Object.values(agrupado).map(item => {
        const porcentaje = totalCostoGeneral > 0 ? (item.costoTotal / totalCostoGeneral * 100) : 0;
        return `
          <tr>
            <td>${item.cliente}</td>
            <td>${item.estatus}</td>
            <td class="number-cell" style="color: white;">${item.cantidad}</td>
            <td class="number-cell" style="color: white;">$${item.costoTotal.toFixed(2)}</td>
            <td class="number-cell" style="color: white;">${porcentaje.toFixed(1)}%</td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = filas;
      console.log('Tabla estado clientes generada con', Object.keys(agrupado).length, 'combinaciones cliente-estatus');
    }

    // Funci√≥n para exportar dashboard
    function exportarDashboardCSV() {
      // Verificar que hay datos para exportar
      if (!registrosTemporales || registrosTemporales.length === 0) {
        console.warn('No hay datos en registrosTemporales para exportar CSV');
        mostrarAlerta('No hay datos cargados para exportar. Realice una b√∫squeda o recargue el dashboard primero.', 'warning');
        return;
      }
      
      console.log('Exportando CSV con', registrosTemporales.length, 'registros');
      exportarDatos('csv');
    }

    // Funciones espec√≠ficas de exportaci√≥n para Excel y PDF
    function exportarExcel() {
      // Verificar que hay datos para exportar
      if (!registrosTemporales || registrosTemporales.length === 0) {
        console.warn('No hay datos en registrosTemporales para exportar Excel');
        mostrarAlerta('No hay datos cargados para exportar. Realice una b√∫squeda o recargue el dashboard primero.', 'warning');
        return;
      }
      
      console.log('Exportando Excel con', registrosTemporales.length, 'registros');
      exportarDatos('excel');
    }

    // NUEVO: Exportar Dashboard filtrado a Excel usando Apps Script

    // Recolecta todos los datos del Dashboard para exportar
    function obtenerDatosCompletosDashboard() {
      // Tabla principal
      const tabla = Array.isArray(registrosDashboard) ? registrosDashboard : [];

      // Estad√≠sticas calculadas igual que en actualizarVistaPreviaDashboard
      const semanaActual = getWeekNumber(getFechaActualMexico());
      const semanaAnterior = semanaActual - 1;
      const obtenerSemanaRegistro = (registro) => {
        if (registro.fechaEntrega && registro.fechaEntrega.trim() !== '') {
          try {
            const fechaEntrega = new Date(registro.fechaEntrega);
            if (!isNaN(fechaEntrega.getTime())) {
              return getWeekNumber(fechaEntrega);
            }
          } catch (e) {}
        }
        if (registro.semana && !isNaN(parseInt(registro.semana))) {
          return parseInt(registro.semana);
        }
        if (registro.fecha && registro.fecha.trim() !== '') {
          try {
            const fechaRegistro = new Date(registro.fecha);
            if (!isNaN(fechaRegistro.getTime())) {
              return getWeekNumber(fechaRegistro);
            }
          } catch (e) {}
        }
        return semanaActual;
      };
      const registrosSemanaActualYAnterior = tabla.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual || semanaReg === semanaAnterior;
      });
      const registrosSemanaActual = tabla.filter(r => {
        const semanaReg = obtenerSemanaRegistro(r);
        return semanaReg === semanaActual;
      });
      const totalRegistros = registrosSemanaActualYAnterior.length;
      const pendientesActual = registrosSemanaActual.filter(r => r.estatus === 'Pendiente').length;
      const entregadosActualYAnterior = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Entregado').length;
      const costoEntregadosActual = registrosSemanaActual
        .filter(r => r.estatus === 'Entregado')
        .reduce((sum, r) => sum + (parseFloat(r.costoTotal) || 0), 0);
      const cancelados = registrosSemanaActualYAnterior.filter(r => r.estatus === 'Cancelado').length;
      // Clientes y departamentos resumen
      const clientesMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const cliente = registro.cliente || 'Sin cliente';
        if (!clientesMap[cliente]) clientesMap[cliente] = { count: 0, costo: 0 };
        clientesMap[cliente].count++;
        clientesMap[cliente].costo += parseFloat(registro.costoTotal) || 0;
      });
      const departamentosMap = {};
      registrosSemanaActualYAnterior.forEach(registro => {
        const depto = registro.departamento || 'Sin departamento';
        if (!departamentosMap[depto]) departamentosMap[depto] = { count: 0, costo: 0 };
        departamentosMap[depto].count++;
        departamentosMap[depto].costo += parseFloat(registro.costoTotal) || 0;
      });
      // Chart data: si tienes gr√°ficos, agrega aqu√≠ los datos, si no, deja vac√≠o
      const chartData = window.chartData || null;

      return {
        tabla,
        estadisticas: {
          totalRegistros,
          pendientesActual,
          entregadosActualYAnterior,
          costoEntregadosActual,
          cancelados,
          clientes: clientesMap,
          departamentos: departamentosMap,
          semanaActual,
          semanaAnterior
        },
        chartData
      };
    }

    // Exportar Dashboard completo a Excel
    function exportarDashboardExcelDesdeModal() {
      const dashboardCompleto = obtenerDatosCompletosDashboard();
      mostrarLoading(true, 'Exportando a Excel...');
      google.script.run.withSuccessHandler(function(res) {
        mostrarLoading(false);
        if (res && res.success && res.url) {
          window.open(res.url, '_blank');
        } else {
          mostrarAlerta(res && res.message ? res.message : 'Error al exportar a Excel', 'error');
        }
      }).exportarDashboardExcel(dashboardCompleto);
    }

    // Exportar Dashboard completo a PDF
    function exportarDashboardPDFDesdeModal() {
      const dashboardCompleto = obtenerDatosCompletosDashboard();
      mostrarLoading(true, 'Exportando a PDF...');
      google.script.run.withSuccessHandler(function(res) {
        mostrarLoading(false);
        if (res && res.success && res.url) {
          window.open(res.url, '_blank');
        } else {
          mostrarAlerta(res && res.message ? res.message : 'Error al exportar a PDF', 'error');
        }
      }).exportarDashboardPDF(dashboardCompleto);
    }

    function exportarPDF() {
      exportarDatos('pdf');
    }

    // Funci√≥n de debug para probar el backend
    function testExportBackend() {
      console.log('=== PROBANDO BACKEND DE EXPORTACI√ìN ===');
      mostrarLoading(true, 'Probando conexi√≥n con backend...');
      
      const testData = [
        { ID: 1, Fecha: '2025-06-26', Colaborador: 'Test', Departamento: 'Test', Cliente: 'Test', Asunto: 'Test', Estatus: 'Test', 'Costo Total': '100.00' }
      ];
      
      google.script.run
        .withSuccessHandler(result => {
          mostrarLoading(false);
          console.log('Resultado del test backend:', result);
          if (result && result.success) {
            mostrarAlerta(`‚úÖ Backend funcionando correctamente!\n\nDetalles:\n‚Ä¢ Formato: ${result.formato || 'CSV'}\n‚Ä¢ Archivo: ${result.filename || 'test.csv'}\n‚Ä¢ URL: ${result.url ? 'Generada' : 'No disponible'}`, 'success');
          } else {
            mostrarAlerta(`‚ùå Error en backend:\n${result?.message || 'Respuesta inv√°lida'}`, 'error');
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error('Error en test backend:', error);
          mostrarAlerta(`‚ùå Error de conexi√≥n con backend:\n${error.message}`, 'error');
        })
        .exportarDatos('{}', 'csv', {}, testData);
    }

    // Funci√≥n para validar procesamiento de columnas Q/T
    function validarProcesamientoColumnas() {
      console.log('=== VALIDACI√ìN DE COLUMNAS Q/T ===');
      
      if (registrosDashboard.length === 0) {
        mostrarAlerta('No hay datos cargados para validar. Cargue el dashboard primero.', 'warning');
        return;
      }
      
      mostrarLoading(true, 'Validando columnas Q/T...');
      
      const registrosProblematicos = [];
      const estadisticas = {
        total: registrosDashboard.length,
        conSemanaQ: 0,
        conFechaT: 0,
        entregadosConT: 0,
        entregadosSinT: 0,
        pendientesConQ: 0,
        problematicos: 0
      };
      
      registrosDashboard.forEach((registro, index) => {
        const semanaQ = registro.semana ? parseInt(registro.semana) : null;
        const fechaT = registro.fechaEntrega && registro.fechaEntrega.trim() !== '' ? registro.fechaEntrega : null;
        
        // Estad√≠sticas
        if (semanaQ && semanaQ >= 1 && semanaQ <= 53) estadisticas.conSemanaQ++;
        if (fechaT) estadisticas.conFechaT++;
        
        if (registro.estatus === 'Entregado') {
          if (fechaT) {
            estadisticas.entregadosConT++;
          } else {
            estadisticas.entregadosSinT++;
            registrosProblematicos.push({
              indice: index,
              id: registro.id,
              problema: 'Entregado sin fecha T',
              semanaQ,
              fechaT: null,
              estatus: registro.estatus
            });
          }
        } else if (registro.estatus === 'Pendiente') {
          if (semanaQ) {
            estadisticas.pendientesConQ++;
          } else {
            registrosProblematicos.push({
              indice: index,
              id: registro.id,
              problema: 'Pendiente sin semana Q',
              semanaQ: null,
              fechaT,
              estatus: registro.estatus
            });
          }
        }
      });
      
      estadisticas.problematicos = registrosProblematicos.length;
      
      setTimeout(() => {
        mostrarLoading(false);
        
        let mensaje = `üìä VALIDACI√ìN DE COLUMNAS Q/T COMPLETADA\n\n`;
        mensaje += `üìà Estad√≠sticas:\n`;
        mensaje += `‚Ä¢ Total de registros: ${estadisticas.total}\n`;
        mensaje += `‚Ä¢ Con semana Q v√°lida: ${estadisticas.conSemanaQ}\n`;
        mensaje += `‚Ä¢ Con fecha T v√°lida: ${estadisticas.conFechaT}\n`;
        mensaje += `‚Ä¢ Entregados con fecha T: ${estadisticas.entregadosConT}\n`;
        mensaje += `‚Ä¢ Entregados SIN fecha T: ${estadisticas.entregadosSinT}\n`;
        mensaje += `‚Ä¢ Pendientes con semana Q: ${estadisticas.pendientesConQ}\n`;
        mensaje += `‚Ä¢ Registros problem√°ticos: ${estadisticas.problematicos}\n\n`;
        
        if (estadisticas.problematicos > 0) {
          mensaje += `‚ö†Ô∏è PROBLEMAS ENCONTRADOS:\n`;
          registrosProblematicos.slice(0, 5).forEach(reg => {
            mensaje += `‚Ä¢ ID ${reg.id}: ${reg.problema}\n`;
          });
          if (registrosProblematicos.length > 5) {
            mensaje += `... y ${registrosProblematicos.length - 5} m√°s\n`;
          }
          mensaje += `\nüîß Revise la consola para ver todos los detalles.`;
          mostrarAlerta(mensaje, 'warning');
        } else {
          mensaje += `‚úÖ No se encontraron problemas en las columnas Q/T.`;
          mostrarAlerta(mensaje, 'success');
        }
        
        console.log('Registros problem√°ticos:', registrosProblematicos);
        console.log('Estad√≠sticas completas:', estadisticas);
      }, 1000);
    }

    // Funciones de modo maestro
    function toggleModoMaestro() {
      if (modoMaestroActivo) {
        desactivarModoMaestro();
      } else {
        activarModoMaestro();
      }
    }

    function activarModoMaestro() {
      mostrarModal('modalClaveMaestra');
    }

    function desactivarModoMaestro() {
      modoMaestroActivo = false;
      const btnModoMaestro = document.getElementById('btnModoMaestro');
      btnModoMaestro.textContent = 'üîê Modo Edici√≥n Maestra';
      btnModoMaestro.classList.remove('button-success');
      btnModoMaestro.classList.add('button-danger');
      manejarRegistros.actualizarTabla();
      mostrarAlerta('Modo maestro desactivado', 'info');
    }

    function verificarClaveMaestra() {
      const clave = document.getElementById('inputClaveMaestra').value;
      
      if (!clave) {
        mostrarAlerta('Por favor ingrese la clave maestra', 'warning');
        return;
      }
      
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(resultado => {
          mostrarLoading(false);
          if (resultado) {
            modoMaestroActivo = true;
            const btnModoMaestro = document.getElementById('btnModoMaestro');
            btnModoMaestro.textContent = 'üîì Modo Maestro Activo';
            btnModoMaestro.classList.remove('button-danger');
            btnModoMaestro.classList.add('button-success');
            ocultarModal('modalClaveMaestra');
            document.getElementById('inputClaveMaestra').value = '';
            manejarRegistros.actualizarTabla();
            mostrarAlerta('Modo maestro activado', 'success');
          } else {
            mostrarAlerta('Clave maestra incorrecta', 'error');
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error('Error al verificar clave:', error);
          mostrarAlerta('Error al verificar clave: ' + error.message, 'error');
        })
        .verificarClaveMaestra(clave);
    }

    function cancelarModoMaestra() {
      ocultarModal('modalClaveMaestra');
      document.getElementById('inputClaveMaestra').value = '';
    }

    // Funciones de administraci√≥n de registros
    function cancelarRegistro(id, fila) {
      if (!modoMaestroActivo) {
        mostrarAlerta('Necesitas activar el modo maestro para esta acci√≥n', 'warning');
        return;
      }
      
      if (confirm('¬øEst√°s seguro de marcar este registro como cancelado?')) {
        mostrarLoading(true);
        
        google.script.run
          .withSuccessHandler(exito => {
            mostrarLoading(false);
            if (exito) {
              fila.classList.add('cancelado');
              const registro = registrosTemporales.find(r => r.id === id);
              if (registro) {
                registro.estatus = 'Cancelado';
                registro.editado = true;
              }
              manejarRegistros.actualizarTabla();
              mostrarAlerta('Registro marcado como cancelado', 'success');
            } else {
              mostrarAlerta('Error al cancelar registro', 'error');
            }
          })
          .withFailureHandler(error => {
            mostrarLoading(false);
            console.error('Error al cancelar registro:', error);
            mostrarAlerta('Error al cancelar registro: ' + error.message, 'error');
          })
          .marcarRegistroComoCancelado(id);
      }
    }

    function eliminarRegistroPermanente(id) {
      if (!modoMaestroActivo) {
        mostrarAlerta('Necesitas activar el modo maestro para esta acci√≥n', 'warning');
        return;
      }
      
      if (confirm('¬øEst√°s seguro de eliminar permanentemente este registro? Esta acci√≥n no se puede deshacer.')) {
        mostrarLoading(true);
        
        google.script.run
          .withSuccessHandler(exito => {
            mostrarLoading(false);
            if (exito) {
              registrosTemporales = registrosTemporales.filter(r => r.id !== id);
              manejarRegistros.actualizarTabla();
              manejarRegistros.actualizarBotonesGuardado();
              mostrarAlerta('Registro eliminado permanentemente', 'success');
            } else {
              mostrarAlerta('Error al eliminar registro', 'error');
            }
          })
          .withFailureHandler(error => {
            mostrarLoading(false);
            console.error('Error al eliminar registro:', error);
            mostrarAlerta('Error al eliminar registro: ' + error.message, 'error');
          })
          .eliminarRegistroPermanente(id);
      }
    }

    function cancelarEntrega(id) {
      if (confirm('¬øEst√°s seguro de cancelar la entrega de este registro?')) {
        mostrarLoading(true);
        
        google.script.run
          .withSuccessHandler(resultado => {
            mostrarLoading(false);
            if (resultado.success) {
              const registro = registrosTemporales.find(r => r.id === id);
              if (registro) {
                registro.estatus = 'Pendiente';
                registro.fechaEntrega = null;
                registro.editado = true;
              }
              manejarRegistros.actualizarTabla();
              mostrarAlerta('Entrega cancelada exitosamente', 'success');
            } else {
              mostrarAlerta('Error al cancelar entrega: ' + resultado.message, 'error');
            }
          })
          .withFailureHandler(error => {
            mostrarLoading(false);
            console.error('Error al cancelar entrega:', error);
            mostrarAlerta('Error al cancelar entrega: ' + error.message, 'error');
          })
          .cancelarEntrega(id);
      }
    }

    // Funci√≥n para exportar CSV, Excel y PDF
    function exportarCSV() {
      exportarDatos('csv');
    }

    function exportarExcel() {
      exportarDatos('excel');
    }

    function exportarPDF() {
      exportarDatos('pdf');
    }

    function exportarDatos(formato) {
      // Verificar qu√© datos usar seg√∫n la secci√≥n activa
      const dashboardSection = document.getElementById('Dashboard-section');
      const isDashboardActive = dashboardSection && dashboardSection.style.display !== 'none';
      
      const datosParaExportar = isDashboardActive ? registrosDashboard : registrosTemporales;
      
      if (!datosParaExportar || datosParaExportar.length === 0) {
        mostrarAlerta('No hay datos para exportar. Realice una b√∫squeda o cargue datos primero.', 'warning');
        return;
      }
      
      console.log(`üöÄ Iniciando exportaci√≥n de ${datosParaExportar.length} registros en formato ${formato.toUpperCase()}`);
      mostrarLoading(true, `Exportando ${formato.toUpperCase()}...`);
      
      // Configuraci√≥n espec√≠fica por formato mejorada
      const configuraciones = {
        csv: { 
          encabezados: true, 
          separador: ',',
          charset: 'UTF-8'
        },
        excel: { 
          hojas: ['Datos'], 
          formatoFecha: 'dd/mm/yyyy',
          autoFiltro: true,
          formatoCeldas: true
        },
        pdf: { 
          orientacion: 'landscape', 
          margen: 20,
          incluirEstadisticas: true,
          titulo: 'Reporte de Registros'
        }
      };
      
      // Validar que google.script est√© disponible
      if (typeof google === 'undefined' || !google.script) {
        mostrarLoading(false);
        mostrarAlerta('‚ùå Error: No se puede conectar con Google Apps Script. Verifique su conexi√≥n.', 'error');
        return;
      }
      
      google.script.run
        .withSuccessHandler(resultado => {
          mostrarLoading(false);
          console.log('üì• Respuesta del servidor:', resultado);
          
          if (resultado && resultado.success) {
            if (resultado.url) {
              // Intento principal: descarga directa
              try {
                const link = document.createElement('a');
                link.href = resultado.url;
                link.download = resultado.filename || `datos_${new Date().toISOString().split('T')[0]}.${formato}`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarAlerta(`‚úÖ Archivo ${formato.toUpperCase()} generado exitosamente!\n\nüìÅ Archivo: ${resultado.filename}\nüîó URL: ${resultado.url.substring(0, 50)}...`, 'success');
              } catch (downloadError) {
                console.error('Error en descarga directa:', downloadError);
                // M√©todo alternativo: abrir en nueva ventana
                descargarArchivoAlternativo(resultado.url, resultado.filename, formato);
              }
            } else {
              mostrarAlerta(`‚úÖ Archivo ${formato.toUpperCase()} generado pero sin URL de descarga.\n\nRevis√© la configuraci√≥n del servidor.`, 'warning');
            }
          } else {
            const errorMsg = resultado?.message || resultado?.error || 'Error desconocido en el servidor';
            mostrarAlerta(`‚ùå Error al generar archivo ${formato.toUpperCase()}:\n\n${errorMsg}`, 'error');
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error(`‚ùå Error en exportaci√≥n ${formato}:`, error);
          
          let mensajeError = `Error de conexi√≥n al exportar ${formato.toUpperCase()}:\n\n`;
          if (error.message) {
            mensajeError += error.message;
          } else {
            mensajeError += 'Error de comunicaci√≥n con el servidor. Verifique:\n‚Ä¢ Conexi√≥n a internet\n‚Ä¢ Permisos de Google Apps Script\n‚Ä¢ Estado del servidor';
          }
          
          mostrarAlerta(mensajeError, 'error');
        })
        .exportarDatos('{}', formato, configuraciones[formato] || {}, datosParaExportar);
    }

    // Configuraciones espec√≠ficas para cada formato de exportaci√≥n
    const configuracionesExportacion = {
      csv: {
        extension: 'csv'
      },
      excel: {
        nombreHoja: 'Registros',
        encabezados: ['ID', 'Fecha', 'Colaborador', 'Departamento', 'Cliente', 'Asunto', 'L√≠der', 'Categor√≠a', 'Descripci√≥n', 'Observaciones', 'Cantidad', 'Tipo Solicitud', 'Nivel', 'Costo', 'Costo por Nivel', 'Costo Total', 'Estatus', 'Semana'],
        formatoCeldas: {
          'Costo': 'currency',
          'Costo por Nivel': 'currency',
          'Costo Total': 'currency',
          'Fecha': 'date'
        }
      },
      pdf: {
        titulo: 'Reporte de Registros',
        orientacion: 'landscape',
        tama√±oFuente: 8,
        incluirEstadisticas: true
      }
    };
    
    function mostrarModalCambioClave() {
      mostrarModal('modalCambioClave');
    }

    function cambiarClaveMaestra() {
      const claveActual = document.getElementById('claveActual').value;
      const nuevaClave = document.getElementById('nuevaClave').value;
      const confirmarClave = document.getElementById('confirmarClave').value;

      if (!claveActual || !nuevaClave || !confirmarClave) {
        mostrarAlerta('Por favor complete todos los campos', 'warning');
        return;
      }

      if (nuevaClave !== confirmarClave) {
        mostrarAlerta('Las nuevas claves no coinciden', 'error');
        return;
      }

      if (nuevaClave.length < 6) {
        mostrarAlerta('La nueva clave debe tener al menos 6 caracteres', 'warning');
        return;
      }

      mostrarLoading(true);

      google.script.run
        .withSuccessHandler(resultado => {
          mostrarLoading(false);
          if (resultado.exito) {
            ocultarModal('modalCambioClave');
            // Limpiar campos
            document.getElementById('claveActual').value = '';
            document.getElementById('nuevaClave').value = '';
            document.getElementById('confirmarClave').value = '';
            mostrarAlerta('Clave maestra cambiada exitosamente', 'success');
          } else {
            mostrarAlerta(resultado.mensaje, 'error');
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          mostrarAlerta('Error al cambiar clave: ' + error.message, 'error');
        })
        .cambiarClaveMaestra(claveActual, nuevaClave);
    }

    function realizarLogin() {
      const usuario = document.getElementById('login-usuario').value.trim();
      const password = document.getElementById('login-password').value.trim();

      if (!usuario || !password) {
        mostrarAlerta('Por favor ingrese usuario y contrase√±a', 'warning');
        return;
      }

      console.log('üîê Iniciando sesi√≥n para:', usuario);
      mostrarLoading(true, 'Verificando credenciales...');

      google.script.run
        .withSuccessHandler(procesarRespuestaLogin)
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error('‚ùå Error en login:', error);
          mostrarAlerta('Error al iniciar sesi√≥n: ' + error.message, 'error');
        })
        .iniciarSesion(usuario, password);
    }

    function procesarRespuestaLogin(respuesta) {
      mostrarLoading(false);

      if (respuesta.exito) {
        usuarioActual = respuesta.usuario;
        departamentoActual = respuesta.departamento;
        esAdmin = respuesta.esAdmin;
        esCoordinador = respuesta.esCoordinador;

        console.log('Login exitoso:', {usuarioActual, departamentoActual, esAdmin, esCoordinador});

        // Mostrar informaci√≥n del usuario con indicador de departamento
        const userInfo = document.getElementById('user-info');
        const rolLabel = esCoordinador ? '(ÔøΩ Coordinador)' : esAdmin ? '(ÔøΩ Administrador)' : '(üë• Usuario)';
        const deptoBadge = '<span style="background: var(--primary-color); padding: 4px 8px; border-radius: 15px; font-size: 0.9em; margin-left: 10px;">üè¢ ' + departamentoActual + '</span>';
        
        if (userInfo) {
          userInfo.innerHTML = 
            '<div style="display: flex; align-items: center; gap: 10px;">' +
              '<span style="font-weight: 500;">üë§ ' + usuarioActual + '</span>' +
              '<span style="opacity: 0.8;">' + rolLabel + '</span>' +
              deptoBadge +
            '</div>';
          userInfo.style.display = 'block';
        }
        
        // Ocultar pesta√±a flotante primero
        const floatingTab = document.getElementById('floatingTab');
        if (floatingTab) {
          floatingTab.style.setProperty('display', 'none', 'important');
        }
        
        // Ocultar secci√≥n de login y recuperaci√≥n
        const loginSection = document.getElementById('login-section');
        const recuperarSection = document.getElementById('recuperar-section');
        if (loginSection) {
          loginSection.style.display = 'none';
          loginSection.classList.remove('active-section');
        }
        if (recuperarSection) {
          recuperarSection.style.display = 'none';
          recuperarSection.classList.remove('active-section');
        }
        
        // Mostrar secci√≥n principal CORRECTAMENTE
        const mainSection = document.getElementById('main-section');
        if (mainSection) {
          mainSection.style.display = 'block';
          mainSection.classList.add('active-section');
        }
        
        // Inicializar aplicaci√≥n completa despu√©s del login
        console.log('Inicializando aplicaci√≥n completa...');
        inicializarAplicacionCompleta();
        
        // Esperar un momento y luego mostrar pesta√±a flotante y secci√≥n adecuada
        setTimeout(() => {
          console.log('Configurando UI despu√©s del login...');
          
          if (floatingTab) {
            floatingTab.style.setProperty('display', 'block', 'important');
          }
          
          // Controlar visibilidad seg√∫n rol con mejor UX
          const btnDashboard = document.getElementById('btnDashboard');
          const btnPlaneacion = document.getElementById('btnPlaneacion');
          const btnEntrega = document.getElementById('btnEntrega');
          
          console.log('Botones encontrados:', {
            dashboard: !!btnDashboard,
            planeacion: !!btnPlaneacion,
            entrega: !!btnEntrega
          });
          
          if (esAdmin) {
            console.log('Configurando vista para administrador...');
            // ADMINISTRATIVOS: Dashboard principal + acceso opcional a otras secciones
            if (btnDashboard) {
              btnDashboard.style.display = 'inline-block';
              btnDashboard.classList.add('active');
              btnDashboard.title = 'Vista principal para administradores';
            }
            if (btnPlaneacion) {
              btnPlaneacion.style.display = 'inline-block';
              btnPlaneacion.title = 'Ver planeaci√≥n de todos los departamentos';
            }
            if (btnEntrega) {
              btnEntrega.style.display = 'inline-block';
              btnEntrega.title = 'Ver entregas de todos los departamentos';
            }
            
            // Mostrar Dashboard para admin con carga r√°pida
            showSection('Dashboard');
            setTimeout(() => {
              console.log('üìä Configurando dashboard con carga r√°pida...');
              cargarDashboardRapido();
            }, 200);
          } else {
            console.log('Configurando vista para departamento...');
            // DEPARTAMENTOS: Planeaci√≥n principal + Dashboard y Entrega disponibles
            if (btnDashboard) {
              btnDashboard.style.display = 'inline-block';
              btnDashboard.title = `Dashboard del departamento ${departamentoActual}`;
            }
            if (btnPlaneacion) {
              btnPlaneacion.style.display = 'inline-block';
              btnPlaneacion.classList.add('active');
              btnPlaneacion.title = `Planeaci√≥n para ${departamentoActual}`;
            }
            if (btnEntrega) {
              btnEntrega.style.display = 'inline-block';
              btnEntrega.title = `Entrega para ${departamentoActual}`;
            }
            
            // Mostrar Planeaci√≥n para usuarios de departamento
            showSection('Planeacion');
          }
          
          // Debug: Verificar que la secci√≥n est√© visible
          const seccionActiva = esAdmin ? 
            document.getElementById('Dashboard-section') : 
            document.getElementById('Planeacion-section');
            
          if (seccionActiva) {
            console.log('Secci√≥n activa encontrada:', seccionActiva.id, seccionActiva.style.display);
            seccionActiva.style.display = 'block';
            seccionActiva.classList.add('active-section');
            
            // Si es Planeaci√≥n, asegurar que el formulario sea visible
            if (seccionActiva.id === 'Planeacion-section') {
              const mainForm = document.getElementById('mainForm');
              if (mainForm) {
                mainForm.style.display = 'block';
                console.log('Formulario principal visible');
              }
            }
          }
          
          // Establecer colaborador por defecto y mostrar info de permisos
          const selectColaborador = document.getElementById('colaborador');
          if (selectColaborador && usuarioActual) {
            setTimeout(() => {
              // Buscar la opci√≥n que coincida con el usuario actual
              const opciones = selectColaborador.options;
              for (let i = 0; i < opciones.length; i++) {
                if (opciones[i].value === usuarioActual) {
                  selectColaborador.value = usuarioActual;
                  // Disparar evento change para actualizar departamento
                  const evento = new Event('change');
                  selectColaborador.dispatchEvent(evento);
                  break;
                }
              }
            }, 1000);
          }
          
          // Mostrar informaci√≥n de permisos en el dashboard (comentado para optimizar carga)
          // mostrarInfoPermisos(); // Se carga solo cuando el usuario hace clic en el bot√≥n
          
          // Actualizar indicadores de departamento en las secciones
          actualizarIndicadoresDepartamento();
        }, 100);
        
        // Mostrar botones Debug y Test Backend solo para usuario AFGT
        const btnDebug = document.getElementById('btnDebug');
        const btnTestBackend = document.getElementById('btnTestBackend');
        const btnValidarColumnas = document.getElementById('btnValidarColumnas');
        const btnProbarDescarga = document.getElementById('btnProbarDescarga');
        const debugButtons = document.querySelector('.debug-buttons');
        
        if (usuarioActual === 'AFGT') {
          console.log('üë®‚Äçüíª Configurando modo debug para usuario AFGT...');
          
          // Mostrar contenedor de debug buttons
          if (debugButtons) {
            debugButtons.style.display = 'none'; // Oculto por defecto, pero disponible
          }
          
          // Mostrar botones individuales si existen fuera del contenedor
          if (btnDebug) btnDebug.style.display = 'inline-block';
          if (btnTestBackend) btnTestBackend.style.display = 'inline-block';
          if (btnValidarColumnas) btnValidarColumnas.style.display = 'inline-block';
          if (btnProbarDescarga) btnProbarDescarga.style.display = 'inline-block';
          
          // Crear bot√≥n toggle para mostrar/ocultar herramientas debug
          const debugToggle = document.createElement('button');
          debugToggle.innerHTML = 'üîß Mostrar Debug';
          debugToggle.className = 'button button-secondary';
          debugToggle.style.fontSize = '0.9em';
          debugToggle.title = 'Mostrar/ocultar herramientas de debug y diagn√≥stico';
          
          debugToggle.onclick = () => {
            const isHidden = debugButtons.style.display === 'none';
            if (debugButtons) {
              debugButtons.style.display = isHidden ? 'flex' : 'none';
            }
            debugToggle.innerHTML = isHidden ? 'üîß Ocultar Debug' : 'üîß Mostrar Debug';
            
            if (isHidden) {
              mostrarAlerta('üîß Herramientas de debug activadas. √ösalas con precauci√≥n.', 'info');
            }
          };
          
          // Insertar el bot√≥n toggle en el grupo de administraci√≥n
          const adminButtons = document.querySelector('.admin-buttons');
          if (adminButtons) {
            adminButtons.appendChild(debugToggle);
          }
          
          console.log('‚úÖ Modo debug configurado correctamente');
        } else {
          // Ocultar todos los botones de debug para usuarios normales
          if (debugButtons) debugButtons.style.display = 'none';
          if (btnDebug) btnDebug.style.display = 'none';
          if (btnTestBackend) btnTestBackend.style.display = 'none';
          if (btnValidarColumnas) btnValidarColumnas.style.display = 'none';
          if (btnProbarDescarga) btnProbarDescarga.style.display = 'none';
        }
        
        mostrarAlerta('Bienvenido ' + usuarioActual, 'success');
      } else {
        mostrarAlerta(respuesta.mensaje, 'error');
      }
    }

    function logout() {
      if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
        // Limpiar variables de sesi√≥n
        usuarioActual = null;
        departamentoActual = null;
        esAdmin = false;
        esCoordinador = false;
        modoMaestroActivo = false;
        registrosTemporales = [];
        registroEditando = null;
        
        // Ocultar pesta√±a flotante
        const floatingTab = document.getElementById('floatingTab');
        if (floatingTab) {
          floatingTab.style.setProperty('display', 'none', 'important');
        }
        
        // Ocultar todos los botones de navegaci√≥n
        const btnDashboard = document.getElementById('btnDashboard');
        const btnPlaneacion = document.getElementById('btnPlaneacion');
        const btnEntrega = document.getElementById('btnEntrega');
        
        if (btnDashboard) btnDashboard.style.display = 'none';
        if (btnPlaneacion) btnPlaneacion.style.display = 'none';
        if (btnEntrega) btnEntrega.style.display = 'none';
        
        // Limpiar informaci√≥n de usuario
        const userInfo = document.getElementById('user-info');
        if (userInfo) {
          userInfo.innerHTML = '';
        }
        
        // Ocultar main-section y todas las subsecciones
        const mainSection = document.getElementById('main-section');
        if (mainSection) {
          mainSection.style.display = 'none';
          mainSection.classList.remove('active-section');
        }
        
        const subsections = ['Dashboard-section', 'Planeacion-section'];
        subsections.forEach(secId => {
          const sec = document.getElementById(secId);
          if (sec) {
            sec.style.display = 'none';
            sec.classList.remove('active-section');
          }
        });
        
        // Cerrar vista previa si est√° abierta
        ocultarVistaPrevia();
        
        // Limpiar formularios
        document.getElementById('login-usuario').value = '';
        document.getElementById('login-password').value = '';
        
        // Mostrar secci√≥n de login
        mostrarSeccion('login-section');
        mostrarAlerta('Sesi√≥n cerrada correctamente', 'info');
      }
    }

    function mostrarRecuperarClave() {
      mostrarSeccion('recuperar-section');
    }

    function mostrarLogin() {
      mostrarSeccion('login-section');
    }

    function recuperarClave() {
      const email = document.getElementById('recuperar-email').value.trim();
      const claveMaestra = document.getElementById('recuperar-clave-maestra').value.trim();

      if (!email) {
        mostrarAlerta('Por favor ingrese su correo electr√≥nico', 'warning');
        return;
      }

      mostrarLoading(true);

      google.script.run
        .withSuccessHandler(respuesta => {
          mostrarLoading(false);
          mostrarAlerta(respuesta.mensaje, respuesta.exito ? 'success' : 'error');
          if (respuesta.exito) {
            mostrarLogin();
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          mostrarAlerta('Error al recuperar contrase√±a: ' + error.message, 'error');
        })
        .recuperarClave(email, claveMaestra);
    }

    // Gesti√≥n de temas
    function cargarTema() {
      const tema = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', tema);
    }


    // Inicializar tema al cargar la p√°gina
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon) {
        themeIcon.className = savedTheme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
      }
      
      console.log(`Tema inicializado: ${savedTheme}`);
    }

    // Gesti√≥n de secciones
    function mostrarSeccion(sectionId) {
      console.log(`mostrarSeccion llamada con: ${sectionId}`);
      
      // Ocultar todas las secciones principales
      const secciones = ['login-section', 'recuperar-section', 'main-section'];
      secciones.forEach(secId => {
        const sec = document.getElementById(secId);
        if (sec) {
          sec.classList.remove('active-section');
          sec.style.display = 'none';
          console.log(`Ocultando secci√≥n principal: ${secId}`);
        }
      });
      
      // Mostrar la secci√≥n solicitada
      const seccion = document.getElementById(sectionId);
      if (seccion) {
        seccion.classList.add('active-section');
        seccion.style.display = 'block';
        console.log(`Mostrando secci√≥n principal: ${sectionId}`);
      }
      
      // Ocultar pesta√±a flotante si estamos en login o recuperar
      const floatingTab = document.getElementById('floatingTab');
      if (floatingTab) {
        if (sectionId === 'login-section' || sectionId === 'recuperar-section') {
          floatingTab.style.setProperty('display', 'none', 'important');
        } else {
          floatingTab.style.setProperty('display', 'block', 'important');
        }
      }
    }

    function showSection(sectionId) {
      console.log(`Intentando mostrar secci√≥n: ${sectionId}`);
      
      // Asegurar que main-section est√© visible
      const mainSection = document.getElementById('main-section');
      if (!mainSection) {
        console.error('main-section no encontrada');
        return;
      }
      
      // Asegurar que login y recuperar est√©n ocultas
      const loginSection = document.getElementById('login-section');
      const recuperarSection = document.getElementById('recuperar-section');
      if (loginSection) {
        loginSection.style.display = 'none';
        loginSection.classList.remove('active-section');
      }
      if (recuperarSection) {
        recuperarSection.style.display = 'none';
        recuperarSection.classList.remove('active-section');
      }
      
      // Mostrar main-section
      mainSection.style.display = 'block';
      mainSection.classList.add('active-section');
      
      console.log('main-section encontrada, ocultando subsecciones...');
      
      // Ocultar todas las subsecciones dentro de main-section
      const subsections = ['Dashboard-section', 'Planeacion-section'];
      subsections.forEach(secId => {
        const sec = document.getElementById(secId);
        if (sec) {
          sec.style.display = 'none';
          sec.classList.remove('active-section');
          console.log(`Ocultando: ${secId}`);
        }
      });
      
      // Mostrar la secci√≥n espec√≠fica
      const targetSection = document.getElementById(`${sectionId}-section`);
      if (targetSection) {
        console.log(`Mostrando secci√≥n: ${targetSection.id}`);
        targetSection.style.display = 'block';
        targetSection.classList.add('active-section');
        
        // Asegurar que el contenido interno sea visible
        const form = targetSection.querySelector('form');
        if (form) {
          form.style.display = 'block';
          console.log('Formulario dentro de la secci√≥n mostrado');
        }
        
        // Actualizar botones activos en la navegaci√≥n con mejor feedback
        document.querySelectorAll('.section-nav button').forEach(btn => {
          btn.classList.remove('active');
          btn.style.background = ''; // Resetear estilo personalizado
          btn.style.transform = '';
        });
        
        const activeBtn = document.getElementById(`btn${sectionId}`);
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.style.background = 'var(--success-color)';
          activeBtn.style.transform = 'translateY(-2px)';
          activeBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
          console.log(`Bot√≥n ${sectionId} marcado como activo`);
        }
        
        // Mostrar mensaje de confirmaci√≥n de cambio de secci√≥n
        const sectionNames = {
          'Dashboard': 'üìä Dashboard de Administraci√≥n',
          'Planeacion': 'üìÖ Planeaci√≥n y Entrega'
        };
        
        if (sectionNames[sectionId]) {
          console.log(`Navegando a: ${sectionNames[sectionId]}`);
          // Solo mostrar alerta si no es la primera carga
          if (loginSection && loginSection.style.display === 'none') {
            mostrarAlerta(`Navegando a: ${sectionNames[sectionId]}`, 'info');
          }
          
          // Cargar datos espec√≠ficos seg√∫n la secci√≥n
          if (sectionId === 'Dashboard') {
            // Limpiar datos de planeaci√≥n al entrar al dashboard
            limpiarDatosPlaneacion();
            
            // Inicializar el selector de semanas inmediatamente
            console.log('Inicializando Dashboard - configurando selector de semanas...');
            setTimeout(() => {
              inicializarDashboard();
            }, 100);
            
            // Cargar datos del dashboard autom√°ticamente
            console.log('Cargando Dashboard - limpiando datos de planeaci√≥n');
            cargarDashboardAutomatico();
            
            // Ejecutar diagn√≥stico despu√©s de un peque√±o retraso
            setTimeout(() => {
              diagnosticarTablas();
            }, 2000);
          } else if (sectionId === 'Entrega' || sectionId === 'Planeacion') {
            // Limpiar datos del dashboard al entrar a planeaci√≥n
            limpiarDatosDashboard();
            console.log('Cargando Planeaci√≥n - limpiando datos de dashboard');
            
            // Para entrega y planeaci√≥n, asegurar que los selectores est√©n actualizados
            if (!document.getElementById('coordinador-busqueda').children.length > 1) {
              cargarDatosIniciales();
            }
            
            // Si es la secci√≥n de planeaci√≥n, configurar estado inicial
            if (sectionId === 'Planeacion') {
              setTimeout(() => {
                const colaboradorSelect = document.getElementById('colaborador');
                const switchElement = document.getElementById('switch-colaborador');
                
                if (colaboradorSelect && switchElement && usuarioActual) {
                  // Configurar estado inicial del switch (deshabilitado)
                  switchElement.checked = false;
                  colaboradorSelect.disabled = true;
                  colaboradorSelect.style.opacity = '0.7';
                  
                  const userOption = Array.from(colaboradorSelect.options).find(option => option.value === usuarioActual);
                  if (userOption) {
                    colaboradorSelect.value = usuarioActual;
                    console.log(`Usuario ${usuarioActual} seleccionado autom√°ticamente en planeaci√≥n`);
                    
                    // Disparar evento change para actualizar campos dependientes
                    const changeEvent = new Event('change', { bubbles: true });
                    colaboradorSelect.dispatchEvent(changeEvent);
                  }
                }
              }, 500); // Peque√±o delay para asegurar que los datos est√©n cargados
            }
          }
        }
      } else {
        console.error(`Secci√≥n no encontrada: ${sectionId}-section`);
      }
    }

    // Funci√≥n para actualizar el costo total autom√°ticamente
    function actualizarCostos() {
      try {
        // Si hay colaboradores agregados, usar funci√≥n especializada
        if (colaboradoresGeomatica.length > 0) {
          actualizarCostosGeomatica();
          return;
        }
        
        const tipo = document.getElementById('tipo_solicitud').value;
        const costoxnivelInput = document.getElementById('costoxnivel');
        const cantidadInput = document.getElementById('cantidad');
        
        // Parsear valores con manejo de errores
        const costoxnivel = parseFloat(costoxnivelInput.value) || 0;
        let cantidad = parseFloat(cantidadInput.value) || 0;
        
        // Actualizar campo de costo por nivel
        costoxnivelInput.value = costoxnivel.toFixed(2);
        
        // Definir multiplicadores
        const multiplicadores = {
          'Bomberazo': 2.3,
          'Urgente': 1.5,
          'Planeada': 1,
          '': 1
        };
        
        const multiplicador = multiplicadores[tipo] || 1;
        
        // Calcular costo total con precisi√≥n decimal
        const total = Math.round((cantidad * costoxnivel * multiplicador) * 100) / 100;
        
        // Actualizar campo de costo total
        const costoTotalInput = document.getElementById('costoTotal');
        costoTotalInput.value = total.toFixed(2);
        
        // Actualizar registro temporal si estamos en modo edici√≥n
        if (registroEditando) {
          registroEditando.costoxnivel = costoxnivel.toFixed(2);
          registroEditando.cantidad = cantidad;
          registroEditando.costoTotal = total.toFixed(2);
        }
      } catch (e) {
        console.error('Error en actualizarCostos:', e);
      }
    }

    // Configuraci√≥n de eventos
    function configurarEventListeners() {
      // Campos que pueden cambiar el costo por nivel
      const camposNivel = ['departamento', 'categoria', 'descripcion', 'nivel'];
      camposNivel.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
          if (id === 'departamento') {
            elemento.addEventListener('change', function() {
              const depto = this.value;
              if (depto) {
                // Actualizar categor√≠as
                actualizarCategorias(depto);
                // Limpiar y actualizar descripciones y niveles
                document.getElementById('descripcion').innerHTML = '<option value="">Seleccionar...</option>';
                document.getElementById('nivel').innerHTML = '<option value="">Seleccionar...</option>';
                // Si hay una categor√≠a seleccionada, cargar descripciones
                const categoria = document.getElementById('categoria').value;
                if (categoria) {
                  cargarDescripciones(depto, categoria).then(() => {
                    const descripcion = document.getElementById('descripcion').value;
                    if (descripcion) {
                      cargarNiveles(depto, categoria, descripcion);
                    }
                  });
                }
              }
              setTimeout(actualizarCostos, 300);
            });
          } else {
            elemento.addEventListener('change', function() {
              setTimeout(actualizarCostos, 300);
            });
          }
        }
      });

      // Configuraci√≥n existente de otros eventos
      const eventos = {
        'colaborador': () => {
          const selectElement = document.getElementById('colaborador');
          if (selectElement) {
            const depto = selectElement.selectedOptions[0]?.dataset?.depto;
            const deptoInput = document.getElementById('departamento');
            const deptoBadge = document.getElementById('departamento-badge');
            
            deptoInput.value = depto || '';
            
            // Mostrar badge visual si el departamento coincide con el del usuario
            if (deptoBadge) {
              if (depto && depto === departamentoActual) {
                deptoBadge.style.display = 'block';
                deptoBadge.textContent = 'TU DEPTO';
                deptoBadge.style.background = 'var(--success-color)';
              } else if (depto) {
                deptoBadge.style.display = 'block';
                deptoBadge.textContent = 'OTRO';
                deptoBadge.style.background = 'var(--warning-color)';
              } else {
                deptoBadge.style.display = 'none';
              }
            }
            
            if (depto) actualizarCategorias(depto);
          }
        },
        'cliente': () => cargarAsuntos(document.getElementById('cliente').value),
        'asunto': () => {
          const selected = document.getElementById('asunto').selectedOptions[0];
          if (selected) {
            document.getElementById('lider').value = selected.dataset.lider || '';
            document.getElementById('num-cliente').value = selected.dataset.numCliente || '';
            document.getElementById('num-asunto').value = selected.dataset.numAsunto || '';
          }
        },
        'categoria': () => {
          const depto = document.getElementById('departamento').value;
          if (depto) cargarDescripciones(depto, document.getElementById('categoria').value);
        },
        'descripcion': () => {
          const depto = document.getElementById('departamento').value;
          const categoria = document.getElementById('categoria').value;
          if (depto && categoria) {
            cargarNiveles(depto, categoria, document.getElementById('descripcion').value);
            cargarCostoBase(depto, categoria, document.getElementById('descripcion').value);
          }
        },
        'nivel': () => {
          const depto = document.getElementById('departamento').value;
          const categoria = document.getElementById('categoria').value;
          const descripcion = document.getElementById('descripcion').value;
          const nivel = document.getElementById('nivel').value;
          if (depto && categoria && descripcion && nivel) {
            cargarCostoPorNivel(depto, categoria, descripcion, nivel);
          }
        }
      };

      Object.entries(eventos).forEach(([id, handler]) => {
        const elemento = document.getElementById(id);
        if (elemento) elemento.addEventListener('change', handler);
      });
      
      // Configurar el campo de cantidad para incrementos de 1
      document.getElementById('cantidad').addEventListener('input', function() {
        // Forzar n√∫mero entero a menos que tenga decimales
        if (this.value.indexOf('.') === -1) {
          this.value = this.value.replace(/[^0-9]/g, '');
        }
        actualizarCostos();
      });

      document.getElementById('cantidad').addEventListener('blur', function() {
        const value = this.value;
        if (value && value.indexOf('.') !== -1) {
          // Si tiene decimales, validar que sea un n√∫mero v√°lido
          const num = parseFloat(value);
          this.value = isNaN(num) ? '' : num;
        } else {
          // Si no tiene decimales, convertirlo a entero
          const num = parseInt(value, 10);
          this.value = isNaN(num) ? '' : num;
        }
        actualizarCostos();
      });

      // Configurar botones de guardado
      document.getElementById('btnGuardarNuevos').addEventListener('click', () => manejarRegistros.guardarNuevos());
      document.getElementById('btnGuardarEditados').addEventListener('click', () => manejarRegistros.guardarEditados());
      
      // Configurar botones de guardado para la secci√≥n de Planeaci√≥n
      const btnGuardarNuevosPlaneacion = document.getElementById('btnGuardarNuevosPlaneacion');
      const btnGuardarEditadosPlaneacion = document.getElementById('btnGuardarEditadosPlaneacion');
      const btnGuardarTemporalesPermanente = document.getElementById('btnGuardarTemporalesPermanente');
      
      if (btnGuardarNuevosPlaneacion) {
        btnGuardarNuevosPlaneacion.addEventListener('click', () => manejarRegistros.guardarNuevos());
      }
      if (btnGuardarEditadosPlaneacion) {
        btnGuardarEditadosPlaneacion.addEventListener('click', () => manejarRegistros.guardarEditados());
      }
      if (btnGuardarTemporalesPermanente) {
        btnGuardarTemporalesPermanente.addEventListener('click', () => manejarRegistros.guardarTemporalesPermanente());
      }
      
      // Configurar bot√≥n de b√∫squeda (ocultar por defecto para simplificar interfaz)
      const toggleBusquedaBtn = document.getElementById('toggleBusqueda');
      const contenedorBusqueda = document.getElementById('contenedorBusqueda');
      
      if (toggleBusquedaBtn && contenedorBusqueda) {
        // Ocultar b√∫squeda por defecto para simplificar interfaz
        contenedorBusqueda.style.display = 'none';
        toggleBusquedaBtn.textContent = 'üîç Mostrar B√∫squeda';
        
        toggleBusquedaBtn.addEventListener('click', function() {
          const estaOculto = contenedorBusqueda.style.display === 'none';
          contenedorBusqueda.style.display = estaOculto ? 'block' : 'none';
          this.textContent = estaOculto ? 'üîç Ocultar B√∫squeda' : 'üîç Mostrar B√∫squeda';
          
          // Mostrar alerta informativa la primera vez que se muestra
          if (estaOculto && !localStorage.getItem('busqueda_mostrada_planeacion')) {
            localStorage.setItem('busqueda_mostrada_planeacion', 'true');
            mostrarAlerta('üí° La b√∫squeda te permite filtrar registros existentes para visualizar o editar', 'info');
          }
        });
      }
    }

    // Carga de datos iniciales
    // Carga de datos iniciales OPTIMIZADA
    function cargarDatosIniciales() {
      console.log('üì• Iniciando carga de datos iniciales...');
      
      // Usar timeout m√°s corto para mostrar loading
      const loadingTimeout = setTimeout(() => {
        mostrarLoading(true, 'Cargando datos b√°sicos...');
      }, 100);
      
      google.script.run
        .withSuccessHandler(data => {
          clearTimeout(loadingTimeout);
          console.log('‚úÖ Datos iniciales recibidos:', {
            colaboradores: data.colaboradores?.length || 0,
            coordinadores: data.coordinadores?.length || 0,
            clientes: data.clientes?.length || 0
          });
          
          try {
            if (data.colaboradores && data.colaboradores.length > 0) {
              actualizarColaboradores(data.colaboradores);
            }
            if (data.coordinadores && data.coordinadores.length > 0) {
              actualizarCoordinadores(data.coordinadores);
            }
            if (data.clientes && data.clientes.length > 0) {
              actualizarClientes(data.clientes);
            }
            
            console.log('‚úÖ Datos iniciales procesados correctamente');
          } catch (error) {
            console.error('‚ùå Error al procesar datos:', error);
            mostrarAlerta('Error al procesar datos iniciales: ' + error.message, 'warning');
          }
          
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          clearTimeout(loadingTimeout);
          console.error('‚ùå Error al cargar datos iniciales:', error);
          mostrarLoading(false);
          mostrarAlerta('‚ö†Ô∏è Error al cargar datos iniciales. Puede continuar pero algunas funciones pueden estar limitadas.', 'warning');
        })
        .obtenerDatosIniciales();
    }

    function actualizarColaboradores(colaboradores) {
      const selects = document.querySelectorAll('#colaborador, #colaborador-busqueda, #colaborador-entrega');
      
      // Crear array √∫nico usando nombres completos y ordenado alfab√©ticamente
      const colaboradoresUnicos = [...new Set(colaboradores.map(c => c.nombreCompleto || c.nombre))].sort();
      
      selects.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Todos...</option>';
          colaboradoresUnicos.forEach(nombreCompleto => {
            const colab = colaboradores.find(c => (c.nombreCompleto || c.nombre) === nombreCompleto);
            const option = document.createElement('option');
            option.value = colab.nombre; // El value sigue siendo el usuario para la l√≥gica
            option.textContent = nombreCompleto; // Pero se muestra el nombre completo
            option.dataset.depto = colab.departamento;
            option.dataset.coordinador = colab.coordinador;
            select.appendChild(option);
          });
          
          // Autoseleccionar el usuario actual en el formulario de planeaci√≥n
          if (select.id === 'colaborador' && usuarioActual) {
            const switchElement = document.getElementById('switch-colaborador');
            
            // Configurar estado inicial del switch (deshabilitado)
            if (switchElement) {
              switchElement.checked = false;
              select.disabled = true;
              select.style.opacity = '0.7';
            }
            
            const userOption = Array.from(select.options).find(option => option.value === usuarioActual);
            if (userOption) {
              select.value = usuarioActual;
              console.log(`Usuario ${usuarioActual} seleccionado autom√°ticamente en formulario de planeaci√≥n`);
              
              // Disparar evento change para actualizar campos dependientes
              const changeEvent = new Event('change', { bubbles: true });
              select.dispatchEvent(changeEvent);
            }
          }
        }
      });
    }

    function actualizarCoordinadores(coordinadores) {
      console.log('Actualizando coordinadores:', coordinadores);
      const selects = document.querySelectorAll('#coordinador-busqueda, #coordinador-entrega');
      console.log(`Encontrados ${selects.length} selectores de coordinadores`);
      
      // Eliminar duplicados por nombre de usuario (por si acaso)
      const vistos = new Set();
      const coordinadoresUnicos = coordinadores.filter(coord => {
        const nombre = typeof coord === 'object' ? coord.nombre : coord;
        if (vistos.has(nombre)) return false;
        vistos.add(nombre);
        return true;
      });

      // Ordenar coordinadores alfab√©ticamente por nombre completo
      const coordinadoresOrdenados = coordinadoresUnicos.sort((a, b) => {
        const nombreA = a.nombreCompleto || a.nombre || a;
        const nombreB = b.nombreCompleto || b.nombre || b;
        return nombreA.localeCompare(nombreB);
      });

      selects.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Todos...</option>';
          coordinadoresOrdenados.forEach(coord => {
            const option = document.createElement('option');
            if (typeof coord === 'object' && coord.nombreCompleto) {
              option.value = coord.nombre;
              option.textContent = coord.nombreCompleto;
            } else {
              option.value = coord;
              option.textContent = coord;
            }
            select.appendChild(option);
          });
          console.log(`Coordinadores agregados al selector ${select.id}: ${coordinadoresOrdenados.length}`);
        }
      });
    }

    function actualizarClientes(clientes) {
      const selects = document.querySelectorAll('#cliente, #cliente-busqueda, #cliente-entrega');
      selects.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Todos...</option>';
          clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente;
            option.textContent = cliente;
            select.appendChild(option);
          });
        }
      });
    }

    // Funciones para m√∫ltiples colaboradores
    function agregarColaboradorGeomatica() {
      const colaborador = document.getElementById('colaborador').value;
      const cantidad = document.getElementById('cantidad').value;
      const departamento = document.getElementById('departamento').value;
      
      if (!colaborador || !cantidad || isNaN(cantidad) || cantidad <= 0) {
        mostrarAlerta('Por favor selecciona un colaborador y una cantidad v√°lida', 'warning');
        return;
      }
      
      // Verificar si el colaborador ya existe en la lista
      const colaboradorExistente = colaboradoresGeomatica.find(item => item.colaborador === colaborador);
      if (colaboradorExistente) {
        mostrarAlerta(`${colaborador} ya est√° en la lista`, 'warning');
        return;
      }
      
      // Calcular costo individual para este colaborador
      const costoxnivel = parseFloat(document.getElementById('costoxnivel').value) || 0;
      const tipoSolicitud = document.getElementById('tipo_solicitud').value;
      
      // Definir multiplicadores
      const multiplicadores = {
        'Bomberazo': 2.3,
        'Urgente': 1.5,
        'Planeada': 1,
        '': 1
      };
      
      const multiplicador = multiplicadores[tipoSolicitud] || 1;
      const costoIndividual = Math.round((parseFloat(cantidad) * costoxnivel * multiplicador) * 100) / 100;
      
      colaboradoresGeomatica.push({ 
        colaborador, 
        cantidad: parseFloat(cantidad),
        costoIndividual: costoIndividual
      });
      
      actualizarListaColaboradores();
      
      // Limpiar campos despu√©s de agregar
      document.getElementById('cantidad').value = '';
      
      // Actualizar costos totales
      actualizarCostosGeomatica();
      
      mostrarAlerta(`${colaborador} agregado con cantidad ${formatearCantidad(cantidad)} y costo $${costoIndividual.toFixed(2)}`, 'success');
    }

    function actualizarListaColaboradores() {
      const lista = document.getElementById('lista-colaboradores');
      lista.innerHTML = colaboradoresGeomatica.map((item, index) => `
        <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.1); border-radius: 5px;">
          <span style="flex-grow: 1;">
            <strong>${item.colaborador}</strong><br>
            <small>Cantidad: ${formatearCantidad(item.cantidad)} | Costo: $${item.costoIndividual ? item.costoIndividual.toFixed(2) : '0.00'}</small>
          </span>
          <button onclick="eliminarColaboradorGeomatica(${index})" style="background: var(--danger-color); color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer;">‚ùå</button>
        </li>
      `).join('');
      
      // Mostrar total de colaboradores, cantidad total y costo total
      if (colaboradoresGeomatica.length > 0) {
        const totalCantidad = colaboradoresGeomatica.reduce((sum, item) => sum + item.cantidad, 0);
        const totalCosto = colaboradoresGeomatica.reduce((sum, item) => sum + (item.costoIndividual || 0), 0);
        lista.innerHTML += `
          <li style="background: var(--primary-color); color: white; padding: 10px; margin-top: 10px; border-radius: 5px; font-weight: bold;">
            üìä Resumen: ${colaboradoresGeomatica.length} colaboradores<br>
            üì¶ Total unidades: ${formatearCantidad(totalCantidad)}<br>
            üí∞ Costo total: $${totalCosto.toFixed(2)}
          </li>
        `;
      }
    }

    function eliminarColaboradorGeomatica(index) {
      const colaboradorEliminado = colaboradoresGeomatica[index];
      colaboradoresGeomatica.splice(index, 1);
      actualizarListaColaboradores();
      actualizarCostosGeomatica();
      mostrarAlerta(`${colaboradorEliminado.colaborador} eliminado de la lista`, 'info');
    }

    // Nueva funci√≥n para calcular costos espec√≠ficamente para m√∫ltiples colaboradores
    function actualizarCostosGeomatica() {
      try {
        const tipo = document.getElementById('tipo_solicitud').value;
        const costoxnivelInput = document.getElementById('costoxnivel');
        const costoTotalInput = document.getElementById('costoTotal');
        
        // Obtener costo por nivel
        const costoxnivel = parseFloat(costoxnivelInput.value) || 0;
        
        // Definir multiplicadores
        const multiplicadores = {
          'Bomberazo': 2.3,
          'Urgente': 1.5,
          'Planeada': 1,
          '': 1
        };
        
        const multiplicador = multiplicadores[tipo] || 1;
        
        let costoTotal = 0;
        
        if (colaboradoresGeomatica.length > 0) {
          // Recalcular costos individuales por si cambi√≥ el tipo de solicitud
          colaboradoresGeomatica.forEach(item => {
            item.costoIndividual = Math.round((item.cantidad * costoxnivel * multiplicador) * 100) / 100;
          });
          
          // Calcular costo total sumando todos los costos individuales
          costoTotal = colaboradoresGeomatica.reduce((sum, item) => sum + item.costoIndividual, 0);
          
          console.log(`C√°lculo m√∫ltiples colaboradores: ${colaboradoresGeomatica.length} colaboradores, costo unitario: ${costoxnivel}, multiplicador: ${multiplicador}, total: ${costoTotal}`);
          
          // Actualizar lista visual con nuevos costos
          actualizarListaColaboradores();
        } else {
          // Si no hay colaboradores agregados, usar cantidad normal
          const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
          costoTotal = Math.round((cantidad * costoxnivel * multiplicador) * 100) / 100;
        }
        
        // Actualizar campo de costo total
        costoTotalInput.value = costoTotal.toFixed(2);
        
        // Actualizar registro temporal si estamos en modo edici√≥n
        if (registroEditando) {
          registroEditando.costoxnivel = costoxnivel.toFixed(2);
          registroEditando.costoTotal = costoTotal.toFixed(2);
        }
        
      } catch (e) {
        console.error('Error en actualizarCostosGeomatica:', e);
      }
    }

    // Funciones para listas desplegables dependientes
    function cargarAsuntos(cliente) {
      if (!cliente) return;
      
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(data => {
          const select = document.getElementById('asunto');
          select.innerHTML = '<option value="">Seleccionar...</option>';
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.asunto;
            option.textContent = item.asunto;
            option.dataset.lider = item.lider;
            option.dataset.numCliente = item.numCliente;
            option.dataset.numAsunto = item.numAsunto;
            select.appendChild(option);
          });
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          console.error('Error al cargar asuntos:', error);
          mostrarLoading(false);
          mostrarAlerta('Error al cargar asuntos', 'error');
        })
        .obtenerAsuntosYLider(cliente);
    }

    function actualizarCategorias(depto) {
      if (!depto) return;
      
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(data => {
          const select = document.getElementById('categoria');
          select.innerHTML = '<option value="">Seleccionar...</option>';
          
          // Ordenar categor√≠as alfab√©ticamente y eliminar duplicados
          const categoriasUnicas = [...new Set(data)].sort();
          
          categoriasUnicas.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
          });
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          console.error('Error al cargar categor√≠as:', error);
          mostrarLoading(false);
          mostrarAlerta('Error al cargar categor√≠as', 'error');
        })
        .obtenerCategorias(depto);
    }

    function cargarDescripciones(depto, categoria) {
      if (!depto || !categoria) return Promise.resolve();
      
      mostrarLoading(true);
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(data => {
            const select = document.getElementById('descripcion');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            // Ordenar descripciones alfab√©ticamente y eliminar duplicados
            const descripcionesUnicas = [...new Set(data.map(item => item.descripcion))].sort();
            
            descripcionesUnicas.forEach(desc => {
              const option = document.createElement('option');
              option.value = desc;
              option.textContent = desc;
              select.appendChild(option);
            });
            mostrarLoading(false);
            resolve();
          })
          .withFailureHandler(error => {
            console.error('Error al cargar descripciones:', error);
            mostrarLoading(false);
            mostrarAlerta('Error al cargar descripciones', 'error');
            reject(error);
          })
          .obtenerDescripciones(depto, categoria);
      });
    }

    function cargarNiveles(depto, categoria, descripcion) {
      if (!depto || !categoria || !descripcion) return Promise.resolve();
      
      mostrarLoading(true);
      
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(data => {
            const select = document.getElementById('nivel');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            data.forEach(item => {
              const option = document.createElement('option');
              option.value = item.nivel;
              option.textContent = item.nivel;
              select.appendChild(option);
            });
            mostrarLoading(false);
            resolve();
          })
          .withFailureHandler(error => {
            console.error('Error al cargar niveles:', error);
            mostrarLoading(false);
            mostrarAlerta('Error al cargar niveles', 'error');
            reject(error);
          })
          .obtenerNiveles(depto, categoria, descripcion);
      });
    }

    function cargarCostoBase(depto, categoria, descripcion) {
      if (!depto || !categoria || !descripcion) return;
      
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(costo => {
          document.getElementById('costo').value = costo.toFixed(2);
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          console.error('Error al cargar costo base:', error);
          document.getElementById('costo').value = '';
          mostrarLoading(false);
          mostrarAlerta('Error al cargar costo base', 'error');
        })
        .obtenerCostoBase(depto, categoria, descripcion);
    }

    function cargarCostoPorNivel(depto, categoria, descripcion, nivel) {
      if (!depto || !categoria || !descripcion || !nivel) return;
      
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(costo => {
          const costoFormateado = parseFloat(costo).toFixed(2);
          document.getElementById('costoxnivel').value = costoFormateado;
          setTimeout(actualizarCostos, 300);
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          console.error('Error al cargar costo por nivel:', error);
          document.getElementById('costoxnivel').value = '';
          actualizarCostos();
          mostrarLoading(false);
          mostrarAlerta('Error al cargar costo por nivel', 'error');
        })
        .obtenerCostoPorNivel(depto, categoria, descripcion, nivel);
    }

    // Objeto manejarRegistros
    const manejarRegistros = {
      agregar() {
        const departamento = document.getElementById('departamento').value;
        const registros = [];
        
        if (colaboradoresGeomatica.length > 0) {
          // Crear un registro individual para cada colaborador con su costo espec√≠fico
          colaboradoresGeomatica.forEach(({ colaborador, cantidad, costoIndividual }) => {
            const registro = this.obtenerDatosFormulario();
            registro.colaborador = colaborador;
            registro.cantidad = cantidad;
            registro.costo = (parseFloat(document.getElementById('costo').value) || 0).toFixed(2);
            registro.costoxnivel = (parseFloat(document.getElementById('costoxnivel').value) || 0).toFixed(2);
            registro.costoTotal = costoIndividual.toFixed(2);
            registros.push(registro);
          });
        } else {
          registros.push(this.obtenerDatosFormulario());
        }

        registros.forEach(registro => {
          if (this.validar(registro)) {
            registrosTemporales.push(registro);
          }
        });

        this.actualizarTabla();
        this.limpiarFormulario();
        colaboradoresGeomatica = [];
        document.getElementById('lista-colaboradores').innerHTML = '';
        this.actualizarBotonesGuardado();
      },

      actualizar() {
        if (!registroEditando) return;
        
        const registroActualizado = this.obtenerDatosFormulario();
        
        if (this.validar(registroActualizado)) {
          // Mantener el ID y estatus del registro original
          registroActualizado.id = registroEditando.id;
          if (registroEditando.estatus === 'Entregado') {
            registroActualizado.estatus = 'Entregado';
          }
          
          // Actualizar el registro en el array
          const index = registrosTemporales.findIndex(r => r.id === registroEditando.id);
          if (index !== -1) {
            registrosTemporales[index] = {
              ...registrosTemporales[index],
              ...registroActualizado,
              editado: true
            };
          }
          
          this.actualizarTabla();
          this.limpiarFormulario();
          registroEditando = null;
          
          // Restaurar botones
          document.getElementById('btnAgregarRegistro').style.display = 'inline-block';
          document.getElementById('btnActualizarRegistro').style.display = 'none';
          document.getElementById('btnCancelarEdicion').style.display = 'none';
          
          mostrarAlerta('Registro actualizado correctamente', 'success');
          this.actualizarBotonesGuardado();
        }
      },

      obtenerDatosFormulario() {
        const tipo = document.getElementById('tipo_solicitud').value;
        const costoxnivel = parseFloat(document.getElementById('costoxnivel').value) || 0;
        const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
        
        const multiplicador = {
          'Bomberazo': 2.3,
          'Urgente': 1.5,
          'Planeada': 1
        }[tipo] || 1;
        
        const total = Math.round((cantidad * costoxnivel * multiplicador) * 100) / 100;
        
        // NO generar ID aqu√≠ - se genera en el backend al guardar
        let id = document.getElementById('registro-id').value || "";
        // Los IDs se generan autom√°ticamente en el backend cuando se guardan

        return {
            fecha: document.getElementById('fecha').value || new Date().toISOString().split('T')[0],
            colaborador: document.getElementById('colaborador').value,
            departamento: document.getElementById('departamento').value,
            cliente: document.getElementById('cliente').value,
            asunto: document.getElementById('asunto').value,
            lider: document.getElementById('lider').value,
            numCliente: document.getElementById('num-cliente').value || '',
            numAsunto: document.getElementById('num-asunto').value || '',
            categoria: document.getElementById('categoria').value,
            descripcion: document.getElementById('descripcion').value,
            observaciones: document.getElementById('observaciones').value,
            cantidad: cantidad,
            tipo_solicitud: tipo,
            nivel: document.getElementById('nivel').value,
            costo: (parseFloat(document.getElementById('costo').value) || 0).toFixed(2),
            costoxnivel: costoxnivel.toFixed(2),
            costoTotal: total.toFixed(2),
            estatus: document.getElementById('estatus').value,
            id: id,
            editado: false,
            esDecimal: cantidad > 0 && cantidad < 1,
            grupoDecimal: id && id.includes('.') ? id.split('.')[0] : null
          };
      },

      validar(registro) {
        if (!registro) {
          console.error('Validaci√≥n fall√≥: registro vac√≠o');
          return false;
        }
        
        console.log('Validando registro:', registro);
        
        const camposRequeridos = ['fecha', 'colaborador', 'cliente', 'asunto', 'departamento', 'categoria', 'descripcion', 'nivel', 'costoxnivel'];
        const camposFaltantes = camposRequeridos.filter(campo => {
          const valor = registro[campo];
          return !valor || valor.toString().trim() === '';
        });
        
        if (camposFaltantes.length > 0) {
          console.error('Campos faltantes:', camposFaltantes);
          mostrarAlerta(`Campos requeridos faltantes: ${camposFaltantes.join(", ")}\n\nVerifique que ha seleccionado todas las opciones necesarias.`, 'warning');
          return false;
        }
        
        if (isNaN(registro.cantidad) || registro.cantidad <= 0) {
          console.error('Cantidad inv√°lida:', registro.cantidad);
          mostrarAlerta('Cantidad debe ser un n√∫mero positivo', 'warning');
          return false;
        }
        
        if (isNaN(registro.costoxnivel) || registro.costoxnivel <= 0) {
          console.error('Costo por nivel inv√°lido:', registro.costoxnivel);
          mostrarAlerta('Costo por nivel debe ser un n√∫mero positivo.\n\nAseg√∫rese de que ha seleccionado Departamento ‚Üí Categor√≠a ‚Üí Descripci√≥n ‚Üí Nivel', 'warning');
          return false;
        }
        
        // Validaci√≥n especial para registros decimales
        if (registro.esDecimal && registro.grupoDecimal) {
          const registrosExistentes = registrosTemporales.filter(r => r.grupoDecimal === registro.grupoDecimal && r !== registro);
          const sumaExistente = registrosExistentes.reduce((sum, r) => sum + parseFloat(r.cantidad), 0);
          const nuevaSuma = sumaExistente + parseFloat(registro.cantidad);
          
          if (nuevaSuma > 1) {
            const maximoPermitido = 1 - sumaExistente;
            mostrarAlerta(`La suma de cantidades del grupo decimal no puede exceder 1.0. M√°ximo permitido: ${maximoPermitido.toFixed(2)}`, 'warning');
            return false;
          }
        }
        
        console.log('‚úÖ Registro validado correctamente');
        return true;
      },

      // Funci√≥n para duplicar registros decimales
      duplicarRegistroDecimal(registroIndex) {
        const registro = registrosTemporales[registroIndex];
        if (!registro || !registro.esDecimal) return;

        const grupoDecimal = registro.grupoDecimal;
        
        // Encontrar todos los registros del mismo grupo decimal
        const registrosGrupo = registrosTemporales.filter(r => r.grupoDecimal === grupoDecimal);
        const sumaActual = registrosGrupo.reduce((sum, r) => sum + parseFloat(r.cantidad), 0);
        
        // Nueva l√≥gica: permitir duplicar incluso cuando la suma es exactamente 1
        // pero preguntar al usuario si quiere continuar
        if (sumaActual >= 1) {
          const continuar = confirm(
            `La suma del grupo decimal ya es ${sumaActual.toFixed(2)}.\n\n` +
            `¬øDeseas crear un nuevo registro para continuar agregando m√°s cantidad?\n\n` +
            `Esto crear√° un nuevo grupo con ID base diferente.`
          );
          
          if (!continuar) {
            return;
          }
          
          // Crear un nuevo grupo con ID base diferente
          return this.crearContinuacionGrupoDecimal(registro);
        }
        
        // Encontrar el siguiente n√∫mero de secuencia
        let maxSecuencia = 0;
        registrosGrupo.forEach(r => {
          if (r.id && r.id.includes('.')) {
            const secuencia = parseInt(r.id.split('.')[1]);
            if (secuencia > maxSecuencia) {
              maxSecuencia = secuencia;
            }
          }
        });
        
        const nuevaSecuencia = maxSecuencia + 1;
        const nuevoId = `${grupoDecimal}.${nuevaSecuencia}`;
        
        // Calcular la cantidad m√°xima permitida para mantener suma <= 1
        const cantidadMaxima = Math.round((1 - sumaActual) * 100) / 100;
        const nuevaCantidad = Math.min(registro.cantidad, cantidadMaxima);
        
        // Crear el nuevo registro duplicado
        const registroDuplicado = {
          ...registro,
          id: nuevoId,
          cantidad: nuevaCantidad,
          costoTotal: (nuevaCantidad * parseFloat(registro.costoxnivel) * this.getMultiplicador(registro.tipo_solicitud)).toFixed(2),
          editado: false,
          esDecimal: true,
          grupoDecimal: grupoDecimal
        };
        
        registrosTemporales.push(registroDuplicado);
        
        this.actualizarTabla();
        this.actualizarBotonesGuardado();
        
        const nuevaSuma = sumaActual + nuevaCantidad;
        mostrarAlerta(`Registro duplicado creado con ID: ${nuevoId}. Suma actual del grupo: ${nuevaSuma.toFixed(2)}`, 'success');
        
        if (nuevaSuma >= 1) {
          mostrarAlerta('‚úì La suma del grupo decimal ha alcanzado 1.0', 'success');
        }
      },

      // Funci√≥n para obtener el multiplicador seg√∫n el tipo de solicitud
      getMultiplicador(tipo) {
        const multiplicadores = {
          'Bomberazo': 2.3,
          'Urgente': 1.5,
          'Planeada': 1
        };
        return multiplicadores[tipo] || 1;
      },

      // Funci√≥n para verificar la suma de un grupo decimal
      verificarSumaGrupoDecimal(grupoDecimal) {
        const registrosGrupo = registrosTemporales.filter(r => r.grupoDecimal === grupoDecimal);
        const suma = registrosGrupo.reduce((sum, r) => sum + parseFloat(r.cantidad), 0);
        return {
          suma: Math.round(suma * 100) / 100,
          registros: registrosGrupo,
          completo: suma >= 1
        };
      },

      // Funci√≥n para mostrar informaci√≥n del grupo decimal
      mostrarInfoGrupoDecimal(grupoDecimal) {
        const info = this.verificarSumaGrupoDecimal(grupoDecimal);
        const mensaje = `Grupo ${grupoDecimal}:\n` +
                       `- Registros: ${info.registros.length}\n` +
                       `- Suma actual: ${info.suma}\n` +
                       `- Restante: ${Math.max(0, 1 - info.suma).toFixed(2)}\n` +
                       `- Estado: ${info.completo ? 'Completo' : 'Incompleto'}`;
        
        mostrarAlerta(mensaje, info.completo ? 'success' : 'info');
      },

      // Funci√≥n para mostrar panel de gesti√≥n de grupos decimales
      mostrarPanelGrupoDecimal(grupoDecimal) {
        const info = this.verificarSumaGrupoDecimal(grupoDecimal);
        
        // Crear contenido del modal
        const contenido = `
          <div class="panel-grupo-decimal">
            <h3>Gesti√≥n del Grupo Decimal: ${grupoDecimal}</h3>
            <div class="info-grupo">
              <p><strong>Suma actual:</strong> ${info.suma}/1.0</p>
              <p><strong>Restante:</strong> ${Math.max(0, 1 - info.suma).toFixed(2)}</p>
              <p><strong>Registros:</strong> ${info.registros.length}</p>
              <p><strong>Estado:</strong> ${info.completo ? '‚úÖ Completo' : '‚ö†Ô∏è Incompleto'}</p>
            </div>
            <div class="registros-grupo">
              <h4>Registros del grupo:</h4>
              ${info.registros.map((reg, idx) => `
                <div class="registro-item">
                  <span><strong>ID:</strong> ${reg.id}</span>
                  <span><strong>Cantidad:</strong> ${reg.cantidad}</span>
                  <span><strong>Colaborador:</strong> ${reg.colaborador}</span>
                  <button onclick="editarCantidadDecimal('${reg.id}', ${idx})" class="btn-peque√±o">Editar Cantidad</button>
                </div>
              `).join('')}
            </div>
            ${!info.completo ? `
              <div class="acciones-grupo">
                <h4>Acciones disponibles:</h4>
                <p>Puedes duplicar cualquier registro para completar el grupo hasta 1.0</p>
                <p>Cantidad restante disponible: <strong>${Math.max(0, 1 - info.suma).toFixed(2)}</strong></p>
              </div>
            ` : `
              <div class="acciones-grupo info-continuacion">
                <h4>‚úÖ Grupo Completo</h4>
                <p>Este grupo decimal ha alcanzado la suma de 1.0</p>
                <p><strong>üí° Nueva funcionalidad:</strong> Puedes usar el bot√≥n "üìã Continuar" en cualquier registro para crear una continuaci√≥n con nuevo ID base</p>
                <p>Las continuaciones te permiten seguir agregando registros relacionados sin l√≠mite de cantidad</p>
              </div>
            `}
          </div>
        `;
        
        // Mostrar modal personalizado
        this.mostrarModalCustom('Gesti√≥n de Grupo Decimal', contenido);
      },

      // Funci√≥n para mostrar modal personalizado
      mostrarModalCustom(titulo, contenido) {
        // Remover modal existente si hay uno
        const modalExistente = document.getElementById('modal-custom');
        if (modalExistente) {
          modalExistente.remove();
        }
        
        // Crear nuevo modal
        const modal = document.createElement('div');
        modal.id = 'modal-custom';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>${titulo}</h2>
              <button class="modal-close" onclick="document.getElementById('modal-custom').remove()">√ó</button>
            </div>
            <div class="modal-body">
              ${contenido}
            </div>
            <div class="modal-footer">
              <button class="button button-secondary" onclick="document.getElementById('modal-custom').remove()">Cerrar</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      },

      actualizarTabla() {
        // Determinar qu√© secci√≥n est√° activa
        const planeacionSection = document.getElementById('Planeacion-section');
        const isPlaneacionActive = planeacionSection && planeacionSection.style.display !== 'none';
        
        let tbody;
        
        if (isPlaneacionActive) {
          // En la secci√≥n de planeaci√≥n, usar tanto la tabla de planeaci√≥n como la de entrega
          tbody = document.getElementById('tbodyPlaneacion') || document.getElementById('tablaDatos');
        } else {
          tbody = document.getElementById('tablaDatos');
        }
        
        if (!tbody) return;
        
        tbody.innerHTML = registrosTemporales.map((registro, index) => {
          let botones = '';
          // Bot√≥n Editar siempre disponible para todos los registros
          botones += `<button class="button button-warning" onclick="editarRegistro(${index})">‚úèÔ∏è Editar</button>`;
          // Bot√≥n Eliminar para registros nuevos (sin ID) y temporales
          if (!registro.id || registro.pendienteGuardar) {
            botones += `<button class="button button-danger" onclick="eliminarRegistro(${index})">üóëÔ∏è Eliminar</button>`;
          }
          // Bot√≥n especial para registros con ID decimal: 'Continuar' SOLO si pendiente y editable
          if (typeof registro.id === 'string' && /\d+\.\d+/.test(registro.id) && registro.estatus === 'Pendiente' && (tienePermisoEditar(registro) || modoMaestroActivo)) {
            if (!registro.grupoDecimal) {
              registro.grupoDecimal = registro.id.split('.')[0];
            }
            botones += `<button class="button button-info" onclick="continuarRegistroDecimal(${index})" title="Continuar registro decimal">Continuar</button>`;
          }
          // Bot√≥n para mostrar informaci√≥n del grupo y estado visual (para todos los decimales)
          if (typeof registro.id === 'string' && /\d+\.\d+/.test(registro.id)) {
            if (!registro.grupoDecimal) {
              registro.grupoDecimal = registro.id.split('.')[0];
            }
            const grupoInfo = this.verificarSumaGrupoDecimal(registro.grupoDecimal);
            botones += `<button class="button button-secondary" onclick="manejarRegistros.mostrarPanelGrupoDecimal('${registro.grupoDecimal}')" title="Ver panel de gesti√≥n del grupo decimal">üìä Panel</button>`;
            const estadoClase = grupoInfo.completo ? 'completo' : 'incompleto';
            botones += `<span class="grupo-decimal-estado ${estadoClase}" title="Suma del grupo: ${grupoInfo.suma}/1.0">${grupoInfo.suma.toFixed(2)}/1.0</span>`;
          }
          // Bot√≥n entregar: visible siempre que el estatus sea 'Pendiente' y tenga ID
          if (registro.id && registro.estatus === 'Pendiente') {
            botones += `<button class="button button-success" onclick="marcarComoEntregado(${index}, true)">‚úì Entregar</button>`;
          }
          // Bot√≥n cancelar entrega: solo modo maestro y estatus 'Entregado'
          if (registro.id && modoMaestroActivo && registro.estatus === 'Entregado') {
            botones += `<button class="button button-warning" onclick="cancelarEntrega('${registro.id}')">‚Ü© Cancelar Entrega</button>`;
          }
          // Botones de cancelar/eliminar permanente solo para modo maestro
          if (registro.id && modoMaestroActivo) {
            botones += `
              <button class="button button-danger" onclick="cancelarRegistro('${registro.id}', this.closest('tr'))">‚ùå Cancelar</button>
              <button class="button button-danger" onclick="eliminarRegistroPermanente('${registro.id}')">üóëÔ∏è Eliminar Permanente</button>
            `;
          }
          
          // Determinar clases CSS para la fila
          let clasesFila = '';
          if (registro.estatus === 'Cancelado') {
            clasesFila += 'cancelado';
          }
          if (registro.esDecimal) {
            clasesFila += (clasesFila ? ' ' : '') + 'registro-decimal';
            
            // Verificar si puede continuar (suma >= 1)
            const grupoInfo = this.verificarSumaGrupoDecimal(registro.grupoDecimal);
            if (grupoInfo.suma >= 1) {
              clasesFila += ' registro-continuable';
            }
          }
          
          return `
            <tr ${clasesFila ? `class="${clasesFila}"` : ''}>
              <td class="id-cell">${registro.id || ''}</td>
              <td>${registro.fecha}</td>
              <td>${registro.colaborador}</td>
              <td>${registro.departamento}</td>
              <td>${registro.cliente}</td>
              <td>${registro.asunto}</td>
              <td>${registro.lider}</td>
              <td>${registro.categoria}</td>
              <td>${registro.descripcion}</td>
              <td>${registro.observaciones}</td>
              <td>${(typeof registro.cantidad === 'number' && registro.cantidad > 0 && registro.cantidad < 1) ? (registro.cantidad * 100).toFixed(0) + '%' : registro.cantidad}</td>
              <td>${registro.tipo_solicitud}</td>
              <td>${registro.nivel}</td>
              <td class="costo-cell">${formatCurrency(registro.costo || '0')}</td>
              <td class="costo-cell">${formatCurrency(registro.costoxnivel || '0')}</td>
              <td class="costo-cell">${formatCurrency(registro.costoTotal || '0')}</td>
              <td>${registro.estatus} ${registro.editado ? '<span class="editado-badge">editado</span>' : ''}</td>
              <td>${registro.semana || (registro.fecha ? (parsearFechaDDMMYYYY(registro.fecha) ? getWeekNumber(parsearFechaDDMMYYYY(registro.fecha)) : '') : '')}</td>
              <td>${botones}</td>
            </tr>
          `;
        }).join('');
        
        // Aplicar formato ingl√©s a los n√∫meros en la tabla
        aplicarFormatoNumerosTablas();
      },

      limpiarFormulario() {
        // Guardar valores que se deben preservar
        const colaboradorActualForm = document.getElementById('colaborador').value;
        const departamentoActualForm = document.getElementById('departamento').value;
        const switchColaborador = document.getElementById('switch-colaborador');
        const colaboradorDisabled = document.getElementById('colaborador').disabled;
        
        // Resetear el formulario
        document.getElementById('mainForm').reset();
        
        // Limpiar campos espec√≠ficos
        ['lider', 'num-cliente', 'num-asunto', 'costo', 'costoxnivel', 'costoTotal'].forEach(id => {
          document.getElementById(id).value = '';
        });
        
        // Preservar usuario actual si estaba configurado autom√°ticamente
        if (usuarioActual && colaboradorActualForm === usuarioActual && colaboradorDisabled) {
          const colaboradorSelect = document.getElementById('colaborador');
          const departamentoSelect = document.getElementById('departamento');
          
          // Restaurar colaborador
          colaboradorSelect.value = usuarioActual;
          colaboradorSelect.disabled = true;
          colaboradorSelect.style.opacity = '0.7';
          
          // Restaurar switch
          if (switchColaborador) {
            switchColaborador.checked = false;
          }
          
          // Restaurar departamento si era autom√°tico (usando la variable global)
          if (departamentoActual && departamentoActualForm === departamentoActual) {
            departamentoSelect.value = departamentoActual;
            
            // Mostrar badge de departamento autom√°tico
            const departamentoBadge = document.getElementById('departamento-badge');
            if (departamentoBadge) {
              departamentoBadge.style.display = 'block';
              departamentoBadge.textContent = 'AUTO';
              departamentoBadge.title = `Departamento configurado autom√°ticamente: ${departamentoActual}`;
            }
            
            // Disparar eventos para actualizar campos dependientes
            const departamentoChangeEvent = new Event('change', { bubbles: true });
            departamentoSelect.dispatchEvent(departamentoChangeEvent);
          }
          
          // Disparar evento change en colaborador para actualizar campos dependientes
          const changeEvent = new Event('change', { bubbles: true });
          colaboradorSelect.dispatchEvent(changeEvent);
          
          console.log(`‚úÖ Usuario ${usuarioActual} y departamento preservados tras limpiar formulario`);
        } else {
          // Si no hay configuraci√≥n autom√°tica, limpiar tambi√©n departamento
          document.getElementById('departamento').value = '';
        }
        
        document.getElementById('registro-id').value = '';
        registroEditando = null;
        this.actualizarBotonesGuardado();
      },

      actualizarBotonesGuardado() {
        const nuevos = registrosTemporales.filter(reg => !reg.id).length;
        const editados = registrosTemporales.filter(reg => reg.id && reg.editado).length;
        const totalTemporales = registrosTemporales.length;
        
        // Determinar qu√© secci√≥n est√° activa
        const planeacionSection = document.getElementById('Planeacion-section');
        const isPlaneacionActive = planeacionSection && planeacionSection.style.display !== 'none';
        
        // Actualizar contadores y botones seg√∫n la secci√≥n activa
        if (isPlaneacionActive) {
          // Botones de la secci√≥n de Planeaci√≥n
          const contadorNuevosPlaneacion = document.getElementById('contadorNuevosPlaneacion');
          const contadorEditadosPlaneacion = document.getElementById('contadorEditadosPlaneacion');
          const contadorTemporalesPlaneacion = document.getElementById('contadorTemporalesPlaneacion');
          const btnGuardarNuevosPlaneacion = document.getElementById('btnGuardarNuevosPlaneacion');
          const btnGuardarEditadosPlaneacion = document.getElementById('btnGuardarEditadosPlaneacion');
          const btnGuardarTemporalesPermanente = document.getElementById('btnGuardarTemporalesPermanente');
          
          if (contadorNuevosPlaneacion) contadorNuevosPlaneacion.textContent = nuevos;
          if (contadorEditadosPlaneacion) contadorEditadosPlaneacion.textContent = editados;
          if (contadorTemporalesPlaneacion) contadorTemporalesPlaneacion.textContent = totalTemporales;
          
          if (btnGuardarNuevosPlaneacion) {
            btnGuardarNuevosPlaneacion.style.display = nuevos > 0 ? 'inline-block' : 'none';
          }
          if (btnGuardarEditadosPlaneacion) {
            btnGuardarEditadosPlaneacion.style.display = editados > 0 ? 'inline-block' : 'none';
          }
          if (btnGuardarTemporalesPermanente) {
            btnGuardarTemporalesPermanente.style.display = totalTemporales > 0 ? 'inline-block' : 'none';
          }
        } else {
          // Botones de la secci√≥n de Entrega
          const contadorNuevos = document.getElementById('contadorNuevos');
          const contadorEditados = document.getElementById('contadorEditados');
          const btnGuardarNuevos = document.getElementById('btnGuardarNuevos');
          const btnGuardarEditados = document.getElementById('btnGuardarEditados');
          
          if (contadorNuevos) contadorNuevos.textContent = nuevos;
          if (contadorEditados) contadorEditados.textContent = editados;
          
          if (btnGuardarNuevos) {
            btnGuardarNuevos.style.display = nuevos > 0 ? 'inline-block' : 'none';
          }
          if (btnGuardarEditados) {
            btnGuardarEditados.style.display = editados > 0 ? 'inline-block' : 'none';
          }
        }
      },

      // Funci√≥n para preparar los datos antes de enviar al backend
      prepararDatosParaGuardar(registros) {
        return registros.map(registro => {
          const cantidad = parseFloat(registro.cantidad) || 0;
          const esDecimal = cantidad > 0 && cantidad < 1;
          
          // Limpiar el ID del frontend si existe (dejar que el backend genere)
          const registroLimpio = { ...registro };
          if (!registroLimpio.id || registroLimpio.id.includes('timestamp')) {
            delete registroLimpio.id;
          }
          
          return {
            ...registroLimpio,
            cantidad: cantidad, // Asegurar que sea num√©rico
            esDecimal: esDecimal,
            requiereIdDecimal: esDecimal
          };
        });
      },

      guardarNuevos() {
        const nuevos = registrosTemporales.filter(reg => !reg.id);
        if (!nuevos.length) {
          mostrarAlerta('No hay registros nuevos para guardar', 'info');
          return;
        }
        if (confirm(`¬øGuardar ${nuevos.length} registro(s) nuevo(s)?`)) {
          mostrarLoading(true);
          const datosPreparados = this.prepararDatosParaGuardar(nuevos);
          console.log('Datos preparados para guardar (guardarNuevos):', datosPreparados);
          google.script.run
            .withSuccessHandler(res => {
              mostrarLoading(false);
              if (res.errors === 0) {
                registrosTemporales = registrosTemporales.filter(reg => reg.id);
                mostrarAlerta(`‚úÖ ${res.success} registros guardados.`, 'success');
              } else {
                let msg = `‚úÖ ${res.success} guardados | ‚ùå ${res.errors} errores`;
                if (res.detalles && res.detalles.length > 0) {
                  msg += '<br>Errores:<ul>';
                  res.detalles.forEach((detalle, i) => {
                    if (!detalle.success) {
                      msg += `<li>Registro ${i + 1}: ${detalle.message || 'Error desconocido'}</li>`;
                    }
                  });
                  msg += '</ul>';
                }
                mostrarAlerta(msg, 'warning');
              }
              this.actualizarTabla();
              this.actualizarBotonesGuardado();
            })
            .withFailureHandler(error => {
              mostrarLoading(false);
              console.error('Error al guardar:', error);
              mostrarAlerta('Error al guardar registros: ' + (error.message || error), 'error');
            })
            .guardarEnSheet(datosPreparados);
        }
      },

      guardarEditados() {
        const editados = registrosTemporales.filter(reg => reg.id && reg.editado);
        if (!editados.length) {
          mostrarAlerta('No hay registros editados para guardar', 'info');
          return;
        }
        // Asegurar que cada registro editado tenga el campo consecutivo igual a su id
        editados.forEach(reg => {
          reg.consecutivo = reg.id;
        });
        if (confirm(`¬øGuardar cambios en ${editados.length} registro(s)?`)) {
          mostrarLoading(true);
          google.script.run
            .withSuccessHandler(function(res) {
              mostrarLoading(false);
              if (res && res.errors > 0) {
                mostrarAlerta(`‚úÖ ${res.success} actualizados | ‚ùå ${res.errors} errores`, 'warning');
              } else {
                mostrarAlerta(`‚úÖ ${res.success || 0} registros actualizados`, 'success');
              }
              registrosTemporales.forEach(function(reg) {
                if (reg.id && res && res.detalles && res.detalles.some(function(d) { return d.success && d.id === reg.id; })) {
                  reg.editado = false;
                }
              });
              manejarRegistros.actualizarTabla();
              manejarRegistros.actualizarBotonesGuardado();
            })
            .withFailureHandler(function(error) {
              mostrarLoading(false);
              console.error('Error al guardar ediciones:', error);
              mostrarAlerta('Error al guardar cambios: ' + (error && error.message ? error.message : error), 'error');
            })
            .guardarEdiciones(editados);
        }
      },

      guardarTemporalesPermanente() {
        if (!registrosTemporales.length) {
          mostrarAlerta('No hay registros temporales para guardar', 'info');
          return;
        }
        const totalRegistros = registrosTemporales.length;
        const nuevos = registrosTemporales.filter(reg => !reg.id);
        const editados = registrosTemporales.filter(reg => reg.id && reg.editado);
        const existentes = registrosTemporales.filter(reg => reg.id && !reg.editado);
        // Asegurar que cada registro editado tenga el campo consecutivo igual a su id
        editados.forEach(reg => {
          reg.consecutivo = reg.id;
        });
        let mensaje = `¬øGuardar TODOS los registros temporales de manera permanente?\n\n`;
        mensaje += `üìä Resumen:\n`;
        mensaje += `‚Ä¢ Total de registros: ${totalRegistros}\n`;
        if (nuevos.length > 0) mensaje += `‚Ä¢ Nuevos: ${nuevos.length}\n`;
        if (editados.length > 0) mensaje += `‚Ä¢ Editados: ${editados.length}\n`;
        if (existentes.length > 0) mensaje += `‚Ä¢ Ya existentes: ${existentes.length}\n`;
        mensaje += `\n‚ö†Ô∏è Esta acci√≥n guardar√° TODOS los registros y limpiar√° la tabla temporal.`;
        if (!confirm(mensaje)) return;
        mostrarLoading(true, 'Guardando todos los registros...');
        const guardarEditadosDespues = (resultadoNuevos) => {
          if (editados.length > 0) {
            google.script.run
              .withSuccessHandler(resultadoEditados => {
                this.procesarResultadoCompleto(resultadoNuevos, resultadoEditados, nuevos, editados, existentes);
              })
              .withFailureHandler(error => {
                mostrarLoading(false);
                console.error('Error al guardar editados:', error);
                mostrarAlerta('Error al guardar registros editados: ' + (error.message || error), 'error');
              })
              .guardarEdiciones(editados);
          } else {
            this.procesarResultadoCompleto(resultadoNuevos, null, nuevos, editados, existentes);
          }
        };
        if (nuevos.length > 0) {
          const datosPreparados = this.prepararDatosParaGuardar(nuevos);
          google.script.run
            .withSuccessHandler(resultadoNuevos => {
              guardarEditadosDespues(resultadoNuevos);
            })
            .withFailureHandler(error => {
              mostrarLoading(false);
              console.error('Error al guardar nuevos:', error);
              mostrarAlerta('Error al guardar registros nuevos: ' + (error.message || error), 'error');
            })
            .guardarEnSheet(datosPreparados);
        } else if (editados.length > 0) {
          guardarEditadosDespues(null);
        } else {
          mostrarLoading(false);
          mostrarAlerta('Todos los registros ya est√°n guardados. Limpiando tabla temporal...', 'info');
          registrosTemporales = [];
          this.actualizarTabla();
          this.actualizarBotonesGuardado();
        }
      },

      procesarResultadoCompleto(resultadoNuevos, resultadoEditados, nuevos, editados, existentes) {
        mostrarLoading(false);
        
        let totalExito = 0;
        let totalErrores = 0;
        
        // Procesar resultado de nuevos
        if (resultadoNuevos) {
          totalExito += resultadoNuevos.success || 0;
          totalErrores += resultadoNuevos.errors || 0;
        }
        
        // Procesar resultado de editados  
        if (resultadoEditados) {
          totalExito += resultadoEditados.success || 0;
          totalErrores += resultadoEditados.errors || 0;
        }
        
        // Mostrar resultado final
        if (totalErrores > 0) {
          // Mostrar el mensaje de error real devuelto por la funci√≥n guardarEdiciones
          let mensajeError = '';
          if (resultadoEditados && resultadoEditados.detalles && resultadoEditados.detalles.length > 0) {
            mensajeError = '‚ùå Errores al guardar registros editados:<ul>';
            resultadoEditados.detalles.forEach((detalle, i) => {
              if (!detalle.success) {
                mensajeError += `<li>Registro ${i + 1}: ${detalle.message || 'Error desconocido'}</li>`;
              }
            });
            mensajeError += '</ul>';
          } else if (resultadoEditados && resultadoEditados.errors) {
            mensajeError = `‚ùå ${resultadoEditados.errors} error(es) al guardar registros editados.`;
          } else {
            mensajeError = '‚ùå Error desconocido al guardar registros editados.';
          }
          mostrarAlerta(mensajeError, 'warning');
          // Mantener solo los registros que fallaron
          const registrosFallidos = [];
          // Verificar nuevos que fallaron
          if (resultadoNuevos && resultadoNuevos.detalles) {
            resultadoNuevos.detalles.forEach((resultado, index) => {
              if (!resultado.success && nuevos[index]) {
                registrosFallidos.push(nuevos[index]);
              }
            });
          }
          // Verificar editados que fallaron
          if (resultadoEditados && resultadoEditados.detalles) {
            resultadoEditados.detalles.forEach((resultado, index) => {
              if (!resultado.success && editados[index]) {
                registrosFallidos.push(editados[index]);
              }
            });
          }
          registrosTemporales = registrosFallidos;
        } else {
          const totalGuardados = totalExito + existentes.length;
          mostrarAlerta(`üéâ ¬°√âxito total! ${totalGuardados} registros procesados.\n\n‚Ä¢ ${totalExito} guardados\n‚Ä¢ ${existentes.length} ya existentes\n\nLa tabla temporal ha sido limpiada.`, 'success');
          
          // Limpiar completamente la tabla temporal
          registrosTemporales = [];
        }
        
        this.actualizarTabla();
        this.actualizarBotonesGuardado();
      },

      // Funci√≥n para crear continuaci√≥n de grupo decimal
      crearContinuacionGrupoDecimal(registroBase) {
        if (!registroBase || !registroBase.esDecimal) return;

        // Generar nuevo ID base usando timestamp
        const nuevoIdBase = Date.now();
        const nuevoId = `${nuevoIdBase}.1`;
        
        // Crear el nuevo registro de continuaci√≥n
        const registroContinuacion = {
          ...registroBase,
          id: nuevoId,
          cantidad: registroBase.cantidad,
          costoTotal: (registroBase.cantidad * parseFloat(registroBase.costoxnivel) * this.getMultiplicador(registroBase.tipo_solicitud)).toFixed(2),
          editado: false,
          esDecimal: true,
          grupoDecimal: nuevoIdBase.toString()
        };
        
        registrosTemporales.push(registroContinuacion);
        
        this.actualizarTabla();
        this.actualizarBotonesGuardado();
        
        mostrarAlerta(`Continuaci√≥n creada con nuevo grupo: ${nuevoIdBase}`, 'success');
        
        // Mostrar informaci√≥n del nuevo grupo
        this.mostrarPanelGrupoDecimal(nuevoIdBase.toString());
      },

      // Funci√≥n para mostrar registros continuables
      mostrarRegistrosContinuables() {
        // Encontrar todos los registros con cantidad < 1 (no solo decimales)
        const registrosContinuables = registrosTemporales.filter(registro => {
          const cantidad = parseFloat(registro.cantidad);
          return cantidad < 1 && cantidad > 0; // Cantidad entre 0 y 1
        });
        
        if (registrosContinuables.length === 0) {
          mostrarAlerta('No hay registros que puedan continuar.\n\nPara que un registro pueda continuar, su cantidad debe ser mayor a 0 y menor a 1.0', 'info');
          return;
        }
        
        // Agrupar registros por criterios similares (cliente, asunto, departamento)
        const gruposDecimales = {};
        registrosContinuables.forEach(registro => {
          // Usar el grupo decimal si existe, o crear uno basado en cliente-asunto-departamento
          const grupoId = registro.grupoDecimal || 
                         `${registro.cliente}-${registro.asunto}-${registro.departamento}`.replace(/\s+/g, '-');
          
          if (!gruposDecimales[grupoId]) {
            gruposDecimales[grupoId] = [];
          }
          gruposDecimales[grupoId].push(registro);
        });
        
        // Crear contenido del modal con los registros continuables
        let contenido = `
          <div class="grupos-continuables">
            <h3>üìã Registros Continuables (Cantidad < 1.0)</h3>
            <p class="descripcion">Los siguientes registros tienen cantidad menor a 1.0 y pueden crear continuaciones o duplicaciones:</p>
        `;
        
        Object.entries(gruposDecimales).forEach(([grupoId, registrosGrupo]) => {
          const sumaGrupo = registrosGrupo.reduce((sum, r) => sum + parseFloat(r.cantidad), 0);
          const costoTotal = registrosGrupo.reduce((sum, r) => sum + parseFloat(r.costoTotal), 0);
          const cantidadRestante = registrosGrupo.reduce((min, r) => Math.min(min, 1 - parseFloat(r.cantidad)), 1);
          
          contenido += `
            <div class="grupo-continuable-item" style="margin-bottom: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05);">
              <div class="grupo-header" style="margin-bottom: 10px;">
                <h4 style="margin: 0; color: var(--primary-color);">Grupo: ${grupoId}</h4>
                <div class="grupo-stats" style="display: flex; gap: 15px; font-size: 0.9em; margin-top: 5px;">
                  <span class="suma" style="color: #f39c12;">üìä Suma actual: ${sumaGrupo.toFixed(2)}</span>
                  <span class="costo" style="color: #27ae60;">üí∞ Costo: $${costoTotal.toFixed(2)}</span>
                  <span class="registros" style="color: #3498db;">üìã ${registrosGrupo.length} registro(s)</span>
                  <span class="disponible" style="color: #e74c3c;">üîÑ M√°x. continuable: ${cantidadRestante.toFixed(2)}</span>
                </div>
              </div>
              
              <div class="registros-lista" style="display: grid; gap: 8px;">
                ${registrosGrupo.map((reg, idx) => {
                  const cantidadDisponible = (1 - parseFloat(reg.cantidad)).toFixed(2);
                  return `
                    <div class="registro-continuable" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                      <div class="registro-info" style="flex: 1; font-size: 0.9em;">
                        <strong>ID:</strong> ${reg.id || 'Nuevo'} | 
                        <strong>Cantidad:</strong> ${reg.cantidad} | 
                        <strong>Disponible:</strong> ${cantidadDisponible} |
                        <strong>Colaborador:</strong> ${reg.colaborador} |
                        <strong>Cliente:</strong> ${reg.cliente} |
                        <strong>Asunto:</strong> ${reg.asunto}
                      </div>
                      <div style="display: flex; gap: 5px;">
                        <button onclick="manejarRegistros.crearContinuacionGrupoDecimal(registrosTemporales.find(r => r === ${JSON.stringify(reg).replace(/"/g, '&quot;')}))" 
                                class="button button-sm button-success" 
                                title="Crear continuaci√≥n de este registro con cantidad ${cantidadDisponible}">
                          ÔøΩ Continuar
                        </button>
                        <button onclick="duplicarRegistro(${registrosTemporales.indexOf(reg)})" 
                                class="button button-sm button-info" 
                                title="Duplicar registro completo para edici√≥n manual">
                          üìã Duplicar
                        </button>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              ${grupoId !== 'Sin grupo' ? `
              <div class="grupo-acciones" style="margin-top: 10px; text-align: center;">
                <button onclick="manejarRegistros.mostrarPanelGrupoDecimal('${grupoId}')" 
                        class="button button-sm button-warning" 
                        title="Ver gesti√≥n completa del grupo ${grupoId}">
                  ‚öôÔ∏è Gestionar Grupo
                </button>
              </div>
              ` : ''}
            </div>
          `;
        });
        
        contenido += `
          </div>
          <div style="margin-top: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <h4 style="margin: 0 0 8px 0; color: var(--primary-color);">üí° Instrucciones:</h4>
            <ul style="margin: 0; padding-left: 20px; color: var(--text-color);">
              <li><strong>üîÑ Continuar:</strong> Crea autom√°ticamente un nuevo registro para completar hasta 1.0</li>
              <li><strong>üìã Duplicar:</strong> Crea una copia completa del registro para edici√≥n manual</li>
              <li><strong>‚öôÔ∏è Gestionar:</strong> Abre el panel de gesti√≥n completa del grupo decimal</li>
            </ul>
          </div>
        `;
        
        // Mostrar modal con los registros continuables
        this.mostrarModalCustom('üìã Registros Continuables', contenido);
      }
    };

    // Funciones adicionales
    function editarRegistro(idOrIndex) {
      let registro;
      
      if (typeof idOrIndex === 'number') {
        // Es un √≠ndice (registro temporal sin ID)
        registro = registrosTemporales[idOrIndex];
      } else {
        // Es un ID (registro existente)
        registro = registrosTemporales.find(r => r.id === idOrIndex);
      }
      
      if (!registro) return;
      
      // Verificar si es un registro entregado y no estamos en modo maestro
      if (registro.estatus === 'Entregado' && !modoMaestroActivo) {
        mostrarAlerta('No puedes editar registros entregados a menos que actives el modo maestro', 'warning');
        return;
      }
      
      registroEditando = registro;
      
      // Formatear fecha correctamente usando parseo de formato dd/mm/yyyy
      let fechaFormateada;
      try {
        const fecha = parsearFechaDDMMYYYY(registro.fecha);
        if (fecha) {
          fechaFormateada = fecha.toISOString().split('T')[0];
        } else {
          throw new Error("Fecha inv√°lida");
        }
      } catch (e) {
        fechaFormateada = new Date().toISOString().split('T')[0]; // Fecha actual si hay error
      }
      
      // Llenar campos b√°sicos
      document.getElementById('fecha').value = fechaFormateada;
      document.getElementById('colaborador').value = registro.colaborador;
      document.getElementById('departamento').value = registro.departamento;
      document.getElementById('registro-id').value = registro.id || '';
      document.getElementById('estatus').value = registro.estatus || 'Pendiente';
      
      // Manejar cliente y asuntos de manera as√≠ncrona
      const selectCliente = document.getElementById('cliente');
      selectCliente.value = registro.cliente;
      
      // Cargar asuntos para el cliente seleccionado
      cargarAsuntos(registro.cliente);
      
      // Usar setTimeout para dar tiempo a que carguen los asuntos
      setTimeout(() => {
        const selectAsunto = document.getElementById('asunto');
        selectAsunto.value = registro.asunto;
        
        // Actualizar campos dependientes del asunto
        const selectedOption = Array.from(selectAsunto.options).find(opt => opt.value === registro.asunto);
        if (selectedOption) {
          document.getElementById('lider').value = selectedOption.dataset.lider || '';
          document.getElementById('num-cliente').value = selectedOption.dataset.numCliente || '';
          document.getElementById('num-asunto').value = selectedOption.dataset.numAsunto || '';
        }
        
        // Continuar con la carga de otros campos
        continuarCargaEdicion(registro);
      }, 1000);
      
      // Mostrar/ocultar botones correctamente
      document.getElementById('btnAgregarRegistro').style.display = 'none';
      document.getElementById('btnActualizarRegistro').style.display = 'inline-block';
      document.getElementById('btnCancelarEdicion').style.display = 'inline-block';
      
      // Desplazarse al inicio del formulario
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function continuarCargaEdicion(registro) {
      // Manejar categor√≠a, descripci√≥n y nivel
      const selectCategoria = document.getElementById('categoria');
      selectCategoria.value = registro.categoria;
      
      // Cargar descripciones para la categor√≠a seleccionada
      cargarDescripciones(registro.departamento, registro.categoria).then(() => {
        const selectDescripcion = document.getElementById('descripcion');
        selectDescripcion.value = registro.descripcion;
        
        // Cargar niveles para la descripci√≥n seleccionada
        cargarNiveles(registro.departamento, registro.categoria, registro.descripcion).then(() => {
          const selectNivel = document.getElementById('nivel');
          selectNivel.value = registro.nivel;
          
          // Cargar costos
          cargarCostoBase(registro.departamento, registro.categoria, registro.descripcion);
          cargarCostoPorNivel(registro.departamento, registro.categoria, registro.descripcion, registro.nivel);
        }).catch(error => {
          console.error('Error al cargar niveles en edici√≥n:', error);
        });
      }).catch(error => {
        console.error('Error al cargar descripciones en edici√≥n:', error);
      });
      
      // Llenar el resto de campos
      document.getElementById('observaciones').value = registro.observaciones || '';
      // Mostrar cantidad como porcentaje si es decimal <1, si no como entero
      const cantidadInput = document.getElementById('cantidad');
      if (registro.cantidad !== undefined && registro.cantidad !== null && registro.cantidad !== '') {
        const num = Number(registro.cantidad);
        if (!isNaN(num) && num > 0 && num < 1) {
          cantidadInput.value = (num * 100).toFixed(0);
          cantidadInput.dataset.decimal = '1';
        } else {
          cantidadInput.value = num;
          cantidadInput.dataset.decimal = '';
        }
      } else {
        cantidadInput.value = '';
        cantidadInput.dataset.decimal = '';
      }
      document.getElementById('tipo_solicitud').value = registro.tipo_solicitud;
      // Forzar actualizaci√≥n de costos despu√©s de un breve retraso
      setTimeout(() => {
        document.getElementById('costo').value = registro.costo || '0.00';
        document.getElementById('costoxnivel').value = parseFloat(registro.costoxnivel || 0).toFixed(2);
        document.getElementById('costoTotal').value = parseFloat(registro.costoTotal || 0).toFixed(2);
      }, 500);
    }

    function cancelarEdicion() {
      manejarRegistros.limpiarFormulario();
      registroEditando = null;
      
      // Restaurar botones
      document.getElementById('btnAgregarRegistro').style.display = 'inline-block';
      document.getElementById('btnActualizarRegistro').style.display = 'none';
      document.getElementById('btnCancelarEdicion').style.display = 'none';
      
      mostrarAlerta('Edici√≥n cancelada', 'info');
    }

    function eliminarRegistro(index) {
      if (confirm('¬øEliminar registro?')) {
        registrosTemporales.splice(index, 1);
        manejarRegistros.actualizarTabla();
        manejarRegistros.actualizarBotonesGuardado();
        mostrarAlerta('Registro eliminado', 'success');
      }
    }

    function marcarComoEntregado(index, guardarAutomatico = false) {
      if (index < 0 || index >= registrosTemporales.length) return;
      
      const registro = registrosTemporales[index];
      
      if (registro.estatus === 'Entregado' && !confirm('Este registro ya est√° marcado como entregado. ¬øDesea actualizarlo?')) {
        return;
      }
      
      registro.estatus = 'Entregado';
      registro.editado = true;
      
      if (!registro.fechaEntrega) {
        registro.fechaEntrega = new Date().toISOString().split('T')[0];
      }
      
      manejarRegistros.actualizarTabla();
      manejarRegistros.actualizarBotonesGuardado();
      
      if (guardarAutomatico) {
        mostrarLoading(true);
        
        google.script.run
          .withSuccessHandler(() => {
            mostrarLoading(false);
            registro.editado = false;
            manejarRegistros.actualizarTabla();
            mostrarAlerta('Registro marcado como entregado y guardado', 'success');
          })
          .withFailureHandler(error => {
            mostrarLoading(false);
            console.error('Error al guardar entrega:', error);
            mostrarAlerta('Error al guardar entrega: ' + error.message, 'error');
          })
          .marcarComoEntregado(registro.id || registro.consecutivo);
      } else {
        mostrarAlerta('Registro marcado como entregado (pendiente de guardar)', 'success');
      }
    }

    // Funciones de gesti√≥n de permisos
    function tienePermisoEditar(registro) {
      // Admin puede editar todo
      if (esAdmin) return true;
      
      // Coordinador puede editar registros de su departamento
      if (esCoordinador && registro.departamento === departamentoActual) return true;
      
      // Usuario normal solo puede editar sus propios registros pendientes
      if (registro.colaborador === usuarioActual && registro.estatus === 'Pendiente') return true;
      
      return false;
    }
    
    function mostrarInfoPermisos() {
      const permisosContainer = document.getElementById('permisos-info');
      if (!permisosContainer) return;
      
      // Determinar permisos seg√∫n el rol del usuario
      let acceso = {};
      
      if (esCoordinador) {
        // COORDINADOR - Acceso completo
        acceso = {
          dashboard: '‚úÖ Vista global - Todos los departamentos',
          planeacion: '‚úÖ Gesti√≥n completa - Cualquier departamento',
          entrega: '‚úÖ Gesti√≥n completa - Todos los departamentos',
          edicion: '‚úÖ Edici√≥n completa - Cualquier registro',
          modoMaestro: '‚úÖ Acceso con clave maestra',
          gestion: '‚úÖ Gesti√≥n de usuarios y claves',
          exportacion: '‚úÖ CSV, Excel, PDF - Datos completos',
          especiales: '‚úÖ Cancelar/eliminar registros, estad√≠sticas globales'
        };
      } else if (esAdmin) {
        // ADMINISTRADOR - Acceso departamental
        acceso = {
          dashboard: '‚úÖ Solo datos de su departamento',
          planeacion: '‚ö†Ô∏è Solo registros de su departamento',
          entrega: '‚ö†Ô∏è Solo entregas de su departamento',
          edicion: '‚ö†Ô∏è Solo registros de su departamento',
          modoMaestro: '‚ùå Sin acceso al modo edici√≥n maestra',
          gestion: '‚ùå Sin gesti√≥n de usuarios',
          exportacion: '‚úÖ Archivos disponibles de su departamento',
          especiales: '‚ùå Sin eliminaci√≥n permanente'
        };
      } else {
        // USUARIO NORMAL - Acceso b√°sico
        acceso = {
          dashboard: '‚úÖ Acceso completo al dashboard',
          planeacion: '‚ö†Ô∏è Solo crear/ver registros propios y de su equipo',
          entrega: '‚ö†Ô∏è Solo entregas propias pendientes y de su equipo',
          edicion: '‚ö†Ô∏è Solo registros propios en estado "Pendiente"',
          modoMaestro: '‚ùå Sin acceso al modo edici√≥n maestra',
          gestion: '‚ùå Sin gesti√≥n del sistema',
          exportacion: '‚úÖ Funciones de exportaci√≥n b√°sicas',
          especiales: '‚ùå Sin funciones administrativas'
        };
      }
      
      const permisos = {
        usuario: usuarioActual,
        departamento: departamentoActual,
        rol: esCoordinador ? 'Coordinador' : esAdmin ? 'Administrador' : 'Usuario Normal',
        acceso: acceso
      };
      
      permisosContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">üë§ ${permisos.usuario}</h4>
          <div style="background: var(--primary-color); color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold;">
            ${permisos.rol} - üè¢ ${permisos.departamento}
          </div>
        </div>
        
        <div style="display: grid; gap: 8px;">
          <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            <h5 style="margin: 0 0 5px 0; color: var(--primary-color);">üìä Dashboard:</h5>
            <div style="font-size: 0.85em; padding-left: 10px;">${permisos.acceso.dashboard}</div>
          </div>
          
          <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            <h5 style="margin: 0 0 5px 0; color: var(--primary-color);">üìÖ Planeaci√≥n:</h5>
            <div style="font-size: 0.85em; padding-left: 10px;">${permisos.acceso.planeacion}</div>
          </div>
          
          <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            <h5 style="margin: 0 0 5px 0; color: var(--primary-color);">üì§ Entrega:</h5>
            <div style="font-size: 0.85em; padding-left: 10px;">${permisos.acceso.entrega}</div>
          </div>
          
          <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            <h5 style="margin: 0 0 5px 0; color: var(--primary-color);">‚úèÔ∏è Edici√≥n:</h5>
            <div style="font-size: 0.85em; padding-left: 10px;">${permisos.acceso.edicion}</div>
          </div>
          
          ${esCoordinador ? `
          <div style="background: rgba(255,215,0,0.1); padding: 8px; border-radius: 8px; border-left: 4px solid gold;">
            <h5 style="margin: 0 0 5px 0; color: gold;">üîë Permisos Especiales:</h5>
            <div style="font-size: 0.8em; padding-left: 10px;">
              ‚Ä¢ ${permisos.acceso.modoMaestro}<br>
              ‚Ä¢ ${permisos.acceso.gestion}<br>
              ‚Ä¢ ${permisos.acceso.especiales}
            </div>
          </div>
          ` : ''}
          
          <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            <h5 style="margin: 0 0 5px 0; color: var(--primary-color);">üìã Exportaci√≥n:</h5>
            <div style="font-size: 0.85em; padding-left: 10px;">${permisos.acceso.exportacion}</div>
          </div>
          
          ${!esCoordinador ? `
          <div style="background: rgba(255,0,0,0.1); padding: 8px; border-radius: 8px; border-left: 4px solid #ff4444;">
            <h5 style="margin: 0 0 5px 0; color: #ff4444;">üö´ Limitaciones:</h5>
            <div style="font-size: 0.8em; padding-left: 10px;">
              ${esAdmin ? 
                '‚Ä¢ No acceso a otros departamentos<br>‚Ä¢ Sin modo edici√≥n maestra<br>‚Ä¢ Sin gesti√≥n de usuarios' : 
                '‚Ä¢ No editar registros entregados/cancelados<br>‚Ä¢ Sin funciones administrativas<br>‚Ä¢ Solo registros propios y de equipo'
              }
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    function actualizarIndicadoresDepartamento() {
      // Actualizar indicador en secci√≥n de Planeaci√≥n
      const indicadorPlaneacion = document.getElementById('seccion-depto-nombre');
      if (indicadorPlaneacion && departamentoActual) {
        indicadorPlaneacion.textContent = departamentoActual;
      }
      
      // Actualizar indicador en secci√≥n de Entrega
      const indicadorEntrega = document.getElementById('seccion-entrega-nombre');
      if (indicadorEntrega && departamentoActual) {
        indicadorEntrega.textContent = departamentoActual;
      }
      
      console.log('Indicadores de departamento actualizados:', departamentoActual);
    }

    function mostrarFormularioEdicion(registro) {
      // Esta funci√≥n se implementar√° cuando se agregue el formulario de edici√≥n modal
      mostrarAlerta('Funcionalidad de edici√≥n modal en desarrollo. Use la funci√≥n de edici√≥n en tabla.', 'info');
    }

    // Inicializaci√≥n al cargar
    window.addEventListener('load', function() {
      // Funci√≥n para ocultar el loader de forma segura
      function ocultarLoader(forzado) {
        var loader = document.getElementById('loader-overlay');
        var main = document.getElementById('main-content');
        if (loader) {
          loader.style.opacity = 0;
          setTimeout(function() {
            loader.style.display = 'none';
            console.log('Loader ocultado' + (forzado ? ' (forzado)' : ''));
          }, 400);
        } else {
          console.warn('No se encontr√≥ loader-overlay');
        }
        if (main) {
          main.style.opacity = 1;
          main.style.display = '';
        } else {
          console.warn('No se encontr√≥ main-content');
        }
      }

      // Ocultar loader normalmente despu√©s de la inicializaci√≥n

      // Ocultar loader lo m√°s pronto posible para mejorar experiencia
      setTimeout(function() { ocultarLoader(true); }, 500);

      try {
        inicializarAplicacion();
        // Si la app tarda m√°s de 2 segundos en cargar datos, mostrar la interfaz igual
        setTimeout(function() {
          ocultarLoader(true);
        }, 2000);
      } catch (e) {
        console.error('Error en inicializarAplicacion:', e);
        ocultarLoader(true);
      }
    });
    
    // üîß VERIFICACI√ìN Y VALIDACI√ìN DE SINTAXIS (CORREGIDA)
    try {
      // Asegurar que las variables globales est√©n disponibles
      if (typeof permisosUsuario === 'undefined') {
        window.permisosUsuario = { departamentos: [], admin: false };
      }
      console.log('‚úÖ Variables globales verificadas correctamente');
    } catch (e) {
      console.error('‚ùå Error en verificaci√≥n de variables:', e);
    }

    // üîç FUNCI√ìN DE DEBUG PARA ERRORES DE SINTAXIS
    function validarSintaxisJavaScript() {
      console.log('üîç Validando sintaxis JavaScript...');
      
      const objetosParaValidar = ['permisosUsuario', 'registrosTemporales', 'registrosDashboard'];
      
      objetosParaValidar.forEach(nombreObj => {
        try {
          const obj = window[nombreObj];
          if (obj !== undefined) {
            console.log(`‚úÖ ${nombreObj}: OK`);
          } else {
            console.warn(`‚ö†Ô∏è ${nombreObj}: No definido`);
          }
        } catch (e) {
          console.error(`‚ùå ${nombreObj}: Error -`, e.message);
        }
      });
      
      try {
        const testObj = { test: true, otro: false };
        console.log('‚úÖ Sintaxis b√°sica: OK');
        return true;
      } catch (e) {
        console.error('‚ùå Error de sintaxis detectado:', e);
        return false;
      }
    }
    
    // Ejecutar validaci√≥n despu√©s de cargar
    setTimeout(validarSintaxisJavaScript, 200);
    
    // ========== FUNCIONES ADICIONALES CORREGIDAS ==========
    
    // Funci√≥n para cargar dashboard autom√°ticamente con semana actual y anterior
    // Funciones para limpiar datos entre secciones (MEJORADAS)
    function cargarDatosIniciales() {
      console.log('üì• Iniciando carga de datos iniciales...');
      // Mostrar loading solo si tarda m√°s de 400ms
      const loadingTimeout = setTimeout(() => {
        mostrarLoading(true, 'Cargando datos b√°sicos...');
      }, 400);
      google.script.run
        .withSuccessHandler(data => {
          clearTimeout(loadingTimeout);
          try {
            if (data.colaboradores && data.colaboradores.length > 0) {
              actualizarColaboradores(data.colaboradores);
            }
            if (data.coordinadores && data.coordinadores.length > 0) {
              actualizarCoordinadores(data.coordinadores);
            }
            if (data.clientes && data.clientes.length > 0) {
              actualizarClientes(data.clientes);
            }
            console.log('‚úÖ Datos iniciales procesados correctamente');
          } catch (error) {
            console.error('‚ùå Error al procesar datos:', error);
            mostrarAlerta('Error al procesar datos iniciales: ' + error.message, 'warning');
          }
          mostrarLoading(false);
        })
        .withFailureHandler(error => {
          clearTimeout(loadingTimeout);
          mostrarLoading(false);
          mostrarAlerta('‚ö†Ô∏è Error al cargar datos iniciales. Puede continuar pero algunas funciones pueden estar limitadas.', 'warning');
        })
        .obtenerDatosIniciales();
    }
      

    // Esta parte debe estar dentro de limpiarDatosDashboard()
    function limpiarDatosDashboard() {
      registrosDashboard = [];
      // Limpiar tabla del dashboard
      const tbodyDashboard = document.getElementById('tablaDatosDashboard');
      if (tbodyDashboard) {
        tbodyDashboard.innerHTML = '';
      }
      // Limpiar todas las tablas de an√°lisis del dashboard
      const tablasAnalisis = [
        'tbody-departamento-cliente',
        'tbody-tipo-solicitud',
        'tbody-pendientes-asunto',
        'tbody-rendimiento-colaborador',
        'tbody-estado-proyectos'
      ];
      tablasAnalisis.forEach(id => {
        const tabla = document.getElementById(id);
        if (tabla) {
          tabla.innerHTML = '';
        }
      });
      // Limpiar selector de semanas
      const selectorSemanas = document.getElementById('semanas-selector');
      if (selectorSemanas) {
        selectorSemanas.innerHTML = '';
      }
      console.log('Datos de dashboard limpiados completamente');
    }

    // Funci√≥n para diagnosticar las tablas (modificada para usar datos correctos)
    function diagnosticarTablas() {
      console.log('=== DIAGN√ìSTICO DE TABLAS ===');
      
      // Verificar qu√© secci√≥n est√° activa
      const dashboardSection = document.getElementById('Dashboard-section');
      const planeacionSection = document.getElementById('Planeacion-section');
      const esDashboardActivo = dashboardSection && dashboardSection.style.display !== 'none';
      const esPlaneacionActiva = planeacionSection && planeacionSection.style.display !== 'none';
      
      console.log('Secci√≥n activa:', {
        dashboard: esDashboardActivo,
        planeacion: esPlaneacionActiva
      });
      
      // Verificar que existen los elementos HTML
      const elementos = [
        'tbody-departamento-cliente',
        'tbody-tipo-solicitud', 
        'tbody-pendientes-asunto',
        'tbody-rendimiento-colaborador',
        'tbody-estado-proyectos'
      ];
      
      elementos.forEach(id => {
        const elemento = document.getElementById(id);
        console.log(`Elemento ${id}:`, elemento ? 'ENCONTRADO' : 'NO ENCONTRADO');
        if (elemento) {
          console.log(`  - Contenido: ${elemento.innerHTML.length} caracteres`);
          console.log(`  - Filas: ${elemento.querySelectorAll('tr').length}`);
        }
      });
      
      // Verificar datos seg√∫n la secci√≥n activa
      if (esDashboardActivo) {
        console.log('Registros dashboard:', registrosDashboard.length);
        if (registrosDashboard.length > 0) {
          console.log('Primer registro dashboard:', registrosDashboard[0]);
        }
      } else {
        console.log('Registros planeaci√≥n:', registrosTemporales.length);
        if (registrosTemporales.length > 0) {
          console.log('Primer registro planeaci√≥n:', registrosTemporales[0]);
        }
      }
      
      // Verificar semanas seleccionadas (solo para dashboard)
      if (esDashboardActivo) {
        const semanasSeleccionadas = Array.from(document.querySelectorAll('.semana-checkbox input:checked'))
          .map(input => parseInt(input.value));
        console.log('Semanas seleccionadas:', semanasSeleccionadas);
      }
      
      console.log('=== FIN DIAGN√ìSTICO ===');
    }

    function cargarDashboardAutomatico() {
      console.log('=== CARGAR DASHBOARD AUTOM√ÅTICO ===');
      
      // Verificar que el contenedor del selector de semanas existe
      const selectorContainer = document.getElementById('semanas-selector');
      if (!selectorContainer) {
        console.error('Contenedor semanas-selector no encontrado, creando selector b√°sico...');
        inicializarSelectorBasico();
        return;
      }
      
      mostrarLoading(true, 'Cargando dashboard...');
      
      // Inicializar selector b√°sico mientras se cargan los datos
      console.log('Inicializando selector b√°sico...');
      inicializarSelectorBasico();
      
      // Obtener semana actual
      const semanaActual = obtenerSemanaActual();
      const semanaAnterior = semanaActual - 1;
      
      console.log(`Cargando datos para an√°lisis (todas las semanas disponibles)`);
      
      // Limpiar filtros y cargar TODOS los datos para generar el selector correcto
      const filtros = {
        semana: '', // Cargar todas las semanas
        colaborador: '',
        coordinador: '',
        cliente: '',
        estatus: '',
        hoja: 'DatosFormulario'
      };
      
      google.script.run
        .withSuccessHandler(data => {
          mostrarLoading(false);
          console.log('Datos recibidos del backend:', data?.length || 0, 'registros');
          
          if (data && data.length > 0) {
            console.log('Procesando datos para dashboard...');
            
            // 1. Generar selector de semanas con TODOS los datos
            generarSelectorSemanas(data);
            
            // 2. Actualizar datos del dashboard (filtrar por semanas relevantes)
            actualizarDatosDashboard(data);
            
            // 3. Peque√±a pausa y luego actualizar tabla de asuntos
            setTimeout(() => {
              console.log('Actualizando tabla de departamento-asuntos...');
              // actualizarTablaDepartamentoAsuntos(); // Se llamar√° autom√°ticamente por el selector
            }, 500);
            
            console.log('‚úÖ Dashboard cargado exitosamente');
          } else {
            console.warn('No se recibieron datos del backend');
            mostrarAlerta('No se encontraron datos para el dashboard', 'warning');
          }
        })
        .withFailureHandler(error => {
          mostrarLoading(false);
          console.error('Error al cargar dashboard:', error);
          mostrarAlerta('Error al cargar dashboard: ' + error.message, 'error');
          
          // En caso de error, mantener el selector b√°sico
          console.log('Manteniendo selector b√°sico debido al error');
        })
        .buscarReg(JSON.stringify(filtros));
    }

    // Funci√≥n para obtener la semana actual
    function obtenerSemanaActual() {
      const hoy = new Date();
      return getWeekNumber(hoy);
    }

    // Funci√≥n para parsear fechas en formato dd/mm/yyyy
    function parsearFechaDDMMYYYY(fechaString) {
      if (!fechaString || fechaString.trim() === '') return null;
      
      try {
        // Si ya es un objeto Date, devolverlo
        if (fechaString instanceof Date) return fechaString;
        
        // Intentar parsear formato dd/mm/yyyy
        const partes = fechaString.toString().split('/');
        if (partes.length === 3) {
          const dia = parseInt(partes[0], 10);
          const mes = parseInt(partes[1], 10) - 1; // Los meses en JS van de 0-11
          const a√±o = parseInt(partes[2], 10);
          
          if (!isNaN(dia) && !isNaN(mes) && !isNaN(a√±o)) {
            const fecha = new Date(a√±o, mes, dia);
            // Verificar que la fecha es v√°lida
            if (fecha.getDate() === dia && fecha.getMonth() === mes && fecha.getFullYear() === a√±o) {
              return fecha;
            }
          }
        }
        
        // Intentar parsear formato ISO
        const fechaISO = new Date(fechaString);
        if (!isNaN(fechaISO.getTime())) {
          return fechaISO;
        }
        
        return null;
      } catch (e) {
        console.warn('Error al parsear fecha:', fechaString, e);
        return null;
      }
    }

    // Funci√≥n para limpiar el selector de semanas
    function limpiarSelectorSemanas() {
      const container = document.getElementById('semanas-selector');
      if (container) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #999;">
            <p style="margin-bottom: 10px; font-size: 14px;">üîÑ Preparando selector de semanas...</p>
          </div>
        `;
      }
    }

    // Funci√≥n para inicializar selector b√°sico cuando no hay datos
    function inicializarSelectorBasico() {
      const selectorContainer = document.getElementById('semanas-selector');
      if (!selectorContainer) return;
      
      const semanaActual = obtenerSemanaActual();
      const semanaAnterior = semanaActual - 1;
      
      selectorContainer.innerHTML = `
        <div style="padding: 15px; text-align: center; background: rgba(255,255,255,0.1); border-radius: 8px;">
          <p style="margin: 0 0 10px 0; color: #ccc;">Selector de semanas (Semanas ${semanaAnterior}-${semanaActual})</p>
          <div class="semanas-grid">
            <div class="semana-checkbox">
              <input type="checkbox" id="semana-${semanaAnterior}" value="${semanaAnterior}" checked>
              <label for="semana-${semanaAnterior}">Semana ${semanaAnterior}</label>
            </div>
            <div class="semana-checkbox">
              <input type="checkbox" id="semana-${semanaActual}" value="${semanaActual}" checked>
              <label for="semana-${semanaActual}">Semana ${semanaActual}</label>
            </div>
          </div>
          <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #999;">Datos: Cargando...</p>
        </div>
      `;
    }

    // Funci√≥n para obtener semana de un registro (con fallbacks mejorados y regla del lunes)
    function obtenerSemanaDeRegistro(registro) {
      console.log('obtenerSemanaDeRegistro - Registro:', {
        id: registro.id,
        estatus: registro.estatus,
        semana: registro.semana,
        fechaEntrega: registro.fechaEntrega,
        fecha: registro.fecha
      });
      
      // Variables para c√°lculo
      let semanaQ = null;
      let semanaT = null;
      
      // Obtener semana de columna Q (semana planeada/datos entregados)
      if (registro.semana && !isNaN(parseInt(registro.semana))) {
        const semana = parseInt(registro.semana);
        if (semana >= 1 && semana <= 53) {
          semanaQ = semana;
          console.log('Columna Q (semana planeada) encontrada:', semanaQ);
        }
      }
      
      // Obtener semana de columna T (fecha de entrega real) con regla especial del lunes
      if (registro.fechaEntrega && registro.fechaEntrega.trim() !== '') {
        try {
          const fechaEntrega = parsearFechaDDMMYYYY(registro.fechaEntrega);
          if (fechaEntrega && !isNaN(fechaEntrega.getTime())) {
            // NUEVA REGLA: Si la fecha de entrega es un lunes, usar la semana anterior
            const diaSemana = fechaEntrega.getDay(); // 0 = domingo, 1 = lunes, ..., 6 = s√°bado
            
            if (diaSemana === 1) { // Es lunes
              // Calcular la fecha del lunes anterior (7 d√≠as antes)
              const lunesAnterior = new Date(fechaEntrega);
              lunesAnterior.setDate(fechaEntrega.getDate() - 7);
              semanaT = getWeekNumber(lunesAnterior);
              console.log('üî• REGLA LUNES: Fecha entrega es lunes', fechaEntrega.toLocaleDateString(), 
                         '‚Üí usando semana anterior:', semanaT, '(fecha c√°lculo:', lunesAnterior.toLocaleDateString(), ')');
            } else {
              // Para cualquier otro d√≠a, usar la semana normal
              semanaT = getWeekNumber(fechaEntrega);
              console.log('Columna T (fecha entrega real) encontrada:', semanaT, 'desde fecha:', registro.fechaEntrega);
            }
          }
        } catch (e) {
          console.warn('Error al procesar fechaEntrega:', registro.fechaEntrega, e);
        }
      }
      
      console.log('An√°lisis columnas - Q (planeada):', semanaQ, 'T (entrega real):', semanaT, 'Estatus:', registro.estatus);
      
      // L√ìGICA CORREGIDA seg√∫n especificaciones:
      // 1. Para registros ENTREGADOS: usar columna T (fecha de entrega real) si existe
      // 2. Para registros PENDIENTES: usar columna Q (semana planeada)
      // 3. Si T es mayor que Q para entregados, usar T (entrega tard√≠a)
      
      if (registro.estatus === 'Entregado') {
        if (semanaT) {
          // Verificar si la entrega fue tard√≠a (T > Q)
          if (semanaQ && semanaT > semanaQ) {
            console.log('‚úÖ Entregado tard√≠o: usando semana T (entrega real):', semanaT, '> Q:', semanaQ);
          } else {
            console.log('‚úÖ Entregado a tiempo: usando semana T (entrega real):', semanaT);
          }
          return semanaT;
        } else if (semanaQ) {
          console.log('‚úÖ Entregado sin fecha T: usando semana Q (planeada):', semanaQ);
          return semanaQ;
        }
      } else if (registro.estatus === 'Pendiente') {
        if (semanaQ) {
          console.log('‚è≥ Pendiente: usando semana Q (planeada):', semanaQ);
          return semanaQ;
        } else if (semanaT) {
          console.log('‚è≥ Pendiente sin Q: usando semana T como fallback:', semanaT);
          return semanaT;
        }
      } else {
        // Para otros estatus (Cancelado, etc.)
        if (semanaT) {
          console.log('üîÑ Otro estatus: usando semana T (entrega real):', semanaT);
          return semanaT;
        } else if (semanaQ) {
          console.log('üîÑ Otro estatus: usando semana Q (planeada):', semanaQ);
          return semanaQ;
        }
      }
      
      // Fallback: Calcular desde fecha de registro
      if (registro.fecha && registro.fecha.trim() !== '') {
        try {
          const fechaRegistro = parsearFechaDDMMYYYY(registro.fecha);
          if (fechaRegistro && !isNaN(fechaRegistro.getTime())) {
            const semanaFecha = getWeekNumber(fechaRegistro);
            console.log('üîÑ Fallback: usando semana de fecha registro:', semanaFecha, 'desde:', registro.fecha);
            return semanaFecha;
          }
        } catch (e) {
          console.warn('Error al procesar fecha de registro:', registro.fecha, e);
        }
      }
      
      // Fallback final: semana actual
      const semanaActual = obtenerSemanaActual();
      console.log('üö® Fallback final: usando semana actual:', semanaActual);
      return semanaActual;
    }

    // Funci√≥n para mostrar vista previa
    function mostrarVistaPrevia() {
      const previewContainer = document.getElementById('previewContainer');
      const floatingTab = document.getElementById('floatingTab');
      
      if (!previewContainer) {
        mostrarAlerta('Contenedor de vista previa no encontrado', 'error');
        return;
      }
      
      // Verificar si hay datos para mostrar
      if (registrosTemporales.length === 0) {
        mostrarAlerta('No hay datos para mostrar en la vista previa. Realice una b√∫squeda primero.', 'warning');
        return;
      }
      
      // Actualizar datos de la vista previa
      actualizarVistaPrevia();
      
      // Mostrar el contenedor
      previewContainer.style.display = 'block';
      previewContainer.classList.add('show');
      
      // Ocultar la pesta√±a flotante
      if (floatingTab) {
        floatingTab.style.display = 'none';
      }
      
      // A√±adir efecto de transici√≥n
      setTimeout(() => {
        previewContainer.style.opacity = '1';
        previewContainer.style.transform = 'translateX(0)';
      }, 10);
      
      console.log('Vista previa mostrada con', registrosTemporales.length, 'registros');
    }

    // Funci√≥n para ocultar vista previa
    function ocultarVistaPrevia() {
      const previewContainer = document.getElementById('previewContainer');
      const floatingTab = document.getElementById('floatingTab');
      
      if (previewContainer) {
        previewContainer.style.opacity = '0';
        previewContainer.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
          previewContainer.style.display = 'none';
          previewContainer.classList.remove('show');
        }, 300);
      }
      
      // Mostrar la pesta√±a flotante de nuevo si hay datos
      if (floatingTab && registrosTemporales.length > 0) {
        floatingTab.style.display = 'block';
      }
      
      console.log('Vista previa ocultada');
    }
    
    // ========== FIN FUNCIONES ADICIONALES ==========
    
    // Funci√≥n auxiliar para actualizar tabla de entrega (si existe una espec√≠fica)
    function actualizarTablaEntrega(datos) {
      const tbody = document.getElementById('tablaDatosEntrega');
      if (!tbody) {
        // Si no existe tabla espec√≠fica de entrega, usar la tabla normal
        manejarRegistros.actualizarTabla();
        return;
      }
      
      tbody.innerHTML = datos.map((registro, idx) => {
        let botones = '';
        // Solo mostrar botones de entrega para registros pendientes
        if (registro.estatus === 'Pendiente' && (tienePermisoEditar(registro) || modoMaestroActivo)) {
          botones += `<button class="button button-success" onclick="marcarComoEntregado(${idx}, true)">‚úì Marcar como Entregado</button>`;
        } else if (registro.estatus === 'Entregado' && (tienePermisoEditar(registro) || modoMaestroActivo)) {
          botones += `<button class="button button-warning" onclick="cancelarEntrega('${registro.id}')">‚Ü© Cancelar Entrega</button>`;
        }
        // Bot√≥n para continuar si es decimal y editable
        if (registro.esDecimal && registro.grupoDecimal && (tienePermisoEditar(registro) || modoMaestroActivo)) {
          botones += `<button class="button button-info" onclick="continuarRegistroDecimal(${idx})">Continuar</button>`;
        }
        return `
          <tr ${registro.estatus === 'Cancelado' ? 'class="cancelado"' : ''}>
            <td class="id-cell">${registro.id || ''}</td>
            <td>${registro.fecha}</td>
            <td>${registro.colaborador}</td>
            <td>${registro.departamento}</td>
            <td>${registro.cliente}</td>
            <td>${registro.asunto}</td>
            <td>${registro.descripcion}</td>
            <td>${registro.cantidad}</td>
            <td class="costo-cell">$${registro.costoTotal || '0.00'}</td>
            <td>${registro.estatus}</td>
            <td>${registro.fechaEntrega || 'Pendiente'}</td>
            <td>${botones}</td>
          </tr>
        `;
      }).join('');
    // Funci√≥n para continuar un registro decimal
      
      // Aplicar formato ingl√©s a los n√∫meros en la tabla
      aplicarFormatoNumerosTablas();
    }
    
    // Funci√≥n de debug para solucionar problemas de visualizaci√≥n
    function debugMostrarSecciones() {
      console.log('=== DEBUG SECCIONES ===');
      
      // Verificar estado actual
      const mainSection = document.getElementById('main-section');
      const loginSection = document.getElementById('login-section');
      
      console.log('Estado actual:', {
        mainSectionVisible: mainSection ? mainSection.style.display : 'NO ENCONTRADO',
        loginSectionVisible: loginSection ? loginSection.style.display : 'NO ENCONTRADO',
        usuarioActual,
        departamentoActual,
        esAdmin,
        esCoordinador
      });
      
      // Forzar mostrar main-section
      if (mainSection) {
        mainSection.style.display = 'block';
        mainSection.classList.add('active-section');
        console.log('main-section forzado a visible');
      }
      
      // Ocultar login-section
      if (loginSection) {
        loginSection.style.display = 'none';
        loginSection.classList.remove('active-section');
        console.log('login-section ocultado');
      }
      
      // Mostrar botones de navegaci√≥n
      const btnDashboard = document.getElementById('btnDashboard');
      const btnPlaneacion = document.getElementById('btnPlaneacion');
      const btnEntrega = document.getElementById('btnEntrega');
      
      if (btnDashboard) {
        btnDashboard.style.display = 'inline-block';
        console.log('btnDashboard mostrado');
      }
      if (btnPlaneacion) {
        btnPlaneacion.style.display = 'inline-block';
        console.log('btnPlaneacion mostrado');
      }
      if (btnEntrega) {
        btnEntrega.style.display = 'inline-block';
        console.log('btnEntrega mostrado');
      }
      
      // Forzar mostrar una secci√≥n por defecto
      if (esAdmin) {
        showSection('Dashboard');
        console.log('Forzando Dashboard para admin');
      } else {
        showSection('Planeacion');
        console.log('Forzando Planeaci√≥n para usuario');
      }
      
      mostrarAlerta('Debug ejecutado - revisa la consola para detalles', 'info');
    }

    // ========== FUNCIONES PARA PANEL DE TEMAS ==========
    

    // Cambia el tema claro/oscuro y guarda preferencia
    function changeTheme(themeName) {
      if (!themeName) return;
      if (themeName === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      }
      aplicarContrasteTablasDashboard();
    }

    // Bot√≥n de cambio de tema (siempre visible y funcional)
    // Bot√≥n de cambio de tema robusto y funcional siempre
    function ensureThemeButton() {
      let btn = document.getElementById('btnToggleTheme');
      if (btn) btn.remove(); // Elimina si ya existe para evitar duplicados
      btn = document.createElement('button');
      btn.id = 'btnToggleTheme';
      btn.className = 'button button-secondary';
      btn.style.marginBottom = '10px';
      btn.textContent = 'üåô/‚òÄÔ∏è';
      btn.type = 'button';
      btn.onclick = function() {
        const current = document.documentElement.getAttribute('data-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        changeTheme(current === 'dark' ? 'light' : 'dark');
      };
      const navPanel = document.getElementById('sectionNavPanel');
      if (navPanel) navPanel.insertBefore(btn, navPanel.firstChild);
    }
    function initThemeButtonAndTheme() {
      ensureThemeButton();
      // Cargar preferencia guardada o sistema
      const saved = localStorage.getItem('theme');
      if (saved) {
        changeTheme(saved);
      } else {
        // Si no hay preferencia, usar sistema
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        changeTheme(prefersDark ? 'dark' : 'light');
      }
    }
    document.addEventListener('DOMContentLoaded', initThemeButtonAndTheme);
    // Si el panel de navegaci√≥n se vuelve a mostrar din√°micamente, reinsertar el bot√≥n
    const observer = new MutationObserver(() => {
      if (document.getElementById('sectionNavPanel') && !document.getElementById('btnToggleTheme')) {
        ensureThemeButton();
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // Forzar contraste oscuro en tablas dashboard y an√°lisis en tema claro
    function aplicarContrasteTablasDashboard() {
      const isDark = (document.documentElement.getAttribute('data-theme') === 'dark');
      // Tablas dashboard y tablas de an√°lisis
      const tablas = document.querySelectorAll('.dashboard-table, #tablaDatosDashboard, .dashboard-table th, .dashboard-table td, #tablaDatosDashboard th, #tablaDatosDashboard td, #tbody-departamento-cliente td, #tbody-tipo-solicitud td, #tbody-pendientes-asunto td, #tbody-rendimiento-colaborador td, #tbody-estado-proyectos td, #tbody-departamento-cliente th, #tbody-tipo-solicitud th, #tbody-pendientes-asunto th, #tbody-rendimiento-colaborador th, #tbody-estado-proyectos th');
      tablas.forEach(el => {
        if (isDark) {
          el.style.color = '';
        } else {
          el.style.color = '#222';
        }
      });
    }
    // Aplicar contraste al cargar
    document.addEventListener('DOMContentLoaded', aplicarContrasteTablasDashboard);
    // Aplicar contraste al cambiar tema
    window.addEventListener('storage', function(e) { if(e.key==='theme') aplicarContrasteTablasDashboard(); });

    // Cargar tema guardado al iniciar


    // Aplicar tema guardado cuando se carga la p√°gina

    // ========== FUNCIONES DE DIAGN√ìSTICO Y CORRECCI√ìN ==========
    
    // Funci√≥n para diagn√≥stico completo del sistema
    function diagnosticoCompleto() {
      console.log('=== DIAGN√ìSTICO COMPLETO DEL SISTEMA ===');
      
      const resultados = {
        login: {
          usuario: usuarioActual || 'No definido',
          departamento: departamentoActual || 'No definido',
          esAdmin: esAdmin,
          esCoordinador: esCoordinador,
          estado: usuarioActual ? '‚úÖ Logueado' : '‚ùå Sin login'
        },
        datos: {
          registrosTemporales: registrosTemporales.length,
          registrosDashboard: registrosDashboard.length,
          colaboradoresGeomatica: colaboradoresGeomatica.length
        },
        elementos: {
          selectorSemanas: !!document.getElementById('semanas-selector'),
          btnTestBackend: !!document.getElementById('btnTestBackend'),
          btnValidarColumnas: !!document.getElementById('btnValidarColumnas'),
          btnAgregarRegistro: !!document.getElementById('btnAgregarRegistro')
        },
        funciones: {
          cargarDashboardAutomatico: typeof cargarDashboardAutomatico === 'function',
          validarProcesamientoColumnas: typeof validarProcesamientoColumnas === 'function',
          parsearFechaDDMMYYYY: typeof parsearFechaDDMMYYYY === 'function',
          exportarDatos: typeof exportarDatos === 'function',
          inicializarSelectorBasico: typeof inicializarSelectorBasico === 'function'
        }
      };
      
      console.log('Resultados del diagn√≥stico:', resultados);
      
      let mensaje = 'üîç DIAGN√ìSTICO DEL SISTEMA\n\n';
      mensaje += `üë§ Usuario: ${resultados.login.usuario}\n`;
      mensaje += `üè¢ Departamento: ${resultados.login.departamento}\n`;
      mensaje += `üîê Permisos: ${resultados.login.esCoordinador ? 'Coordinador' : resultados.login.esAdmin ? 'Admin' : 'Usuario'}\n\n`;
      mensaje += `üìä Datos cargados:\n`;
      mensaje += `‚Ä¢ Registros temporales: ${resultados.datos.registrosTemporales}\n`;
      mensaje += `‚Ä¢ Registros dashboard: ${resultados.datos.registrosDashboard}\n`;
      mensaje += `‚Ä¢ Colaboradores Geom√°tica: ${resultados.datos.colaboradoresGeomatica}\n\n`;
      mensaje += `üîß Elementos UI: ${Object.values(resultados.elementos).filter(Boolean).length}/${Object.keys(resultados.elementos).length} encontrados\n`;
      mensaje += `‚öôÔ∏è Funciones: ${Object.values(resultados.funciones).filter(Boolean).length}/${Object.keys(resultados.funciones).length} disponibles\n\n`;
      
      const problemas = [];
      if (!usuarioActual) problemas.push('Usuario no logueado');
      if (!departamentoActual) problemas.push('Departamento no definido');
      if (!resultados.elementos.selectorSemanas) problemas.push('Selector de semanas no encontrado');
      if (!resultados.funciones.cargarDashboardAutomatico) problemas.push('Funci√≥n cargarDashboardAutomatico no disponible');
      
      if (problemas.length > 0) {
        mensaje += `‚ö†Ô∏è Problemas detectados:\n${problemas.map(p => `‚Ä¢ ${p}`).join('\n')}`;
      } else {
        mensaje += `‚úÖ Sistema funcionando correctamente`;
      }
      
      mostrarAlerta(mensaje, problemas.length > 0 ? 'warning' : 'success');
      return resultados;
    }

    // Funci√≥n para reparar problemas comunes
    function repararSistema() {
      console.log('=== REPARANDO SISTEMA ===');
      
      let reparaciones = [];
      
      // Reparar selector de semanas si no existe
      if (!document.getElementById('semanas-selector')) {
        console.log('Creando selector de semanas...');
        const container = document.createElement('div');
        container.id = 'semanas-selector';
        container.style.padding = '20px';
        container.innerHTML = '<p>Selector de semanas inicializado</p>';
        
        const dashboardSection = document.getElementById('Dashboard-section');
        if (dashboardSection) {
          dashboardSection.insertBefore(container, dashboardSection.firstChild);
          reparaciones.push('Selector de semanas creado');
        }
      }
      
      // Inicializar selector b√°sico
      if (typeof inicializarSelectorBasico === 'function') {
        inicializarSelectorBasico();
        reparaciones.push('Selector b√°sico inicializado');
      }
      
      // Limpiar datos duplicados
      if (registrosTemporales.length > 100) {
        const uniqueRecords = registrosTemporales.filter((record, index, self) => 
          index === self.findIndex(r => r.id === record.id || (r.fecha === record.fecha && r.colaborador === record.colaborador))
        );
        registrosTemporales = uniqueRecords;
        reparaciones.push(`Registros duplicados limpiados (${registrosTemporales.length} √∫nicos)`);
      }
      
      // Mostrar botones de debug si est√°n ocultos
      const btnTest = document.getElementById('btnTestBackend');
      const btnValidar = document.getElementById('btnValidarColumnas');
      if (btnTest && btnTest.style.display === 'none') {
        btnTest.style.display = 'inline-block';
        reparaciones.push('Bot√≥n Test Backend restaurado');
      }
      if (btnValidar && btnValidar.style.display === 'none') {
        btnValidar.style.display = 'inline-block';
        reparaciones.push('Bot√≥n Validar Q/T restaurado');
      }
      
      console.log('Reparaciones realizadas:', reparaciones);
      
      if (reparaciones.length > 0) {
        mostrarAlerta(`üîß SISTEMA REPARADO\n\nReparaciones realizadas:\n${reparaciones.map(r => `‚Ä¢ ${r}`).join('\n')}`, 'success');
      } else {

      mostrarAlerta('‚úÖ No se detectaron problemas que reparar', 'info');
      }
    }
  </script>
<script>
// Funci√≥n auxiliar para obtener el grupo decimal de un registro de forma segura
function getGrupoDecimalId(registro) {
  if (registro.grupoDecimal) return registro.grupoDecimal;
  if (typeof registro.id === 'string' && registro.id.includes('.')) return registro.id.split('.')[0];
  return '';
}
</script>
<script>
// Funci√≥n global √∫nica para continuar un registro decimal (duplicar con nueva cantidad y nuevo ID)
function continuarRegistroDecimal(index) {
  console.log('Click en continuarRegistroDecimal, index:', index, registrosTemporales[index]);
  const registro = registrosTemporales[index];
  if (!registro || !registro.id) return;
  // Usar la funci√≥n auxiliar para obtener el grupo
  const grupo = getGrupoDecimalId(registro);
  let sumaActual = 0;
  registrosTemporales.forEach(r => {
    let rGrupo = getGrupoDecimalId(r);
    if (rGrupo === grupo) {
      sumaActual += parseFloat(r.cantidad) || 0;
    }
  });
  const restante = 1 - sumaActual;
  if (restante <= 0) {
    mostrarAlerta('No hay cantidad restante para continuar este registro.', 'warning');
    return;
  }
  // Pedir cantidad
  let cantidadStr = prompt(`Cantidad a registrar (m√°ximo ${restante.toFixed(2)}):`, '');
  if (cantidadStr === null) return;
  let cantidad = parseFloat(cantidadStr.replace(',', '.'));
  if (isNaN(cantidad) || cantidad <= 0 || cantidad > restante) {
    mostrarAlerta('Cantidad inv√°lida.', 'warning');
    return;
  }

  // Pedir fecha (por defecto hoy en formato yyyy-mm-dd)
  let hoy = new Date();
  let yyyy = hoy.getFullYear();
  let mm = String(hoy.getMonth() + 1).padStart(2, '0');
  let dd = String(hoy.getDate()).padStart(2, '0');
  let fechaDefault = `${yyyy}-${mm}-${dd}`;
  let fechaStr = prompt('Fecha para el nuevo registro (formato yyyy-mm-dd):', fechaDefault);
  if (fechaStr === null) return;
  // Validar fecha
  let fechaValida = /^\d{4}-\d{2}-\d{2}$/.test(fechaStr);
  if (!fechaValida) {
    mostrarAlerta('Fecha inv√°lida. Usa formato yyyy-mm-dd.', 'warning');
    return;
  }

  // Pedir observaciones (por defecto las del registro base)
  let obsDefault = registro.observaciones || '';
  let observaciones = prompt('Observaciones para el nuevo registro:', obsDefault);
  if (observaciones === null) return;

  // Calcular semana seg√∫n la fecha elegida
  function getWeekNumberFromDate(dateStr) {
    // dateStr en formato yyyy-mm-dd
    let d = new Date(dateStr);
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 4 - (d.getDay()||7));
    let yearStart = new Date(d.getFullYear(),0,1);
    let weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    return weekNo;
  }
  let semana = getWeekNumberFromDate(fechaStr);

  // Calcular el siguiente ID decimal seg√∫n reglas
  const baseId = parseInt(getGrupoDecimalId(registro));
  // Buscar todos los registros del grupo
  const grupoRegistros = registrosTemporales.filter(r => parseInt(getGrupoDecimalId(r)) === baseId);
  // Obtener subfijos usados y sumarlos
  let subfijos = [];
  let subfijoRepetidos = {};
  grupoRegistros.forEach(r => {
    if (typeof r.id === 'string' && r.id.includes('.')) {
      let partes = r.id.split('.');
      if (partes.length >= 2) {
        let suf = partes.slice(1).join('.');
        let sufNum = parseFloat('0.' + suf.split('.')[1]);
        if (!isNaN(sufNum)) {
          subfijos.push(sufNum);
          // Contar repeticiones
          if (!subfijoRepetidos[suf]) subfijoRepetidos[suf] = 1;
          else subfijoRepetidos[suf]++;
        }
      }
    }
  });
  let sumaSubfijos = subfijos.reduce((a,b) => a+b, 0);
  let nuevoBaseId = baseId;
  let nuevoSubfijo = cantidad;
  let sufStr = nuevoSubfijo.toFixed(2).replace('0.', '');
  let nuevoId = '';
  if (sumaSubfijos + cantidad > 1) {
    // Avanzar grupo
    nuevoBaseId = baseId + 1;
    nuevoId = `${nuevoBaseId}.0.${sufStr}`;
  } else {
    // Revisar si el subfijo ya existe
    let rep = subfijoRepetidos[sufStr] || 0;
    if (rep > 0) {
      nuevoId = `${baseId}.0.${sufStr}.${rep+1}`;
    } else {
      nuevoId = `${baseId}.0.${sufStr}`;
    }
  }
  // Crear nuevo registro decimal con el ID calculado solo para mostrar en la tabla
  const nuevo = { ...registro };
  nuevo.idTemporal = nuevoId; // Solo para mostrar en la tabla
  nuevo.id = '';
  nuevo.cantidad = cantidad;
  nuevo.fecha = fechaStr;
  nuevo.semana = semana;
  nuevo.observaciones = observaciones;
  nuevo.costoTotal = (cantidad * parseFloat(nuevo.costoxnivel || 1) * (typeof manejarRegistros.getMultiplicador === 'function' ? manejarRegistros.getMultiplicador(nuevo.tipo_solicitud) : 1)).toFixed(2);
  nuevo.editado = true;
  nuevo.pendienteGuardar = true;
  nuevo.idBaseDecimal = baseId;
  registrosTemporales.push(nuevo);
  manejarRegistros.actualizarTabla();
  manejarRegistros.actualizarBotonesGuardado();
  mostrarAlerta(`Registro decimal preparado. El ID sugerido es ${nuevoId}. Se asignar√° al guardar.`, 'info');
}
</script>

  </div> <!-- main-content -->

  <!-- Botones de descarga global -->
  <div style="margin: 30px 0; text-align: center;">
  </div>
<script>

// Descargar CSV completo (directo, sin Drive)
function descargarCSVCompleto() {
  mostrarAlerta('Preparando archivo CSV, por favor espera...', 'info');
  google.script.run.withSuccessHandler(function(csv) {
    if (csv && csv.length > 0) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ExportacionCompleta.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 1000);
      mostrarAlerta('Descarga lista. Si no inicia autom√°ticamente, haz clic en el enlace.', 'success');
    } else {
      mostrarAlerta('No se pudo generar el archivo CSV.', 'error');
    }
  }).withFailureHandler(function(e){
    mostrarAlerta('Error al generar el CSV: ' + e.message, 'error');
  }).exportarTodoACSV();
}

    // Funci√≥n mejorada para alternar visibilidad de filtros
    function toggleConfiguracion() {
      const container = document.getElementById('configuracion-info');
      const button = document.getElementById('btnToggleConfig');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        button.textContent = 'Ocultar Configuraci√≥n';
      } else {
        container.style.display = 'none';
        button.textContent = 'Mostrar Configuraci√≥n';
      }
    }
    
    function toggleFiltros() {
      const container = document.getElementById('filtros-container');
      const btn = document.getElementById('btnToggleFiltros');
      
      if (!container || !btn) {
        console.warn('Elementos de filtros no encontrados');
        return;
      }
      
      // Siempre mostrar los filtros para coordinadores y admin
      if (esAdmin || esCoordinador) {
        container.style.display = 'grid';
        btn.textContent = 'Ocultar Filtros';
        btn.disabled = true;
        btn.style.opacity = 0.6;
      } else {
        // Para usuarios normales, alternar
        if (container.style.display === 'none') {
          container.style.display = 'grid';
        btn.textContent = 'Ocultar Filtros';
        } else {
          container.style.display = 'none';
        btn.textContent = 'Mostrar Filtros';
        }
      }
    }

    // Funci√≥n para mostrar/ocultar informaci√≥n de acceso
    function toggleInfoAcceso() {
      const container = document.getElementById('permisos-info');
      const btn = document.getElementById('btnToggleInfoAcceso');
      
      if (!container || !btn) {
        console.warn('Elementos de informaci√≥n de acceso no encontrados');
        return;
      }
      
      if (container.style.display === 'none') {
        // Solo cargar informaci√≥n si el contenedor est√° vac√≠o (primera vez)
        if (container.innerHTML.trim() === '' || container.innerHTML.includes('Se llenar√° din√°micamente')) {
          mostrarInfoPermisos();
        }
        container.style.display = 'grid';
        btn.textContent = 'Ocultar Informaci√≥n';
        btn.style.background = '#e74c3c';
      } else {
        container.style.display = 'none';
        btn.textContent = 'Mostrar Informaci√≥n';
        btn.style.background = '#6c757d';
      }
    }

    // Funci√≥n para mostrar/ocultar contrase√±a
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      if (!input) {
        console.warn(`Input ${inputId} no encontrado`);
        return;
      }
      
      const button = input.nextElementSibling;
      if (!button) {
        console.warn(`Bot√≥n para ${inputId} no encontrado`);
        return;
      }
      
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'Ocultar';
        button.title = 'Ocultar contrase√±a';
      } else {
        input.type = 'password';
        button.textContent = 'Mostrar';
        button.title = 'Mostrar contrase√±a';
      }
    }

    // Funci√≥n para formatear n√∫meros con comas y puntos (formato ingl√©s)
    function formatCurrency(value) {
      if (!value || isNaN(value)) return '$0';
      const num = parseFloat(String(value).replace(/[$,]/g, ''));
      if (isNaN(num)) return '$0';
      
      // Si es un n√∫mero entero, no mostrar decimales
      if (num % 1 === 0) {
        return '$' + num.toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      } else {
        return '$' + num.toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
    }

    // Funci√≥n para formatear n√∫mero sin s√≠mbolo de moneda
    function formatNumber(value) {
      if (!value || isNaN(value)) return '0';
      const num = parseFloat(String(value).replace(/[,]/g, ''));
      if (isNaN(num)) return '0';
      
      // Si es un n√∫mero entero, no mostrar decimales
      if (num % 1 === 0) {
        return num.toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      } else {
        return num.toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
    }

    // Funci√≥n para formatear cantidad (sin s√≠mbolo de moneda)
    function formatearCantidad(value) {
      if (!value || isNaN(value)) return '0';
      const num = parseFloat(String(value).replace(/[,]/g, ''));
      if (isNaN(num)) return '0';
      
      // Si es un n√∫mero entero, no mostrar decimales
      if (num % 1 === 0) {
        return num.toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      } else {
        return num.toLocaleString('en-US', {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        });
      }
    }

    // Funci√≥n para ocultar/mostrar informaci√≥n de usuario
    function toggleUserInfo() {
      const userInfo = document.getElementById('user-info');
      const userContent = userInfo.querySelector('div');
      const spans = userContent.querySelectorAll('span');
      
      if (spans[0].style.display === 'none') {
        // Mostrar informaci√≥n
        spans.forEach(span => span.style.display = 'inline');
        userContent.querySelector('button').textContent = 'Mostrar';
        userContent.querySelector('button').title = 'Ocultar informaci√≥n de usuario';
      } else {
        // Ocultar informaci√≥n
        spans.forEach(span => span.style.display = 'none');
        userContent.querySelector('button').textContent = 'Usuario';
        userContent.querySelector('button').title = 'Mostrar informaci√≥n de usuario';
      }
    }

    // ========== NUEVAS FUNCIONALIDADES ========== //

    // 2. Toggle para mostrar ID o limpiar tabla temporal tras guardar
    let mostrarIdTrasGuardar = true;
    function crearToggleMostrarId() {
      const contenedor = document.getElementById('toggle-mostrar-id-container');
      if (!contenedor) return;
      contenedor.innerHTML = 
        '<label style="display:flex;align-items:center;gap:6px;font-size:0.95em;">' +
          '<input type="checkbox" id="toggleMostrarId" ' + (mostrarIdTrasGuardar ? 'checked' : '') + '>' +
          'Mostrar ID asignado tras guardar (desmarcar para limpiar tabla autom√°ticamente)' +
        '</label>';
      document.getElementById('toggleMostrarId').addEventListener('change', function() {
        mostrarIdTrasGuardar = this.checked;
        localStorage.setItem('mostrarIdTrasGuardar', mostrarIdTrasGuardar ? '1' : '0');
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      if (localStorage.getItem('mostrarIdTrasGuardar')) {
        mostrarIdTrasGuardar = localStorage.getItem('mostrarIdTrasGuardar') === '1';
      }
      crearToggleMostrarId();
    });

    // 3. Duplicar registro (solo observaciones y cantidad)
    function duplicarRegistro(index) {
      const reg = registrosTemporales[index];
      if (!reg) return;
      const nuevo = { ...reg };
      nuevo.id = '';
      nuevo.cantidad = '';
      nuevo.observaciones = '';
      nuevo.editado = false;
      registrosTemporales.push(nuevo);
      manejarRegistros.actualizarTabla();
      mostrarAlerta('Registro duplicado. Modifica cantidad y observaciones.', 'info');
    }

    // 1. Formato simple para cantidades y costos en tablas/dashboard
    function aplicarFormatoNumerosTablas() {
      try {
        // NO aplicar formato ingl√©s - mantener formato simple
        // Solo formatear celdas de costo si es necesario, pero mantener formato b√°sico
        const costoCells = document.querySelectorAll('.costo-cell');
        costoCells.forEach(cell => {
          if (!cell) return;
          const value = cell.textContent.trim();
          // Si no tiene el s√≠mbolo $ al inicio, agregarlo
          if (value && !value.startsWith('$') && !isNaN(value.replace(/[$,]/g, ''))) {
            const numValue = parseFloat(value.replace(/[$,]/g, ''));
            if (!isNaN(numValue)) {
              cell.textContent = '$' + numValue.toFixed(2);
            }
          }
        });
        
        // Para cantidades, mantener formato simple sin decimales ni separadores
        const cantidadCells = document.querySelectorAll('.cantidad-cell');
        cantidadCells.forEach(cell => {
          if (!cell) return;
          const value = cell.textContent.trim();
          if (value && !isNaN(value)) {
            const numValue = parseInt(value);
            if (!isNaN(numValue)) {
              cell.textContent = numValue.toString(); // Formato simple sin decimales
            }
          }
        });
      } catch (e) {
        console.error('Error en aplicarFormatoNumerosTablas:', e);
      }
    }
    document.addEventListener('DOMContentLoaded', aplicarFormatoNumerosTablas);

    // 4. Selector de departamento siempre visible pero deshabilitado
    function configurarSelectorDepartamento() {
      const depto = document.getElementById('departamento');
      if (!depto) return;
      depto.disabled = true;
      const btn = document.getElementById('btnHabilitarDepto');
      if (btn) {
        btn.addEventListener('click', function() {
          depto.disabled = !depto.disabled;
          btn.textContent = depto.disabled ? 'üîí Habilitar Departamento' : 'üîì Bloquear Departamento';
        });
      }
    }
    document.addEventListener('DOMContentLoaded', configurarSelectorDepartamento);

    // 5. Historial siempre visible (asumimos que hay un contenedor con id 'historial-registros')
    function mostrarHistorialSiempre() {
      const hist = document.getElementById('historial-registros');
      if (hist) hist.style.display = 'block';
    }
    document.addEventListener('DOMContentLoaded', mostrarHistorialSiempre);

    // ========== FIN NUEVAS FUNCIONALIDADES ========== //

    // Funci√≥n global para editar cantidad decimal desde el panel
    function editarCantidadDecimal(registroId, index) {
      const registro = registrosTemporales.find(r => r.id === registroId);
      if (!registro) return;
      
      const grupoInfo = manejarRegistros.verificarSumaGrupoDecimal(registro.grupoDecimal);
      const otrosSuma = grupoInfo.suma - parseFloat(registro.cantidad);
      const maximoPermitido = 1 - otrosSuma;
      
      const nuevaCantidad = prompt(
        `Editar cantidad para registro ${registroId}\n` +
        `Cantidad actual: ${registro.cantidad}\n` +
        `Suma de otros registros: ${otrosSuma.toFixed(2)}\n` +
        `M√°ximo permitido: ${maximoPermitido.toFixed(2)}\n\n` +
        `Ingrese la nueva cantidad:`,
        registro.cantidad
      );
      
      if (nuevaCantidad === null) return;
      
      const cantidad = parseFloat(nuevaCantidad);
      if (isNaN(cantidad) || cantidad <= 0) {
        mostrarAlerta('Cantidad debe ser un n√∫mero positivo', 'warning');
        return;
      }
      
      if (cantidad > maximoPermitido) {
        mostrarAlerta(`La cantidad no puede exceder ${maximoPermitido.toFixed(2)}`, 'warning');
        return;
      }
      
      // Actualizar el registro
      registro.cantidad = cantidad;
      registro.costoTotal = (cantidad * parseFloat(registro.costoxnivel) * manejarRegistros.getMultiplicador(registro.tipo_solicitud)).toFixed(2);
      registro.editado = true;
      
      // Actualizar tabla y cerrar modal
      manejarRegistros.actualizarTabla();
      manejarRegistros.actualizarBotonesGuardado();
      document.getElementById('modal-custom').remove();
      
      // Mostrar nueva informaci√≥n del grupo
      setTimeout(() => {
        manejarRegistros.mostrarPanelGrupoDecimal(registro.grupoDecimal);
      }, 100);
      
      mostrarAlerta('Cantidad actualizada correctamente', 'success');
    }

    // Funci√≥n para mostrar ayuda sobre registros decimales
    function mostrarAyudaDecimales() {
      const ayuda = `
        <div class="ayuda-decimales">
          <h3>üìã Gesti√≥n de Registros Decimales</h3>
          
          <div class="seccion-ayuda">
            <h4>¬øQu√© son los registros decimales?</h4>
            <p>Los registros decimales son aquellos donde la cantidad es menor a 1.0 (por ejemplo: 0.3, 0.5, 0.8).</p>
          </div>
          
          <div class="seccion-ayuda">
            <h4>¬øC√≥mo funcionan?</h4>
            <ul>
              <li>Cada registro decimal recibe un ID especial que termina en ".1" al crearse</li>
              <li>Puedes duplicar estos registros con el bot√≥n "üìã Duplicar"</li>
              <li>Los duplicados tendr√°n IDs incrementales (.2, .3, .4, etc.)</li>
              <li>La suma de todas las cantidades del grupo no puede exceder 1.0</li>
              <li><strong>¬°NUEVO!</strong> Cuando la suma llega a 1.0, puedes crear continuaciones con nuevo ID base</li>
            </ul>
          </div>
          
          <div class="seccion-ayuda">
            <h4>Funciones disponibles:</h4>
            <ul>
              <li><strong>üìã Duplicar:</strong> Crea una copia del registro con el siguiente ID secuencial (cuando suma < 1.0)</li>
              <li><strong>ÔøΩ Continuar:</strong> Crea una continuaci√≥n con nuevo ID base (cuando suma = 1.0)</li>
              <li><strong>ÔøΩüìä Panel:</strong> Abre el panel de gesti√≥n del grupo para ver detalles y editar</li>
              <li><strong>Indicador:</strong> Muestra la suma actual/1.0 con colores (verde=completo, amarillo=incompleto)</li>
            </ul>
          </div>
          
          <div class="seccion-ayuda">
            <h4>Ejemplo de uso:</h4>
            <ol>
              <li>Crear registro con cantidad 0.3 ‚Üí ID: timestamp.1</li>
              <li>Duplicar ‚Üí Nuevo registro con ID: timestamp.2</li>
              <li>Duplicar nuevamente ‚Üí ID: timestamp.3</li>
              <li>Cuando la suma llega a 1.0, se marca como completo ‚úÖ</li>
              <li><strong>¬°NUEVO!</strong> Bot√≥n cambia a "üìã Continuar" para crear nuevo grupo</li>
              <li>Continuar ‚Üí Nuevo registro con ID base diferente: nuevoTimestamp.1</li>
            </ol>
          </div>
        </div>
      `;
      
      manejarRegistros.mostrarModalCustom('Ayuda - Registros Decimales', ayuda);
    }
    
    // Funci√≥n para probar la funci√≥n de semana con ejemplo del lunes 7 de julio
    function probarFuncionSemana() {
      console.log('=== PRUEBA DE FUNCI√ìN SEMANA - REGLA DEL LUNES ===');
      
      // Crear registros de prueba espec√≠ficos para el caso mencionado
      const registrosPrueba = [
        {
          id: 'test-1',
          semana: '28', // Semana original del 7 de julio
          fechaEntrega: '07/07/2025', // Lunes 7 de julio (ejemplo del usuario)
          fecha: '01/07/2025',
          estatus: 'Entregado',
          asunto: 'Ejemplo Usuario - Entrega Lunes 7 Julio'
        },
        {
          id: 'test-2',
          semana: '28',
          fechaEntrega: '08/07/2025', // Martes 8 de julio
          fecha: '01/07/2025',
          estatus: 'Entregado',
          asunto: 'Ejemplo Control - Entrega Martes 8 Julio'
        },
        {
          id: 'test-3',
          semana: '25',
          fechaEntrega: '14/07/2025', // Lunes 14 de julio
          fecha: '01/07/2025',
          estatus: 'Entregado',
          asunto: 'Ejemplo Lunes 14 Julio'
        },
        {
          id: 'test-4',
          semana: '30',
          fechaEntrega: '', // Sin fecha de entrega
          fecha: '01/07/2025',
          estatus: 'Pendiente',
          asunto: 'Ejemplo Pendiente sin entrega'
        }
      ];
      
      let resultados = [];
      
      registrosPrueba.forEach((registro, index) => {
        console.log(`\n=== PRUEBA ${index + 1} ===`);
        console.log('Registro:', registro);
        
        const semanaCalculada = obtenerSemanaDeRegistro(registro);
        console.log(`Resultado: Semana ${semanaCalculada}`);
        
        // Calcular qu√© semana DEBER√çA ser seg√∫n la fecha normal
        let semanaNormal = null;
        if (registro.fechaEntrega) {
          const fecha = parsearFechaDDMMYYYY(registro.fechaEntrega);
          if (fecha) {
            semanaNormal = getWeekNumber(fecha);
          }
        }
        
        resultados.push({
          prueba: index + 1,
          asunto: registro.asunto,
          fechaEntrega: registro.fechaEntrega || 'Sin fecha',
          semanaOriginal: registro.semana,
          semanaNormal: semanaNormal,
          semanaCalculada: semanaCalculada,
          esLunes: registro.fechaEntrega ? parsearFechaDDMMYYYY(registro.fechaEntrega)?.getDay() === 1 : false,
          reglaAplicada: registro.fechaEntrega && parsearFechaDDMMYYYY(registro.fechaEntrega)?.getDay() === 1 ? 
            'REGLA LUNES: Semana anterior' : 'Normal'
        });
      });
      
      // Mostrar resultados en modal
      const resumen = `
        <div class="debug-semanas">
          <h3>üî• NUEVA REGLA DEL LUNES - Resultados de Prueba</h3>
          <div style="background: rgba(231, 76, 60, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #e74c3c;">
            <p style="margin: 0; font-weight: bold; color: #e74c3c;">üìÖ REGLA ESPECIAL:</p>
            <p style="margin: 5px 0 0 0; font-size: 0.9em;">Si un registro se entrega un LUNES, se marca como entregado en la semana ANTERIOR a ese lunes.</p>
            <p style="margin: 5px 0 0 0; font-size: 0.85em; font-style: italic;">Ejemplo: Lunes 7 de julio (semana 28) ‚Üí se marca en semana 27</p>
          </div>
          
          <table class="debug-table" style="width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em;">
            <thead>
              <tr style="background: rgba(52, 152, 219, 0.2);">
                <th style="padding: 8px; border: 1px solid #ddd;">Prueba</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Fecha Entrega</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Es Lunes?</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Semana Normal</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Semana Final</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Regla Aplicada</th>
              </tr>
            </thead>
            <tbody>
              ${resultados.map(r => `
                <tr style="background: ${r.esLunes ? 'rgba(231, 76, 60, 0.1)' : 'rgba(255,255,255,0.05)'};">
                  <td style="padding: 8px; border: 1px solid #ddd;">${r.prueba}</td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${r.fechaEntrega}</td>
                  <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: ${r.esLunes ? '#e74c3c' : '#27ae60'};">
                    ${r.esLunes ? 'üî• S√ç' : '‚úÖ No'}
                  </td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${r.semanaNormal || 'N/A'}</td>
                  <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">
                    Semana ${r.semanaCalculada}
                  </td>
                  <td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85em; ${r.esLunes ? 'font-weight: bold; color: #e74c3c;' : ''}">${r.reglaAplicada}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div style="margin-top: 15px; padding: 12px; background: rgba(39, 174, 96, 0.1); border-radius: 6px; border-left: 4px solid #27ae60;">
            <p style="margin: 0; font-size: 0.9em;"><strong>‚úÖ Ejemplo del usuario resuelto:</strong></p>
            <p style="margin: 5px 0 0 0; font-size: 0.85em;">
              Lunes 7 de julio normalmente ser√≠a semana 28, pero con la nueva regla se marca como semana 27 (semana anterior).
            </p>
          </div>
        </div>
      `;
      
      manejarRegistros.mostrarModalCustom('üî• Nueva Regla del Lunes - Debug', resumen);
      mostrarAlerta('‚úÖ Prueba completada. La regla del lunes est√° funcionando correctamente.', 'success');
    }
  </script>
  
  <script>
    // üîß CORRECCI√ìN DE SINTAXIS AUTOM√ÅTICA
    // Esta funci√≥n corrige problemas comunes de sintaxis JavaScript
    
    try {
      // Verificar que todas las variables globales est√©n bien definidas
      if (typeof registrosTemporales === 'undefined') window.registrosTemporales = [];
      if (typeof registrosDashboard === 'undefined') window.registrosDashboard = [];
      if (typeof usuarioActual === 'undefined') window.usuarioActual = '';
      if (typeof departamentoActual === 'undefined') window.departamentoActual = '';
      if (typeof esAdmin === 'undefined') window.esAdmin = false;
      if (typeof esCoordinador === 'undefined') window.esCoordinador = false;
      
      console.log('‚úÖ Variables globales verificadas');
    } catch (e) {
      console.error('‚ùå Error en verificaci√≥n de variables:', e);
    }

    // üîç FUNCI√ìN DE DEBUG ESPEC√çFICA PARA ERRORES DE SINTAXIS
    function validarSintaxisJavaScript() {
      console.log('üîç Validando sintaxis JavaScript...');
      
      // Lista de objetos que pueden tener problemas de sintaxis
      const objetosParaValidar = [
        'permisosUsuario',
        'registrosTemporales', 
        'registrosDashboard'
      ];
      
      objetosParaValidar.forEach(nombreObj => {
        try {
          const obj = window[nombreObj];
          if (obj !== undefined) {
            console.log(`‚úÖ ${nombreObj}: OK`);
          } else {
            console.warn(`‚ö†Ô∏è ${nombreObj}: No definido`);
          }
        } catch (e) {
          console.error(`‚ùå ${nombreObj}: Error -`, e.message);
        }
      });
      
      // Verificar que no hay problemas de sintaxis comunes
      try {
        // Test de objetos b√°sicos
        const testObj = { test: true, otro: false };
        const testArray = [1, 2, 3];
        console.log('‚úÖ Sintaxis b√°sica: OK');
        
        return true;
      } catch (e) {
        console.error('‚ùå Error de sintaxis detectado:', e);
        return false;
      }
    }
    
  </script>

  </body>
<script>
// Mostrar el n√∫mero de semana al elegir una fecha en planeaci√≥n
function mostrarSemanaSeleccionada() {
  const inputFecha = document.getElementById('fecha');
  const divSemana = document.getElementById('semana-seleccionada');
  if (!inputFecha || !divSemana) return;
  const valor = inputFecha.value;
  if (!valor) {
    divSemana.style.display = 'none';
    divSemana.textContent = '';
    return;
  }
  // Calcular semana ISO 8601
  const fecha = new Date(valor);
  if (isNaN(fecha.getTime())) {
    divSemana.style.display = 'none';
    divSemana.textContent = '';
    return;
  }
  // Algoritmo ISO 8601
  const d = new Date(fecha.getTime());
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 4 - (d.getDay()||7));
  const yearStart = new Date(d.getFullYear(),0,1);
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  divSemana.textContent = `Semana correspondiente: ${weekNo}`;
  divSemana.style.display = 'block';
}
// Si ya hay valor al cargar, mostrar semana
window.addEventListener('DOMContentLoaded',()=>{
  if(document.getElementById('fecha')) mostrarSemanaSeleccionada();
});
</script>
</html>
